<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}UK Mobile Repairing Center{% endblock %}</title>
    
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('favicon') }}">
    <link rel="shortcut icon" href="{{ url_for('favicon') }}">
    <meta name="theme-color" content="#4361ee">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar - Desktop -->
    <div class="sidebar d-none d-md-block">
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="logo-img" 
                     onerror="this.src='https://via.placeholder.com/50/4361ee/ffffff?text=UK'; this.onerror=null;">
                <div class="shop-name">U K Mobile<br>Repairing Center</div>
            </div>
        </div>
        
        <div class="sidebar-content">
            <nav class="nav flex-column">
                {% if current_user.is_authenticated %}
                    <!-- POS - Show for Admin, Manager, Sales Staff -->
                    {% if current_user.role in ['admin', 'manager', 'staff'] %}
                    <a class="nav-link {% if request.endpoint and 'pos' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('pos.dashboard') }}">
                        <i class="fas fa-shopping-cart"></i>
                        <span>POS</span>
                    </a>
                    {% endif %}
                    
                    <!-- Inventory - Show for Admin, Manager, Sales Staff -->
                    {% if current_user.role in ['admin', 'manager', 'staff'] %}
                    <a class="nav-link {% if request.endpoint and 'inventory' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('inventory.inventory_dashboard') }}">
                        <i class="fas fa-boxes"></i>
                        <span>Inventory</span>
                    </a>
                    {% endif %}
                    
                    <!-- Repair - Show for Admin, Manager, Technician -->
                    {% if current_user.role in ['admin', 'manager', 'technician'] %}
                    <a class="nav-link {% if request.endpoint and 'repair' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('repair.repair_dashboard') }}">
                        <i class="fas fa-tools"></i>
                        <span>Repair</span>
                    </a>
                    {% endif %}
                    
                    <!-- Employees Dashboard - Show for Admin, Manager -->
                    {% if current_user.role in ['admin'] %}
                    <a class="nav-link {% if request.endpoint and 'employee' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('employee.employee_dashboard') }}">
                        <i class="fas fa-users"></i>
                        <span>Employees</span>
                    </a>
                    {% endif %}
                {% endif %}
            </nav>
        </div>
        
        <div class="sidebar-footer">
            {% if current_user.is_authenticated %}
            <div class="user-info">
                <small class="text-white d-block mb-1">Logged in as</small>
                <h6 class="mb-1">
                    {{ current_user.username }}
                    <span class="badge role-{{ current_user.role }} role-badge ms-2">
                        {{ current_user.role|title }}
                    </span>
                </h6>
                <small class="text-white d-block">{{ current_user.email }}</small>
                <div class="mt-3 pt-3 border-top border-white border-opacity-25">                                        
                    <a class="nav-link py-2 px-0 logout-link" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Mobile Header -->
    <div class="mobile-header d-md-none">
        <div class="mobile-header-content">
            <div class="mobile-logo-container">
                <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="mobile-logo-img"
                     onerror="this.src='https://via.placeholder.com/40/4361ee/ffffff?text=UK'; this.onerror=null;">
                <div class="mobile-shop-name">U K Mobile Repairing Center</div>
            </div>
            <button class="hamburger-menu" id="mobileMenuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
    
    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
    
    <!-- Mobile Navigation Sidebar -->
    <div class="mobile-nav-container" id="mobileNavContainer">
        <div class="mobile-nav-header">
            <button class="mobile-nav-close" id="mobileNavClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="mobile-header-logo">
                <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="mobile-header-logo-img"
                     onerror="this.src='https://via.placeholder.com/50/4361ee/ffffff?text=UK'; this.onerror=null;">
                <div class="mobile-header-shop-name">U K Mobile<br>Repairing Center</div>
            </div>
            
            <div class="mobile-user-info">
                {% if current_user.is_authenticated %}
                <div class="mobile-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h5 class="mb-1">{{ current_user.username }}</h5>
                <p class="mb-0 opacity-75">{{ current_user.email }}</p>
                <span class="badge role-{{ current_user.role }} role-badge mt-2">
                    {{ current_user.role|title }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="mobile-nav-content">
            {% if current_user.is_authenticated %}
                <!-- POS - Show for Admin, Manager, Sales Staff -->
                {% if current_user.role in ['admin', 'manager', 'staff'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'pos' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('pos.dashboard') }}">
                    <i class="fas fa-shopping-cart"></i>
                    <span>POS Dashboard</span>
                </a>
                {% endif %}
                
                <!-- Inventory - Show for Admin, Manager, Sales Staff -->
                {% if current_user.role in ['admin', 'manager', 'staff'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'inventory' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('inventory.inventory_dashboard') }}">
                    <i class="fas fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                {% endif %}
                
                <!-- Repair - Show for Admin, Manager, Technician -->
                {% if current_user.role in ['admin', 'manager', 'technician'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'repair' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('repair.repair_dashboard') }}">
                    <i class="fas fa-tools"></i>
                    <span>Repair Center</span>
                </a>
                {% endif %}
                
                <!-- Employees Dashboard - Show for Admin, Manager -->
                {% if current_user.role in ['admin'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'employee' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('employee.employee_dashboard') }}">
                    <i class="fas fa-users"></i>
                    <span>Employees</span>
                </a>
                {% endif %}
                
                <div class="mobile-nav-divider"></div>
            {% endif %}
        </div>
        
        <div class="mobile-nav-footer">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger w-100 logout-link" style="border-radius: 10px;">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100" style="border-radius: 10px;">
                <i class="fas fa-sign-in-alt me-2"></i>Login
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
                            <i class="fas 
                                {% if category == 'success' %}fa-check-circle 
                                {% elif category == 'danger' %}fa-exclamation-circle 
                                {% elif category == 'warning' %}fa-exclamation-triangle 
                                {% else %}fa-info-circle{% endif %} 
                                me-3"></i>
                            <div>{{ message }}</div>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Page Content -->
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Confirmation Modal for Logout -->
    <div class="modal fade confirmation-modal" id="logoutConfirmationModal" tabindex="-1" aria-labelledby="logoutConfirmationLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-custom">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="modal-title" id="logoutConfirmationLabel">Confirm Logout</h5>
                    <p>Are you sure you want to logout from your account?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn confirmation-btn confirmation-btn-cancel" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn confirmation-btn confirmation-btn-confirm" id="confirmLogoutBtn">
                        <i class="fas fa-check me-1"></i>
                        Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
    // Mobile Navigation Toggle
    $(document).ready(function() {
        const menuToggle = $('#mobileMenuToggle');
        const navOverlay = $('#mobileNavOverlay');
        const navContainer = $('#mobileNavContainer');
        const navClose = $('#mobileNavClose');
        
        // Open mobile menu
        menuToggle.on('click', function(e) {
            e.stopPropagation();
            $(this).toggleClass('active');
            navOverlay.toggleClass('show');
            navContainer.toggleClass('show');
            $('body').css('overflow', 'hidden');
        });
        
        // Close mobile menu
        function closeMenu() {
            menuToggle.removeClass('active');
            navOverlay.removeClass('show');
            navContainer.removeClass('show');
            $('body').css('overflow', 'auto');
        }
        
        // Close on overlay click
        navOverlay.on('click', closeMenu);
        
        // Close on X button click
        navClose.on('click', closeMenu);
        
        // Close on navigation item click
        $('.mobile-nav-item').on('click', function() {
            setTimeout(closeMenu, 300);
        });
        
        // Close on escape key
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMenu();
            }
        });
        
        // Prevent menu close when clicking inside
        navContainer.on('click', function(e) {
            e.stopPropagation();
        });
        
        // CSRF Token Setup
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}");
                }
            }
        });
        
        // Logout Confirmation Dialog
        let logoutUrl = '';
        
        // Handle logout link clicks
        $(document).on('click', '.logout-link', function(e) {
            e.preventDefault();
            logoutUrl = $(this).attr('href');
            
            // Show the confirmation modal
            const logoutModal = new bootstrap.Modal(document.getElementById('logoutConfirmationModal'));
            logoutModal.show();
            
            // Focus on cancel button for accessibility
            setTimeout(function() {
                $('.confirmation-btn-cancel').focus();
            }, 500);
        });
        
        // Confirm logout button
        $('#confirmLogoutBtn').on('click', function() {
            // Hide the modal
            const logoutModal = bootstrap.Modal.getInstance(document.getElementById('logoutConfirmationModal'));
            logoutModal.hide();
            
            // Redirect to logout URL
            if (logoutUrl) {
                window.location.href = logoutUrl;
            }
        });
        
        // Keyboard navigation for modal
        $('#logoutConfirmationModal').on('keydown', function(e) {
            if (e.key === 'Escape') {
                const logoutModal = bootstrap.Modal.getInstance(this);
                if (logoutModal) {
                    logoutModal.hide();
                }
            }
            
            // Tab key trapping for accessibility
            if (e.key === 'Tab') {
                const focusableElements = $('.confirmation-modal button:not([disabled])');
                const firstElement = focusableElements.first();
                const lastElement = focusableElements.last();
                
                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstElement[0]) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else { // Tab
                    if (document.activeElement === lastElement[0]) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }
        });
        
        // Fix height on resize
        function fixHeights() {
            const windowHeight = $(window).height();
            const mobileHeaderHeight = $('.mobile-header').outerHeight() || 0;
            
            // Set main content min-height on mobile
            if ($(window).width() < 768) {
                $('.main-content').css('min-height', windowHeight - mobileHeaderHeight + 'px');
            } else {
                $('.main-content').css('min-height', '100vh');
            }
            
            // Set mobile nav container height
            $('.mobile-nav-container').css('height', windowHeight + 'px');
        }
        
        // Initial height fix
        fixHeights();
        
        // Fix heights on resize
        $(window).on('resize', fixHeights);
        
        // Fix heights on orientation change
        $(window).on('orientationchange', function() {
            setTimeout(fixHeights, 100);
        });
        
        // Add enter key support for modal buttons
        $('#logoutConfirmationModal').on('keypress', function(e) {
            if (e.key === 'Enter' && $(e.target).hasClass('confirmation-btn')) {
                $(e.target).click();
            }
        });
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>