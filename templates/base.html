<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}UK Mobile Repairing Center{% endblock %}</title>
    
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('favicon') }}">
    <link rel="shortcut icon" href="{{ url_for('favicon') }}">
    <meta name="theme-color" content="#4361ee">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Hover Trigger Zone - Desktop -->
    <div class="sidebar-hover-trigger"></div>
    
    <!-- Desktop Header -->
    <div class="desktop-header d-none d-md-block">
        <div class="desktop-header-content">
            <!-- Left side with nav toggle button -->
            <div class="desktop-header-left">
                <button class="nav-toggle-btn" id="desktopNavToggle">
                    <i class="fas fa-bars"></i>
                    <span class="toggle-text">Menu</span>
                </button>
            </div>

            <div class="desktop-header-center">
                <div class="desktop-header-logo">
                    <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="desktop-logo-img"
                         onerror="this.src='https://via.placeholder.com/35/4361ee/ffffff?text=UK'; this.onerror=null;">
                    <div class="desktop-shop-name">U K Mobile Repairing Center</div>
                </div>
            </div>
            
            <!-- Right side with user info -->
            <div class="desktop-header-right">
                {% if current_user.is_authenticated %}
                <div class="user-profile">
                    <div class="user-profile-info">
                        <span class="user-name">{{ current_user.username }}</span>
                        <span class="badge role-{{ current_user.role }} role-badge ms-2">
                            {{ current_user.role|title }}
                        </span>
                    </div>
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar - Desktop (Hidden by default, shown on hover, positioned under header) -->
    <div class="sidebar d-none d-md-block sidebar-hidden">
        <div class="sidebar-content">
            <nav class="nav flex-column">
                {% if current_user.is_authenticated %}
                    <!-- POS - Show for Admin, Staff -->
                    {% if current_user.role in ['admin', 'staff'] %}
                    <a class="nav-link {% if request.endpoint and 'pos' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('pos.dashboard') }}">
                        <i class="fas fa-shopping-cart"></i>
                        <span>POS</span>
                    </a>
                    {% endif %}
                    
                    <!-- Inventory - Show for Admin, Staff -->
                    {% if current_user.role in ['admin', 'staff'] %}
                    <a class="nav-link {% if request.endpoint and 'inventory' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('inventory.inventory_dashboard') }}">
                        <i class="fas fa-boxes"></i>
                        <span>Inventory</span>
                    </a>
                    {% endif %}
                    
                    <!-- Repair - Show for Admin, Staff, Technician -->
                    {% if current_user.role in ['admin', 'staff', 'technician'] %}
                    <a class="nav-link {% if request.endpoint and 'repair' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('repair.repair_dashboard') }}">
                        <i class="fas fa-tools"></i>
                        <span>Repair</span>
                    </a>
                    {% endif %}
                    
                    <!-- Employees Dashboard - Show for Admin only -->
                    {% if current_user.role in ['admin'] %}
                    <a class="nav-link {% if request.endpoint and 'employee' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('employee.employee_dashboard') }}">
                        <i class="fas fa-users"></i>
                        <span>Employees</span>
                    </a>
                    {% endif %}
                    
                    <!-- Barcode Attendance - Show for Admin, Staff -->
                    {% if current_user.role == 'admin' %}
                    <a class="nav-link {% if request.endpoint and 'barcode_attendance' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('employee.barcode_attendance_interface') }}">
                        <i class="fas fa-barcode"></i>
                        <span>Barcode Scanner</span>
                    </a>
                    {% endif %}
                    
                    <!-- My Barcode - Show for all authenticated employees -->
                    {% if current_user.role|lower != 'admin' %}
                    <a class="nav-link {% if request.endpoint and 'my_barcode' in request.endpoint %}active{% endif %}" 
                    href="{{ url_for('employee.my_barcode') }}">
                        <i class="fas fa-id-card"></i>
                        <span>My Barcode</span>
                    </a>
                    {% endif %}

                {% endif %}
            </nav>
        </div>
        
        <div class="sidebar-footer">
            {% if current_user.is_authenticated %}
            <div class="sri-lanka-time ms-3">
                <small class="text-white">
                    <i class="fas fa-clock me-1"></i>
                    SL Time: {{ now_sl.strftime('%H:%M') if now_sl else '' }}
                </small>
            </div>
            <div class="user-info">
                <small class="text-white d-block mb-1">Logged in as</small>
                <h6 class="mb-1">
                    {{ current_user.username }}
                    <span class="badge role-{{ current_user.role }} role-badge ms-2">
                        {{ current_user.role|title }}
                    </span>
                </h6>
                <small class="text-white d-block">{{ current_user.email }}</small>
                <div class="mt-3 pt-3 border-top border-white border-opacity-25">                                        
                    <a class="nav-link py-2 px-0 text-danger logout-confirm" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Mobile Header -->
    <div class="mobile-header d-md-none">
        <div class="mobile-header-content">
            <div class="mobile-logo-container">
                <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="mobile-logo-img"
                     onerror="this.src='https://via.placeholder.com/40/4361ee/ffffff?text=UK'; this.onerror=null;">
                <div class="mobile-shop-name">U K Mobile Repairing Center</div>
            </div>
            <button class="hamburger-menu" id="mobileMenuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
    
    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
    
    <!-- Mobile Navigation Sidebar -->
    <div class="mobile-nav-container" id="mobileNavContainer">
        <div class="mobile-nav-header">
            <button class="mobile-nav-close" id="mobileNavClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="mobile-header-logo">
                <img src="{{ url_for('static', filename='uploads/logo.jpg') }}" alt="UK Mobile Repairing Center" class="mobile-header-logo-img"
                     onerror="this.src='https://via.placeholder.com/50/4361ee/ffffff?text=UK'; this.onerror=null;">
                <div class="mobile-header-shop-name">U K Mobile<br>Repairing Center</div>
            </div>
            
            <div class="mobile-user-info">
                {% if current_user.is_authenticated %}
                <div class="mobile-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h5 class="mb-1">{{ current_user.username }}</h5>
                <p class="mb-0 opacity-75">{{ current_user.email }}</p>
                <span class="badge role-{{ current_user.role }} role-badge mt-2">
                    {{ current_user.role|title }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="mobile-nav-content">
            {% if current_user.is_authenticated %}
                <!-- POS - Show for Admin, Staff -->
                {% if current_user.role in ['admin', 'staff'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'pos' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('pos.dashboard') }}">
                    <i class="fas fa-shopping-cart"></i>
                    <span>POS Dashboard</span>
                </a>
                {% endif %}
                
                <!-- Inventory - Show for Admin, Staff -->
                {% if current_user.role in ['admin', 'staff'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'inventory' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('inventory.inventory_dashboard') }}">
                    <i class="fas fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                {% endif %}
                
                <!-- Repair - Show for Admin, Staff, Technician -->
                {% if current_user.role in ['admin', 'staff', 'technician'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'repair' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('repair.repair_dashboard') }}">
                    <i class="fas fa-tools"></i>
                    <span>Repair Center</span>
                </a>
                {% endif %}
                
                <!-- Employees Dashboard - Show for Admin only -->
                {% if current_user.role in ['admin'] %}
                <a class="mobile-nav-item {% if request.endpoint and 'employee' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('employee.employee_dashboard') }}">
                    <i class="fas fa-users"></i>
                    <span>Employees</span>
                </a>
                {% endif %}
                
                <!-- Barcode Attendance - Show for Admin, Staff -->
                {% if current_user.role =='admin' %}
                <a class="mobile-nav-item {% if request.endpoint and 'barcode_attendance' in request.endpoint %}active{% endif %}" 
                   href="{{ url_for('employee.barcode_attendance_interface') }}">
                    <i class="fas fa-barcode"></i>
                    <span>Barcode Scanner</span>
                </a>
                {% endif %}
                
                <!-- My Barcode - Show for all authenticated employees -->
                {% if current_user.role|lower != 'admin' %}
                <a class="mobile-nav-item {{ 'active' if request.endpoint == 'employee.my_barcode' else '' }}"
                href="{{ url_for('employee.my_barcode') }}">
                    <i class="fas fa-id-card"></i>
                    <span>My Barcode</span>
                </a>
                {% endif %}
                <div class="mobile-nav-divider"></div>
            {% endif %}
        </div>
        
        <div class="mobile-nav-footer">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger w-100 logout-confirm" style="border-radius: 10px;">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100" style="border-radius: 10px;">
                <i class="fas fa-sign-in-alt me-2"></i>Login
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
                            <i class="fas 
                                {% if category == 'success' %}fa-check-circle 
                                {% elif category == 'danger' %}fa-exclamation-circle 
                                {% elif category == 'warning' %}fa-exclamation-triangle 
                                {% else %}fa-info-circle{% endif %} 
                                me-3"></i>
                            <div>{{ message }}</div>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Page Content -->
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Confirmation Modal for Logout -->
    <div class="modal fade confirmation-modal" id="logoutConfirmationModal" tabindex="-1" aria-labelledby="logoutConfirmationLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 class="modal-title" id="logoutConfirmationLabel">Confirm Logout</h5>
                    <p>Are you sure you want to logout from your account?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn confirmation-btn confirmation-btn-cancel" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn confirmation-btn confirmation-btn-confirm" id="confirmLogoutBtn">
                        <i class="fas fa-check me-1"></i>
                        Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
    $(document).ready(function() {
    // Desktop Sidebar Logic
    let sidebarTimeout;
    const sidebar = $('.sidebar');
    const hoverTrigger = $('.sidebar-hover-trigger');
    const mainContent = $('.main-content');
    const desktopNavToggle = $('#desktopNavToggle');
    let isSidebarLocked = false;
    
    // Function to show sidebar
    function showSidebar() {
        clearTimeout(sidebarTimeout);
        sidebar.removeClass('sidebar-hidden');
        mainContent.removeClass('full-width');
        desktopNavToggle.addClass('active');
        desktopNavToggle.find('.toggle-text').text('Close Menu');
    }
    
    // Function to hide sidebar
    function hideSidebar() {
        if (!isSidebarLocked) {
            clearTimeout(sidebarTimeout);
            sidebar.addClass('sidebar-hidden');
            mainContent.addClass('full-width');
            desktopNavToggle.removeClass('active');
            desktopNavToggle.removeClass('locked');
            desktopNavToggle.find('.toggle-text').text('Menu');
        }
    }
    
    // Toggle sidebar lock state
    function toggleSidebarLock() {
        isSidebarLocked = !isSidebarLocked;
        
        if (isSidebarLocked) {
            showSidebar();
            desktopNavToggle.addClass('locked');
            desktopNavToggle.find('.toggle-text').text('Close Menu');
        } else {
            hideSidebar();
            desktopNavToggle.removeClass('locked');
            desktopNavToggle.find('.toggle-text').text('Menu');
        }
    }
    
    // Show sidebar when hovering trigger zone
    hoverTrigger.on('mouseenter', showSidebar);
    sidebar.on('mouseenter', showSidebar);
    
    // Hide sidebar when leaving sidebar area (if not locked)
    hoverTrigger.on('mouseleave', hideSidebar);
    sidebar.on('mouseleave', hideSidebar);
    
    // Toggle sidebar on button click
    desktopNavToggle.on('click', function(e) {
        e.stopPropagation();
        if (sidebar.hasClass('sidebar-hidden')) {
            // Show sidebar
            showSidebar();
            isSidebarLocked = true;
        } else {
            // Hide sidebar
            hideSidebar();
            isSidebarLocked = false;
        }
    });
    
    // Close sidebar when clicking anywhere outside (if not locked)
    $(document).on('click', function(e) {
        if ($(window).width() >= 768 && !isSidebarLocked) {
            // Check if click is outside sidebar and not on toggle button
            if (!sidebar.is(e.target) && 
                sidebar.has(e.target).length === 0 && 
                !desktopNavToggle.is(e.target) &&
                !desktopNavToggle.has(e.target).length) {
                hideSidebar();
            }
        }
    });
    
    // Also close when pressing Escape key
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && $(window).width() >= 768 && !isSidebarLocked) {
            hideSidebar();
        }
    });
    
    // Mobile Navigation Toggle
    const menuToggle = $('#mobileMenuToggle');
    const navOverlay = $('#mobileNavOverlay');
    const navContainer = $('#mobileNavContainer');
    const navClose = $('#mobileNavClose');
    
    // Open mobile menu
    menuToggle.on('click', function(e) {
        e.stopPropagation();
        $(this).toggleClass('active');
        navOverlay.toggleClass('show');
        navContainer.toggleClass('show');
        $('body').css('overflow', 'hidden');
    });
    
    // Close mobile menu
    function closeMenu() {
        menuToggle.removeClass('active');
        navOverlay.removeClass('show');
        navContainer.removeClass('show');
        $('body').css('overflow', 'auto');
    }
    
    // Close on overlay click
    navOverlay.on('click', closeMenu);
    
    // Close on X button click
    navClose.on('click', closeMenu);
    
    // Close on navigation item click
    $('.mobile-nav-item').on('click', function() {
        setTimeout(closeMenu, 300);
    });
    
    // Close mobile menu when clicking outside
    $(document).on('click', function(e) {
        if ($(window).width() < 768) {
            if (!navContainer.is(e.target) && 
                navContainer.has(e.target).length === 0 && 
                !menuToggle.is(e.target) &&
                !menuToggle.has(e.target).length &&
                navContainer.hasClass('show')) {
                closeMenu();
            }
        }
    });
    
    // CSRF Token Setup
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}");
            }
        }
    });
    
    // Logout Confirmation Handler
    let logoutUrl = '';
    
    // Handle logout clicks
    $(document).on('click', '.logout-confirm', function(e) {
        e.preventDefault();
        logoutUrl = $(this).attr('href');
        
        // Show confirmation modal
        const logoutModal = new bootstrap.Modal(document.getElementById('logoutConfirmationModal'), {
            backdrop: 'static',
            keyboard: true
        });
        logoutModal.show();
        
        // Focus on cancel button
        setTimeout(() => {
            $('.confirmation-btn-cancel').focus();
        }, 100);
    });
    
    // Confirm logout
    $('#confirmLogoutBtn').click(function() {
        if (logoutUrl) {
            window.location.href = logoutUrl;
        }
    });
    
    // Close modal with ESC key
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('logoutConfirmationModal'));
            if (modal) {
                modal.hide();
            }
            closeMenu();
        }
    });
    
    // Fix height on resize
    function fixHeights() {
        const windowHeight = $(window).height();
        const mobileHeaderHeight = $('.mobile-header').outerHeight() || 0;
        const desktopHeaderHeight = $('.desktop-header').outerHeight() || 0;
        
        if ($(window).width() < 768) {
            $('.main-content').css('min-height', windowHeight - mobileHeaderHeight + 'px');
            $('.main-content').css('padding-top', (mobileHeaderHeight + 20) + 'px');
        } else {
            $('.main-content').css('min-height', windowHeight - desktopHeaderHeight + 'px');
            $('.main-content').css('padding-top', (desktopHeaderHeight + 30) + 'px');
            $('.main-content').css('padding-left', '30px');
            $('.main-content').css('padding-right', '30px');
        }
        
        $('.mobile-nav-container').css('height', windowHeight + 'px');
        
        // Adjust sidebar height to be under header
        if ($(window).width() >= 768) {
            const headerHeight = $('.desktop-header').outerHeight() || 0;
            sidebar.css({
                'top': headerHeight + 'px',
                'height': 'calc(100vh - ' + headerHeight + 'px)'
            });
            $('.sidebar-hover-trigger').css({
                'top': headerHeight + 'px',
                'height': 'calc(100vh - ' + headerHeight + 'px)'
            });
        }
    }
    
    // Initial height fix
    fixHeights();
    $(window).on('resize', fixHeights);
    $(window).on('orientationchange', function() {
        setTimeout(fixHeights, 100);
    });
    
    // Barcode Scanner Quick Access (Ctrl+B)
    $(document).on('keydown', function(e) {
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            // Check if user has access to barcode scanner
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            window.location.href = "{{ url_for('employee.barcode_attendance_interface') }}";
            {% endif %}
        }
        
        // Ctrl+M for My Barcode (for all employees)
        if (e.ctrlKey && e.key === 'm') {
            e.preventDefault();
            {% if current_user.is_authenticated %}
            window.location.href = "{{ url_for('employee.my_barcode') }}";
            {% endif %}
        }
    });
});
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>