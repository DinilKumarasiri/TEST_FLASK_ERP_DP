<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Invoice {{ invoice.invoice_number }} - Mobile Shop ERP</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @media print {
            body {
                font-size: 11px;
            }
            .no-print {
                display: none !important;
            }
            .card {
                border: none !important;
                box-shadow: none !important;
            }
            .table th, .table td {
                padding: 4px 8px !important;
            }
            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
        }
        
        .invoice-header {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .company-logo {
            font-size: 1.5rem;
            color: #0d6efd;
        }
        
        .invoice-table th {
            background-color: #f8f9fa;
        }
        
        .totals-table {
            width: 300px;
            margin-left: auto;
        }
        
        .warranty-card {
            border-left: 4px solid #0d6efd;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header with Print Button -->
        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-file-invoice me-2"></i>Repair Invoice Print Preview</h2>
                    <div>
                        <button onclick="window.print()" class="btn btn-primary me-2">
                            <i class="fas fa-print me-1"></i> Print Invoice
                        </button>
                         <button onclick="window.print()" class="btn btn-primary me-2" id="printButton">
        <i class="fas fa-print me-1"></i> Print Now
    </button>
    <button onclick="window.close()" class="btn btn-secondary">
        <i class="fas fa-times me-1"></i> Close Window
    </button>
                        <a href="{{ url_for('repair.repair_invoice_detail', invoice_id=invoice.id) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Invoice
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Content -->
        <div class="card">
            <div class="card-body">
                <!-- Header -->
                <div class="invoice-header">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="company-logo">
                                <i class="fas fa-tools"></i> Mobile Repair Center
                            </div>
                            <p class="mb-1">123 Repair Street</p>
                            <p class="mb-1">City, State 12345</p>
                            <p class="mb-0">Phone: (123) 456-7890 | GST: 27ABCDE1234F1Z5</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h1 class="display-6 mb-2">REPAIR INVOICE</h1>
                            <p class="mb-1"><strong>Invoice #:</strong> {{ invoice.invoice_number }}</p>
                            <p class="mb-1"><strong>Date:</strong> {{ invoice.date.strftime('%B %d, %Y') }}</p>
                            <p class="mb-0"><strong>Job #:</strong> {{ invoice.repair_job.job_number if invoice.repair_job else 'N/A' }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Bill To -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Bill To:</h5>
                        <p class="mb-1"><strong>{{ invoice.customer_name }}</strong></p>
                        {% if invoice.customer_phone %}
                        <p class="mb-1">Phone: {{ invoice.customer_phone }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h5>Device Information:</h5>
                        <p class="mb-1"><strong>{{ invoice.brand }} {{ invoice.model }}</strong></p>
                        <p class="mb-1">Type: {{ invoice.device_type|title }}</p>
                        {% if invoice.imei %}
                        <p class="mb-0">IMEI: {{ invoice.imei }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Issue Summary -->
                <div class="mb-4">
                    <h5>Issue Description:</h5>
                    <div class="border p-3 bg-light">
                        {{ invoice.issue_description|replace('\n', '<br>')|safe }}
                    </div>
                </div>
                
                <!-- Work Done -->
                {% if invoice.work_done %}
                <div class="mb-4">
                    <h5>Work Performed:</h5>
                    <div class="border p-3 bg-light">
                        {{ invoice.work_done|replace('\n', '<br>')|safe }}
                    </div>
                </div>
                {% endif %}
                
                <!-- Items Table -->
                <div class="table-responsive mb-4">
                    <table class="table table-bordered invoice-table">
                        <thead>
                            <tr>
                                <th width="50">#</th>
                                <th>Item Description</th>
                                <th width="100" class="text-center">Qty</th>
                                <th width="120" class="text-end">Unit Price</th>
                                <th width="120" class="text-end">Total</th>
                                <th width="150">Warranty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in invoice.items %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ item.description }}</strong>
                                    {% if item.notes %}
                                    <br><small class="text-muted">{{ item.notes }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">Rs.{{ "%.2f"|format(item.unit_price) }}</td>
                                <td class="text-end">Rs.{{ "%.2f"|format(item.total) }}</td>
                                <td>
                                    {% if item.warranty_info %}
                                    <small>{{ item.warranty_info }}</small>
                                    {% else %}
                                    <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Totals & Payment -->
                <div class="row">
                    <div class="col-md-6">
                        <!-- Warranty Information -->
                        {% if invoice.warranty_period > 0 %}
                        <div class="card warranty-card mb-4">
                            <div class="card-body">
                                <h6><i class="fas fa-shield-alt me-2"></i>Warranty Information</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Period:</strong> {{ invoice.warranty_period }} months</p>
                                        <p class="mb-1"><strong>Start Date:</strong> {{ invoice.warranty_start.strftime('%Y-%m-%d') if invoice.warranty_start else 'N/A' }}</p>
                                        <p class="mb-0"><strong>End Date:</strong> {{ invoice.warranty_end.strftime('%Y-%m-%d') if invoice.warranty_end else 'N/A' }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-0"><strong>Coverage:</strong></p>
                                        <small class="text-muted">Parts and labor for original repair issue</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Totals -->
                        <table class="table table-bordered totals-table">
                            <tr>
                                <td><strong>Parts Cost</strong></td>
                                <td class="text-end">Rs.{{ "%.2f"|format(invoice.parts_cost) }}</td>
                            </tr>
                            <tr>
                                <td><strong>Labor Cost</strong></td>
                                <td class="text-end">Rs.{{ "%.2f"|format(invoice.labor_cost) }}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Cost</strong></td>
                                <td class="text-end">Rs.{{ "%.2f"|format(invoice.total_cost) }}</td>
                            </tr>
                            <tr>
                                <td><strong>Tax ({{ (invoice.tax_rate * 100)|int }}%)</strong></td>
                                <td class="text-end">Rs.{{ "%.2f"|format(invoice.tax_amount) }}</td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>Grand Total</strong></td>
                                <td class="text-end"><strong>Rs.{{ "%.2f"|format(invoice.grand_total) }}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Advance Paid</strong></td>
                                <td class="text-end">Rs.{{ "%.2f"|format(invoice.advance_paid) }}</td>
                            </tr>
                            <tr class="table-{{ 'success' if invoice.balance_due == 0 else 'warning' }}">
                                <td><strong>Balance Due</strong></td>
                                <td class="text-end"><strong>Rs.{{ "%.2f"|format(invoice.balance_due) }}</strong></td>
                            </tr>
                        </table>
                        
                        <!-- Payment Status -->
                        <div class="mt-3">
                            <p class="mb-1">
                                <strong>Payment Status:</strong> 
                                <span class="badge bg-{{ 'success' if invoice.payment_status == 'paid' else 'warning' if invoice.payment_status == 'pending' else 'primary' if invoice.payment_status == 'partial' else 'secondary' }}">
                                    {{ invoice.payment_status|title }}
                                </span>
                            </p>
                            <p class="mb-0">
                                <strong>Payment Method:</strong> {{ invoice.payment_method|title }}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Terms & Conditions -->
                <div class="mt-4 pt-4 border-top">
                    <h6>Terms & Conditions:</h6>
                    <div class="bg-light p-3">
                        {{ invoice.terms_conditions|replace('\n', '<br>')|safe }}
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="mt-4 pt-4 border-top text-center">
                    <p class="mb-1">Thank you for choosing our repair service!</p>
                    <p class="text-muted small mb-0">
                        For warranty claims or queries, contact: repair@mobileshop.com | Phone: (123) 456-7890
                    </p>
                </div>
                
                <!-- Signature Area -->
                <div class="row mt-5">
                    <div class="col-6 text-center">
                        <p class="border-top pt-4">Customer Signature</p>
                        <p class="text-muted small">Date: ___________________</p>
                    </div>
                    <div class="col-6 text-center">
                        <p class="border-top pt-4">Authorized Signature</p>
                        <p class="text-muted small">Date: ___________________</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Print Instructions -->
        <div class="alert alert-info no-print mt-4">
            <i class="fas fa-info-circle me-2"></i>
            Click the "Print Invoice" button to print this invoice. For best results, use A4 paper.
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
    window.addEventListener('load', function() {
    // Check if we should auto-print
    const urlParams = new URLSearchParams(window.location.search);
    const shouldAutoPrint = urlParams.get('autoprint') === 'true';
    
    // Also check for print parameter in URL fragment
    const hashParams = window.location.hash.substr(1);
    const shouldPrint = shouldAutoPrint || hashParams.includes('print=true');
    
    if (shouldPrint) {
        // Small delay to ensure all content is rendered
        setTimeout(function() {
            window.print();
        }, 1000);
    }
    
    // Add print button event listener
    document.getElementById('printButton').addEventListener('click', function() {
        window.print();
    });
});
document.addEventListener('DOMContentLoaded', function() {
    {% if autoprint %}
    // Auto-print when page loads
    setTimeout(function() {
        window.print();
    }, 500);
    {% endif %}
});
</script>
</body>
</html>