{% extends "base.html" %}

{% block title %}Job Detail - {{ job.job_number }}{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #dee2e6;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -25px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #0d6efd;
        border: 2px solid white;
    }
    
    .status-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
    
    .part-used-card {
        border-left: 4px solid #0d6efd;
        margin-bottom: 10px;
    }
    
    .warranty-badge {
        font-size: 0.75rem;
    }
    
    .warranty-active {
        background-color: #d1e7dd;
        color: #0f5132;
        border-color: #badbcc;
    }
    
    .warranty-expired {
        background-color: #f8d7da;
        color: #842029;
        border-color: #f5c2c7;
    }
    
    .claim-card {
        border-left: 4px solid;
        transition: all 0.3s;
    }
    
    .claim-pending { border-color: #ffc107; }
    .claim-approved { border-color: #198754; }
    .claim-rejected { border-color: #dc3545; }
    .claim-in_progress { border-color: #0d6efd; }
    .claim-completed { border-color: #20c997; }
    
    .claim-actions {
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .claim-card:hover .claim-actions {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tools me-2"></i>Repair Job Details</h2>
    <div>
        <a href="{{ url_for('repair.job_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Jobs
        </a>
        <a href="{{ url_for('repair.job_card', job_id=job.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-print me-1"></i> Print Job Card
        </a>
    </div>
</div>

<!-- Check for existing repair invoice -->
{% if job.repair_invoices %}
    {% set existing_invoice = job.repair_invoices|first %}
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <div>
            <i class="fas fa-file-invoice me-2"></i>
            <strong>Invoice Already Created:</strong> 
            <a href="{{ url_for('repair.repair_invoice_detail', invoice_id=existing_invoice.id) }}" class="alert-link">
                {{ existing_invoice.invoice_number }}
            </a>
        </div>
        <div>
            <span class="badge bg-{{ 'success' if existing_invoice.payment_status == 'paid' else 'warning' }}">
                {{ existing_invoice.payment_status|title }}
            </span>
            <a href="{{ url_for('repair.repair_invoices_list') }}" class="btn btn-sm btn-outline-primary ms-2">
                View All Invoices
            </a>
        </div>
    </div>
{% endif %}

<!-- Warranty Status Alert -->
{% if job.warranty_period > 0 and job.delivered_date %}
    {% set warranty_end = job.delivered_date + timedelta(days=30*job.warranty_period) %}
    {% set is_warranty_active = now <= warranty_end %}
    {% if is_warranty_active %}
    <div class="alert alert-success d-flex justify-content-between align-items-center mb-4">
        <div>
            <i class="fas fa-shield-alt me-2"></i>
            <strong>Warranty Active:</strong> This device has {{ job.warranty_period }} month(s) warranty. 
            Expires on {{ warranty_end.strftime('%Y-%m-%d') }} ({{ (warranty_end - now).days }} days remaining).
        </div>
        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#warrantyClaimModal">
            <i class="fas fa-flag me-1"></i> File Warranty Claim
        </button>
    </div>
    {% elif job.status == 'delivered' %}
    <div class="alert alert-secondary mb-4">
        <i class="fas fa-clock me-2"></i>
        <strong>Warranty Expired:</strong> This device's warranty expired on {{ warranty_end.strftime('%Y-%m-%d') }}
    </div>
    {% endif %}
{% endif %}

<div class="row">
    <!-- Left Column - Job Info -->
    <div class="col-lg-8">
        <!-- Job Header -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Job #{{ job.job_number }}</h5>
                <div>
                    <span class="badge 
                        {% if job.status == 'completed' %}bg-success
                        {% elif job.status == 'delivered' %}bg-info
                        {% elif job.status == 'diagnostic' %}bg-warning
                        {% elif job.status == 'repairing' %}bg-primary
                        {% elif job.status == 'waiting_parts' %}bg-danger
                        {% else %}bg-secondary{% endif %} fs-6">
                        {{ job.status|title }}
                    </span>
                    {% if job.warranty_period > 0 and job.delivered_date %}
                        {% set warranty_end = job.delivered_date + timedelta(days=30*job.warranty_period) %}
                        {% set is_warranty_active = now <= warranty_end %}
                        <span class="badge {% if is_warranty_active %}warranty-active{% else %}warranty-expired{% endif %} warranty-badge ms-2">
                            <i class="fas fa-shield-alt me-1"></i> {{ job.warranty_period }} month{% if job.warranty_period > 1 %}s{% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2"></i>Customer Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">Name:</th>
                                <td>{{ job.customer.name if job.customer else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Phone:</th>
                                <td>{{ job.customer.phone if job.customer else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ job.customer.email if job.customer else 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Address:</th>
                                <td>{{ job.customer.address if job.customer else 'N/A' }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-mobile-alt me-2"></i>Device Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">Device Type:</th>
                                <td>{{ job.device_type|title }}</td>
                            </tr>
                            <tr>
                                <th>Brand/Model:</th>
                                <td>{{ job.brand }} {{ job.model }}</td>
                            </tr>
                            <tr>
                                <th>IMEI:</th>
                                <td>{{ job.imei or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <th>Serial No:</th>
                                <td>{{ job.serial_number or 'N/A' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Issue Description -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Issue Description</h6>
            </div>
            <div class="card-body">
                <p>{{ job.issue_description }}</p>
                {% if job.accessories_received %}
                <div class="mt-3">
                    <strong>Accessories Received:</strong>
                    <p class="mb-0">{{ job.accessories_received }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Repair Details -->
        {% if job.diagnosis_details or job.repair_details %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Repair Details</h6>
            </div>
            <div class="card-body">
                {% if job.diagnosis_details %}
                <div class="mb-3">
                    <h6>Diagnosis:</h6>
                    <p>{{ job.diagnosis_details }}</p>
                </div>
                {% endif %}
                
                {% if job.repair_details %}
                <div>
                    <h6>Repair Work Done:</h6>
                    <p>{{ job.repair_details }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Parts Used -->
        {% if job.repair_items %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-box-open me-2"></i>Parts Used</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Part</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Warranty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in job.repair_items %}
                            <tr>
                                <td>{{ item.product.name if item.product else 'Unknown' }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>Rs.{{ "%.2f"|format(item.unit_price) }}</td>
                                <td>Rs.{{ "%.2f"|format(item.total_price) }}</td>
                                <td>
                                    {% if job.warranty_period > 0 %}
                                    <span class="badge bg-info">Covered</span>
                                    {% else %}
                                    <span class="badge bg-secondary">No Warranty</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-active">
                                <td colspan="3" class="text-end"><strong>Total Parts Cost:</strong></td>
                                <td><strong>Rs.{{ "%.2f"|format(job.final_cost) }}</strong></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Right Column - Actions & Timeline -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                <!-- Status Update Buttons -->
                {% if current_user.role in ['admin', 'manager', 'technician'] %}
                    <div class="btn-group btn-group-sm w-100 mb-3">
                        <button class="btn btn-outline-success" 
                                onclick="updateStatus({{ job.id }}, 'repairing')"
                                {% if job.status not in ['diagnostic', 'waiting_parts'] or (current_user.role == 'technician' and current_user.id != job.technician_id) or job.repair_invoices %}disabled{% endif %}>
                            <i class="fas fa-play me-1"></i> Start Repair
                        </button>
                        <button class="btn btn-outline-warning" 
                                onclick="updateStatus({{ job.id }}, 'waiting_parts')"
                                {% if job.status not in ['diagnostic', 'repairing'] or (current_user.role == 'technician' and current_user.id != job.technician_id) or job.repair_invoices %}disabled{% endif %}>
                            <i class="fas fa-clock me-1"></i> Wait Parts
                        </button>
                        <button class="btn btn-outline-info" 
                                onclick="updateStatus({{ job.id }}, 'completed')"
                                {% if job.status != 'repairing' or (current_user.role == 'technician' and current_user.id != job.technician_id) or job.repair_invoices %}disabled{% endif %}>
                            <i class="fas fa-check me-1"></i> Complete
                        </button>
                    </div>
                {% endif %}
                
                <!-- File Warranty Claim Button -->
                {% if job.warranty_period > 0 and job.delivered_date %}
                    {% set warranty_end = job.delivered_date + timedelta(days=30*job.warranty_period) %}
                    {% set is_warranty_active = now <= warranty_end %}
                    {% if is_warranty_active and current_user.role in ['admin', 'manager', 'technician'] %}
                    <div class="mb-3">
                        <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#warrantyClaimModal">
                            <i class="fas fa-flag me-1"></i> File Warranty Claim
                        </button>
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- Assign Technician (Admin/Manager only) -->
                {% if current_user.role in ['admin', 'manager'] %}
                <div class="mb-3">
                    <form method="POST" action="{{ url_for('repair.assign_technician', job_id=job.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <label class="form-label small">Assign Technician:</label>
                        <div class="input-group">
                            <select name="technician_id" class="form-select form-select-sm" {% if job.repair_invoices %}disabled{% endif %}>
                                <option value="">Unassigned</option>
                                {% for tech in technicians %}
                                <option value="{{ tech.id }}" {% if job.technician_id == tech.id %}selected{% endif %}>
                                    {{ tech.username }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary" {% if job.repair_invoices %}disabled{% endif %}>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
                
                <!-- Customer Approval Status -->
                {% if job.status in ['diagnostic', 'waiting_parts'] %}
                <div class="mb-3">
                    <label class="form-label small">Customer Approval:</label>
                    {% if job.customer_approval %}
                    <div class="alert alert-success py-2 mb-0">
                        <i class="fas fa-check-circle me-1"></i> Approved on {{ job.approval_date.strftime('%Y-%m-%d') }}
                    </div>
                    {% else %}
                    <form method="POST" action="{{ url_for('repair.customer_approval', job_id=job.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="btn-group w-100">
                            <button type="submit" name="approval" value="yes" class="btn btn-sm btn-success" {% if job.repair_invoices %}disabled{% endif %}>
                                <i class="fas fa-check me-1"></i> Approved
                            </button>
                            <button type="submit" name="approval" value="no" class="btn btn-sm btn-danger" {% if job.repair_invoices %}disabled{% endif %}>
                                <i class="fas fa-times me-1"></i> Rejected
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Add Diagnosis (Technician only) -->
                {% if current_user.role == 'technician' and job.technician_id == current_user.id and job.status == 'diagnostic' and not job.repair_invoices %}
                <div class="mb-3">
                    <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#diagnosisModal">
                        <i class="fas fa-stethoscope me-1"></i> Add Diagnosis
                    </button>
                </div>
                {% endif %}
                
                <!-- Add Spare Part -->
                {% if job.status in ['repairing', 'waiting_parts'] and not job.repair_invoices %}
                <div class="mb-3">
                    <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#sparePartModal">
                        <i class="fas fa-plus-circle me-1"></i> Add Spare Part
                    </button>
                </div>
                {% endif %}
                
                <!-- Complete Job (Technician/Admin) -->
                {% if current_user.role in ['admin', 'manager', 'technician'] and job.technician_id == current_user.id and job.status == 'repairing' and not job.repair_invoices %}
                <div class="mb-3">
                    <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#completeJobModal">
                        <i class="fas fa-flag-checkered me-1"></i> Complete Job
                    </button>
                </div>
                {% endif %}
                
                <!-- Create Invoice & Deliver (Admin/Manager) -->
                {% if current_user.role in ['admin', 'manager'] and job.status == 'completed' and not job.repair_invoices %}
                <div class="mb-3">
                    <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
                        <i class="fas fa-file-invoice me-1"></i> Create Invoice & Deliver
                    </button>
                </div>
                {% endif %}
                
                <!-- View Invoice Button (if invoice exists) -->
                {% if job.repair_invoices %}
                    {% set existing_invoice = job.repair_invoices|first %}
                    <div class="mb-3">
                        <a href="{{ url_for('repair.repair_invoice_detail', invoice_id=existing_invoice.id) }}" 
                           class="btn btn-info w-100">
                            <i class="fas fa-eye me-1"></i> View Invoice
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Warranty Information -->
        {% if job.warranty_period > 0 and job.delivered_date %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Warranty Information</h6>
            </div>
            <div class="card-body">
                {% set warranty_end = job.delivered_date + timedelta(days=30*job.warranty_period) %}
                {% set is_warranty_active = now <= warranty_end %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Warranty Period:</span>
                        <strong>{{ job.warranty_period }} month{% if job.warranty_period > 1 %}s{% endif %}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Delivered Date:</span>
                        <strong>{{ job.delivered_date.strftime('%Y-%m-%d') }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Warranty End:</span>
                        <strong>{{ warranty_end.strftime('%Y-%m-%d') }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Status:</span>
                        <span class="badge {% if is_warranty_active %}warranty-active{% else %}warranty-expired{% endif %}">
                            {% if is_warranty_active %}
                            Active ({{ (warranty_end - now).days }} days left)
                            {% else %}
                            Expired
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="alert alert-info small mb-0 mt-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Warranty covers original repair issues. Does not cover physical damage, liquid damage, or unauthorized modifications.
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Job Timeline -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Job Timeline</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <small class="text-muted">{{ job.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                        <p class="mb-1"><strong>Job Created</strong></p>
                        <p class="small mb-0">Status: Received</p>
                    </div>
                    
                    {% if job.technician_id %}
                    <div class="timeline-item">
                        <small class="text-muted">Assigned to technician</small>
                        <p class="mb-1"><strong>Technician Assigned</strong></p>
                        <p class="small mb-0">{{ job.technician.username }}</p>
                    </div>
                    {% endif %}
                    
                    {% if job.diagnosis_details %}
                    <div class="timeline-item">
                        <small class="text-muted">Diagnosis completed</small>
                        <p class="mb-1"><strong>Diagnosis Added</strong></p>
                    </div>
                    {% endif %}
                    
                    {% if job.customer_approval %}
                    <div class="timeline-item">
                        <small class="text-muted">{{ job.approval_date.strftime('%b %d, %Y') if job.approval_date else '' }}</small>
                        <p class="mb-1"><strong>Customer Approved Estimate</strong></p>
                    </div>
                    {% endif %}
                    
                    {% if job.completed_date %}
                    <div class="timeline-item">
                        <small class="text-muted">{{ job.completed_date.strftime('%b %d, %Y %I:%M %p') if job.completed_date else '' }}</small>
                        <p class="mb-1"><strong>Job Completed</strong></p>
                    </div>
                    {% endif %}
                    
                    {% if job.delivered_date %}
                    <div class="timeline-item">
                        <small class="text-muted">{{ job.delivered_date.strftime('%b %d, %Y %I:%M %p') if job.delivered_date else '' }}</small>
                        <p class="mb-1"><strong>Delivered to Customer</strong></p>
                        {% if job.warranty_period > 0 %}
                        <p class="small mb-0">Warranty: {{ job.warranty_period }} months</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Financial Summary -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Financial Summary</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>Estimated Cost:</td>
                        <td class="text-end">Rs.{{ "%.2f"|format(job.estimated_cost) }}</td>
                    </tr>
                    <tr>
                        <td>Final Cost:</td>
                        <td class="text-end">Rs.{{ "%.2f"|format(job.final_cost) }}</td>
                    </tr>
                    {% if job.warranty_period > 0 %}
                    <tr>
                        <td>Warranty:</td>
                        <td class="text-end">{{ job.warranty_period }} months</td>
                    </tr>
                    {% endif %}
                    <tr class="table-active">
                        <td><strong>Balance:</strong></td>
                        <td class="text-end"><strong>Rs.{{ "%.2f"|format(job.final_cost - job.estimated_cost) }}</strong></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Diagnosis Modal -->
<div class="modal fade" id="diagnosisModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('repair.add_diagnosis', job_id=job.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Diagnosis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Diagnosis Details</label>
                        <textarea name="diagnosis_details" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Estimated Cost</label>
                        <input type="number" name="estimated_cost" class="form-control" step="0.01" value="{{ job.estimated_cost }}" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="needs_parts" id="needsParts">
                        <label class="form-check-label" for="needsParts">
                            Needs spare parts
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Diagnosis</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Spare Part Modal -->
<div class="modal fade" id="sparePartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('repair.add_spare_part', job_id=job.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Spare Part</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Part</label>
                        <select name="product_id" class="form-select" required>
                            <option value="">Choose a part...</option>
                            {% for part in spare_parts %}
                            <option value="{{ part.id }}">{{ part.name }} (Stock: {{ part.stock_items|selectattr('status', 'equalto', 'available')|list|length }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" name="quantity" class="form-control" value="1" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Part</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Complete Job Modal -->
<div class="modal fade" id="completeJobModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('repair.complete_job', job_id=job.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Repair Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Repair Details (Work Done)</label>
                        <textarea name="repair_details" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Warranty Period (Months)</label>
                        <input type="number" name="warranty_period" class="form-control" value="{{ job.warranty_period or 0 }}" min="0">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Completing the job will calculate final costs and update inventory.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Complete Job</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Repair Invoice Modal -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('repair.create_repair_invoice', job_id=job.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Create Repair Invoice & Deliver</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Job Summary -->
                    <div class="alert alert-info mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Job:</strong> {{ job.job_number }}</p>
                                <p class="mb-1"><strong>Customer:</strong> {{ job.customer.name if job.customer else 'N/A' }}</p>
                                <p class="mb-0"><strong>Device:</strong> {{ job.brand }} {{ job.model }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Parts Cost:</strong> Rs.{{ "%.2f"|format(job.final_cost) }}</p>
                                <p class="mb-1"><strong>Advance Paid:</strong> Rs.{{ "%.2f"|format(job.estimated_cost) }}</p>
                                <p class="mb-0"><strong>Balance Due:</strong> Rs.{{ "%.2f"|format(job.final_cost - job.estimated_cost) }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoice Details -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Labor Cost *</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rs.</span>
                                    <input type="number" name="labor_cost" class="form-control" 
                                           step="0.01" min="0" value="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tax Rate *</label>
                                <div class="input-group">
                                    <input type="number" name="tax_rate" class="form-control" 
                                           step="0.01" min="0" max="100" value="0">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warranty Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Warranty Period *</label>
                                <select name="warranty_period" class="form-select" required>
                                    <option value="0">No Warranty</option>
                                    <option value="1" {% if job.warranty_period == 1 %}selected{% endif %}>1 Month</option>
                                    <option value="3" {% if job.warranty_period == 3 %}selected{% endif %}>3 Months</option>
                                    <option value="6" {% if job.warranty_period == 6 %}selected{% endif %}>6 Months</option>
                                    <option value="12" {% if job.warranty_period == 12 %}selected{% endif %}>12 Months</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Method *</label>
                                <select name="payment_method" class="form-select" required>
                                    <option value="cash">Cash</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="online">Online Payment</option>
                                    <option value="due">Due</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Payment -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Additional Payment Now</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rs.</span>
                                    <input type="number" name="amount_paid_now" class="form-control" step="0.01" min="0" 
                                    value="{{ (job.final_cost - job.estimated_cost)|abs }}">
                                </div>
                                <small class="text-muted">Enter amount being paid now (balance: Rs.{{ "%.2f"|format(job.final_cost - job.estimated_cost) }})</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Reference</label>
                                <input type="text" name="payment_reference" class="form-control" 
                                       placeholder="Transaction ID, Cheque #, etc.">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Technician Notes -->
                    <div class="mb-3">
                        <label class="form-label">Technician Notes (Optional)</label>
                        <textarea name="technician_notes" class="form-control" rows="3" 
                                  placeholder="Any additional notes about the repair..."></textarea>
                    </div>
                    
                    <!-- Additional Items -->
                    <div class="mb-3">
                        <label class="form-label">Additional Items/Charges</label>
                        <textarea name="additional_items" class="form-control" rows="3" 
                                  placeholder="Enter additional items (one per line in format: Description|Quantity|Unit Price)">
Example:
Screen Protector|1|500
Carrying Case|1|1200</textarea>
                        <small class="text-muted">Format: Description|Quantity|Unit Price (one per line)</small>
                    </div>
                    
                    <!-- Terms & Conditions -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="terms_accepted" id="termsAccepted" required>
                        <label class="form-check-label" for="termsAccepted">
                            Customer agrees to invoice terms and warranty conditions
                        </label>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This will create a repair invoice, mark the job as delivered, and set the warranty period.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-invoice me-1"></i> Create Invoice & Deliver
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Warranty Claim Modal -->
<div class="modal fade" id="warrantyClaimModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('repair.file_warranty_claim', job_id=job.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">File Warranty Claim</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Warranty Status -->
                    <div class="alert alert-info mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Job:</strong> {{ job.job_number }}</p>
                                <p class="mb-1"><strong>Device:</strong> {{ job.brand }} {{ job.model }}</p>
                                <p class="mb-0"><strong>Customer:</strong> {{ job.customer.name if job.customer else 'N/A' }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Warranty Period:</strong> {{ job.warranty_period }} months</p>
                                <p class="mb-1"><strong>Delivered:</strong> {{ job.delivered_date.strftime('%Y-%m-%d') if job.delivered_date else 'N/A' }}</p>
                                {% if job.delivered_date %}
                                    {% set warranty_end = job.delivered_date + timedelta(days=30*job.warranty_period) %}
                                    <p class="mb-0"><strong>Expires:</strong> {{ warranty_end.strftime('%Y-%m-%d') }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Claim Details -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Claim Date *</label>
                                <input type="date" name="claim_date" class="form-control" 
                                       value="{{ now.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Claim Type *</label>
                                <select name="claim_type" class="form-select" required>
                                    <option value="">Select type</option>
                                    <option value="same_issue">Same Issue as Original</option>
                                    <option value="new_issue">New Issue</option>
                                    <option value="part_failure">Part Failure</option>
                                    <option value="workmanship">Workmanship Issue</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Issue Description *</label>
                        <textarea name="issue_description" class="form-control" rows="4" 
                                  placeholder="Describe the issue in detail..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Initial Assessment</label>
                        <textarea name="initial_assessment" class="form-control" rows="3" 
                                  placeholder="Initial technician assessment..."></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Warranty claims will be reviewed. Customer may be charged if the issue is not covered by warranty.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Submit Warranty Claim</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateStatus(jobId, status) {
    if (confirm('Are you sure you want to update the job status to: ' + status + '?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/repair/update-status/${jobId}`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = '{{ csrf_token() }}';
        form.appendChild(csrfToken);
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = status;
        form.appendChild(statusInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Calculate total amount for create invoice modal
$(document).ready(function() {
    // Calculate total when labor cost changes
    $('input[name="labor_cost"]').on('change', function() {
        calculateInvoiceTotal();
    });
    
    // Calculate total when tax rate changes
    $('input[name="tax_rate"]').on('change', function() {
        calculateInvoiceTotal();
    });
    
    // Calculate total when additional items change
    $('textarea[name="additional_items"]').on('change', function() {
        calculateInvoiceTotal();
    });
    
    function calculateInvoiceTotal() {
        const partsCost = parseFloat('{{ job.final_cost }}') || 0;
        const laborCost = parseFloat($('input[name="labor_cost"]').val()) || 0;
        const taxRate = parseFloat($('input[name="tax_rate"]').val()) || 0;
        const advancePaid = parseFloat('{{ job.estimated_cost }}') || 0;
        
        // Calculate additional items
        let additionalItemsTotal = 0;
        const additionalItemsText = $('textarea[name="additional_items"]').val();
        if (additionalItemsText) {
            const lines = additionalItemsText.split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    const parts = line.trim().split('|');
                    if (parts.length >= 3) {
                        const quantity = parseFloat(parts[1]) || 0;
                        const unitPrice = parseFloat(parts[2]) || 0;
                        additionalItemsTotal += quantity * unitPrice;
                    }
                }
            });
        }
        
        // Calculate totals
        const subtotal = partsCost + laborCost + additionalItemsTotal;
        const taxAmount = subtotal * (taxRate / 100);
        const grandTotal = subtotal + taxAmount;
        const balanceDue = grandTotal - advancePaid;
        
        // Update display
        $('#invoiceSubtotal').text('Rs.' + subtotal.toFixed(2));
        $('#invoiceTax').text('Rs.' + taxAmount.toFixed(2));
        $('#invoiceTotal').text('Rs.' + grandTotal.toFixed(2));
        $('#invoiceBalance').text('Rs.' + balanceDue.toFixed(2));
        
        // Update max payment amount
        const amountPaidInput = $('input[name="amount_paid_now"]');
        if (balanceDue >= 0) {
            amountPaidInput.attr('max', balanceDue);
            if (parseFloat(amountPaidInput.val()) > balanceDue) {
                amountPaidInput.val(balanceDue);
            }
        }
    }
    
    // Initialize calculation
    calculateInvoiceTotal();
    
    // Validate additional items format
    $('textarea[name="additional_items"]').on('blur', function() {
        const text = $(this).val();
        if (text.trim()) {
            const lines = text.split('\n');
            let hasError = false;
            lines.forEach((line, index) => {
                if (line.trim()) {
                    const parts = line.trim().split('|');
                    if (parts.length < 3) {
                        hasError = true;
                        alert(`Line ${index + 1} is not in correct format. Use: Description|Quantity|Unit Price`);
                    }
                }
            });
            if (hasError) {
                $(this).focus();
            }
        }
    });
    
    // Validate create invoice form
    $('#createInvoiceModal form').on('submit', function(e) {
        const laborCost = parseFloat($('input[name="labor_cost"]').val());
        if (laborCost < 0) {
            alert('Labor cost cannot be negative');
            e.preventDefault();
            return;
        }
        
        const taxRate = parseFloat($('input[name="tax_rate"]').val());
        if (taxRate < 0 || taxRate > 100) {
            alert('Tax rate must be between 0 and 100');
            e.preventDefault();
            return;
        }
        
        const amountPaidNow = parseFloat($('input[name="amount_paid_now"]').val());
        if (amountPaidNow < 0) {
            alert('Payment amount cannot be negative');
            e.preventDefault();
            return;
        }
        
        if (!$('#termsAccepted').is(':checked')) {
            alert('Customer must agree to terms and conditions');
            e.preventDefault();
            return;
        }
    });
    
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}