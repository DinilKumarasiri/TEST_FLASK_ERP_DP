{% extends "base.html" %}

{% block title %}Commission Management - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .commission-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .commission-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filter-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .amount-cell {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-money-check-alt me-2"></i>Commission Management</h2>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculateCommissionModal">
            <i class="fas fa-calculator me-1"></i> Calculate Commission
        </button>
    </div>
</div>

<!-- Commission Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">₹{{ "%.2f"|format(total_pending|default(0)) }}</h2>
                        <p class="mb-0">Pending Commission</p>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">₹{{ "%.2f"|format(total_paid|default(0)) }}</h2>
                        <p class="mb-0">Paid Commission</p>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">₹{{ "%.2f"|format((total_pending|default(0)) + (total_paid|default(0))) }}</h2>
                        <p class="mb-0">Total Commission</p>
                    </div>
                    <i class="fas fa-rupee-sign fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card filter-card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Employee</label>
                <select name="employee_id" class="form-select">
                    <option value="">All Employees</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if request.args.get('employee_id')|int == emp.id %}selected{% endif %}>
                        {{ emp.username }} ({{ emp.role|title }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="all" {% if request.args.get('status') == 'all' %}selected{% endif %}>All Status</option>
                    <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="paid" {% if request.args.get('status') == 'paid' %}selected{% endif %}>Paid</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Month</label>
                <input type="month" name="month" class="form-control" 
                       value="{{ request.args.get('month', now.strftime('%Y-%m')) }}">
            </div>
            
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                    <a href="{{ url_for('employee.commissions') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Commission Table -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Commission Records
            <span class="badge bg-secondary ms-2">{{ commissions|length }}</span>
        </h5>
        <div>
            <button class="btn btn-sm btn-success" onclick="payAllPending()">
                <i class="fas fa-check-circle me-1"></i> Mark All as Paid
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 commission-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Employee</th>
                        <th>Type</th>
                        <th class="text-end">Sale Amount</th>
                        <th class="text-end">Rate</th>
                        <th class="text-end">Commission</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for commission in commissions %}
                    <tr>
                        <td>#{{ commission.id }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 32px; height: 32px;">
                                    {{ commission.employee.username[:1]|upper }}
                                </div>
                                <div class="ms-2">
                                    <h6 class="mb-0">{{ commission.employee.username }}</h6>
                                    <small class="text-muted">{{ commission.employee.role|title }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if commission.invoice_id %}
                            <span class="badge bg-info">Sale</span>
                            <small class="d-block">{{ commission.invoice.invoice_number if commission.invoice else 'N/A' }}</small>
                            {% elif commission.repair_job_id %}
                            <span class="badge bg-warning">Repair</span>
                            <small class="d-block">{{ commission.repair_job.job_number if commission.repair_job else 'N/A' }}</small>
                            {% else %}
                            <span class="badge bg-secondary">Other</span>
                            {% endif %}
                        </td>
                        <td class="text-end amount-cell">
                            ₹{{ "%.2f"|format(commission.sale_amount) }}
                        </td>
                        <td class="text-end">
                            {{ "%.1f"|format(commission.commission_rate) }}%
                        </td>
                        <td class="text-end amount-cell">
                            <strong>₹{{ "%.2f"|format(commission.commission_amount) }}</strong>
                        </td>
                        <td>
                            {% if commission.status == 'paid' %}
                            <span class="badge bg-success status-badge">Paid</span>
                            <small class="d-block text-muted">
                                {{ commission.payment_date.strftime('%Y-%m-%d') if commission.payment_date else '' }}
                            </small>
                            {% else %}
                            <span class="badge bg-warning status-badge">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ commission.created_at.strftime('%Y-%m-%d') }}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if commission.status == 'pending' and current_user.role == 'admin' %}
                                <form method="POST" action="{{ url_for('employee.pay_commission', commission_id=commission.id) }}" 
                                      style="display: inline;">
                                    <button type="submit" class="btn btn-outline-success" 
                                            onclick="return confirm('Mark this commission as paid?')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                {% endif %}
                                <button class="btn btn-outline-primary" onclick="viewCommissionDetails({{ commission.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-money-bill-wave fa-2x text-muted mb-2"></i>
                            <h5 class="text-muted">No commission records found</h5>
                            <p class="text-muted">Try adjusting your filters or calculate new commissions</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculateCommissionModal">
                                <i class="fas fa-calculator me-1"></i> Calculate Commission
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Showing {{ commissions|length }} commission records
                </small>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    Total Commission: <strong>₹{{ "%.2f"|format((total_pending|default(0)) + (total_paid|default(0))) }}</strong>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Commission by Employee Chart -->
<div class="card mt-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Commission by Employee</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <canvas id="commissionChart" height="200"></canvas>
            </div>
            <div class="col-md-4">
                <div class="mt-3">
                    {% set employee_totals = {} %}
                    {% for commission in commissions %}
                        {% set emp_name = commission.employee.username %}
                        {% if emp_name not in employee_totals %}
                            {% set _ = employee_totals.update({emp_name: 0}) %}
                        {% endif %}
                        {% set _ = employee_totals.update({emp_name: employee_totals[emp_name] + commission.commission_amount}) %}
                    {% endfor %}
                    
                    {% for emp_name, total in employee_totals.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ emp_name }}</span>
                        <span class="fw-bold">₹{{ "%.2f"|format(total) }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calculate Commission Modal -->
<div class="modal fade" id="calculateCommissionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Calculate Commission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('employee.calculate_commission') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Employee *</label>
                            <select name="employee_id" class="form-select" required>
                                <option value="">Select Employee</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.username }} ({{ emp.role|title }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Month *</label>
                            <input type="month" name="month" class="form-control" 
                                   value="{{ now.strftime('%Y-%m') }}" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Commission Type</label>
                            <select name="commission_type" class="form-select">
                                <option value="sales">Sales Commission</option>
                                <option value="repair">Repair Commission</option>
                                <option value="both">Both Sales & Repair</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" name="commission_rate" class="form-control" 
                                   step="0.1" min="0" max="100" value="5.0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="3" 
                                  placeholder="Any additional notes about this commission calculation..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will calculate commission based on sales and repair jobs for the selected month.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-calculator me-1"></i> Calculate Commission
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Commission Details Modal -->
<div class="modal fade" id="commissionDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Commission Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="commissionDetailsContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Create commission chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('commissionChart').getContext('2d');
    
    // This data would normally come from the server
    // For now, we'll create sample data
    const employeeData = {};
    
    {% for commission in commissions %}
    const empName = '{{ commission.employee.username }}';
    if (!employeeData[empName]) {
        employeeData[empName] = 0;
    }
    employeeData[empName] += {{ commission.commission_amount }};
    {% endfor %}
    
    const labels = Object.keys(employeeData);
    const data = Object.values(employeeData);
    
    if (labels.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Commission Amount (₹)',
                    data: data,
                    backgroundColor: [
                        '#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#7209b7',
                        '#560bad', '#480ca8', '#3a0ca3', '#3f37c9', '#4361ee'
                    ],
                    borderColor: [
                        '#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#7209b7',
                        '#560bad', '#480ca8', '#3a0ca3', '#3f37c9', '#4361ee'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Commission: ₹' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    } else {
        ctx.canvas.parentNode.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">No data available for chart</p>
            </div>
        `;
    }
});

// View commission details
function viewCommissionDetails(commissionId) {
    $.ajax({
        url: `/employee/commission-details/${commissionId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                document.getElementById('commissionDetailsContent').innerHTML = response.html;
                new bootstrap.Modal(document.getElementById('commissionDetailsModal')).show();
            } else {
                alert('Error loading commission details');
            }
        }
    });
}

// Pay all pending commissions
function payAllPending() {
    if (!confirm('Are you sure you want to mark all pending commissions as paid?')) {
        return;
    }
    
    const pendingCommissions = document.querySelectorAll('tr td:nth-child(7) .badge.bg-warning');
    const forms = document.querySelectorAll('form[action*="pay-commission"]');
    
    let completed = 0;
    forms.forEach((form, index) => {
        const row = form.closest('tr');
        const statusBadge = row.querySelector('td:nth-child(7) .badge');
        
        if (statusBadge && statusBadge.classList.contains('bg-warning')) {
            setTimeout(() => {
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                }).then(() => {
                    completed++;
                    statusBadge.className = 'badge bg-success status-badge';
                    statusBadge.textContent = 'Paid';
                    
                    if (completed === pendingCommissions.length) {
                        location.reload();
                    }
                });
            }, index * 100); // Stagger requests
        }
    });
}

// Export to Excel
function exportToExcel() {
    const table = document.querySelector('.commission-table');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    rows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td, th');
        
        cells.forEach(cell => {
            // Remove action buttons and status badges
            if (!cell.querySelector('button') && !cell.querySelector('.badge')) {
                rowData.push(cell.textContent.trim());
            }
        });
        
        if (rowData.length > 0) {
            csv.push(rowData.join(','));
        }
    });
    
    const csvContent = 'data:text/csv;charset=utf-8,' + csv.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `commissions_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}