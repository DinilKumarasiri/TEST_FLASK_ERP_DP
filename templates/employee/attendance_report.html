{% extends "base.html" %}

{% block title %}Attendance Report - Mobile Shop ERP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar me-2"></i>Attendance Report</h2>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print me-1"></i> Print
        </button>
        <button class="btn btn-outline-success" onclick="exportToCSV()">
            <i class="fas fa-download me-1"></i> Export
        </button>
    </div>
</div>

<!-- Month Selector -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="form-label">Select Month</label>
                <input type="month" name="month" class="form-control" 
                       value="{{ month_str }}"
                       onchange="this.form.submit()">
            </div>
            <div class="col-md-4">
                <span class="text-muted">
                    Showing {{ start_date.strftime('%B %Y') }}
                </span>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('employee.attendance') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-calendar-check me-1"></i> Back to Attendance
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">{{ attendance_data|length }}</h3>
                        <p class="mb-0">Employees</p>
                    </div>
                    <i class="fas fa-users fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% set total_present = 0 %}
                        {% for data in attendance_data %}
                            {% set total_present = total_present + data.present_days %}
                        {% endfor %}
                        <h3 class="mb-1">{{ total_present }}</h3>
                        <p class="mb-0">Present Days</p>
                    </div>
                    <i class="fas fa-user-check fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% set total_absent = 0 %}
                        {% for data in attendance_data %}
                            {% set total_absent = total_absent + data.absent_days %}
                        {% endfor %}
                        <h3 class="mb-1">{{ total_absent }}</h3>
                        <p class="mb-0">Absent Days</p>
                    </div>
                    <i class="fas fa-user-times fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% set total_hours = 0.0 %}
                        {% for data in attendance_data %}
                            {% set total_hours = total_hours + data.total_hours %}
                        {% endfor %}
                        <h3 class="mb-1">{{ "%.0f"|format(total_hours) }}</h3>
                        <p class="mb-0">Total Hours</p>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Report Table -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Attendance Details for {{ start_date.strftime('%B %Y') }}
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Role</th>
                        <th class="text-center">Present</th>
                        <th class="text-center">Absent</th>
                        <th class="text-center">Leave</th>
                        <th class="text-center">Total Hours</th>
                        <th class="text-center">Attendance %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in attendance_data %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                     style="width: 32px; height: 32px;">
                                    {{ data.employee.username[:1]|upper }}
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ data.employee.username }}</h6>
                                    <small class="text-muted">{{ data.employee.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge 
                                {% if data.employee.role == 'admin' %}bg-danger
                                {% elif data.employee.role == 'staff' %}bg-primary
                                {% elif data.employee.role == 'technician' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {{ data.employee.role|title }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ data.present_days }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">{{ data.absent_days }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">{{ data.leave_days }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ "%.1f"|format(data.total_hours) }}h</span>
                        </td>
                        <td class="text-center">
                            {% set working_days = (end_date - start_date).days + 1 %}
                            {% if working_days > 0 %}
                                {% set attendance_percentage = (data.present_days / working_days * 100) %}
                            {% else %}
                                {% set attendance_percentage = 0 %}
                            {% endif %}
                            
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                    <div class="progress-bar 
                                        {% if attendance_percentage >= 90 %}bg-success
                                        {% elif attendance_percentage >= 75 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        style="width: {{ attendance_percentage|round(1) }}%">
                                    </div>
                                </div>
                                <span style="min-width: 40px;">{{ "%.0f"|format(attendance_percentage) }}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('employee.attendance_history') }}?employee_id={{ data.employee.id }}&start_date={{ start_date.strftime('%Y-%m-%d') }}&end_date={{ end_date.strftime('%Y-%m-%d') }}" 
                                   class="btn btn-outline-primary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('employee.employee_detail', employee_id=data.employee.id) }}" 
                                   class="btn btn-outline-secondary" title="View Profile">
                                    <i class="fas fa-user"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="fas fa-users-slash fa-2x text-muted mb-2"></i>
                            <h5 class="text-muted">No attendance data found</h5>
                            <p class="text-muted">No employees or attendance records for this period</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    Period: {{ start_date.strftime('%b %d') }} - {{ end_date.strftime('%b %d, %Y') }}
                    {% set working_days = (end_date - start_date).days + 1 %}
                    ({{ working_days }} working days)
                </small>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    Generated on: {{ now.strftime('%Y-%m-%d %H:%M') }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Summary -->
<div class="card mt-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Statistics:</h6>
                <table class="table table-sm">
                    {% set total_present = 0 %}
                    {% set total_absent = 0 %}
                    {% set total_leave = 0 %}
                    {% set total_hours_sum = 0.0 %}
                    
                    {% for data in attendance_data %}
                        {% set total_present = total_present + data.present_days %}
                        {% set total_absent = total_absent + data.absent_days %}
                        {% set total_leave = total_leave + data.leave_days %}
                        {% set total_hours_sum = total_hours_sum + data.total_hours %}
                    {% endfor %}
                    
                    <tr>
                        <td>Total Employees:</td>
                        <td class="text-end">{{ attendance_data|length }}</td>
                    </tr>
                    <tr>
                        <td>Total Present Days:</td>
                        <td class="text-end">{{ total_present }}</td>
                    </tr>
                    <tr>
                        <td>Total Absent Days:</td>
                        <td class="text-end">{{ total_absent }}</td>
                    </tr>
                    <tr>
                        <td>Total Leave Days:</td>
                        <td class="text-end">{{ total_leave }}</td>
                    </tr>
                    <tr>
                        <td>Average Attendance:</td>
                        <td class="text-end">
                            {% set working_days = (end_date - start_date).days + 1 %}
                            {% if attendance_data|length > 0 and working_days > 0 %}
                                {% set avg_percentage = (total_present / (working_days * attendance_data|length) * 100) %}
                                {{ "%.1f"|format(avg_percentage) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Top Performers:</h6>
                <div class="list-group">
                    {# Sort by present_days manually #}
                    {% set sorted_data = [] %}
                    {% for data in attendance_data %}
                        {% set sorted_data = sorted_data + [data] %}
                    {% endfor %}
                    
                    {# Simple bubble sort (for small datasets) #}
                    {% for i in range(sorted_data|length) %}
                        {% for j in range(i+1, sorted_data|length) %}
                            {% if sorted_data[j].present_days > sorted_data[i].present_days %}
                                {% set temp = sorted_data[i] %}
                                {% set sorted_data = sorted_data[:i] + [sorted_data[j]] + sorted_data[i+1:j] + [temp] + sorted_data[j+1:] %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    
                    {# Show top 3 #}
                    {% for data in sorted_data[:3] %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ data.employee.username }}</strong>
                                    <div class="text-muted small">{{ data.present_days }} present days</div>
                                </div>
                                <span class="badge bg-success">
                                    {% set working_days = (end_date - start_date).days + 1 %}
                                    {% if working_days > 0 %}
                                        {{ "%.0f"|format((data.present_days / working_days * 100)) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    const table = document.getElementById('attendanceTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    rows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td, th');
        
        cells.forEach(cell => {
            // Remove action buttons
            if (!cell.querySelector('button')) {
                rowData.push(cell.textContent.trim());
            }
        });
        
        if (rowData.length > 0) {
            csv.push(rowData.join(','));
        }
    });
    
    const csvContent = 'data:text/csv;charset=utf-8,' + csv.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `attendance_report_{{ month_str }}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}