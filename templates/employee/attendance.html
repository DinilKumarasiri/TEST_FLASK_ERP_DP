{% extends "base.html" %}

{% block title %}Attendance Management - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .attendance-table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .date-picker {
        max-width: 200px;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .attendance-actions {
        min-width: 120px;
    }
    
    .employee-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4361ee, #3a0ca3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Add CSRF token -->
<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-check me-2"></i>Attendance Management</h2>
    <div>
        <a href="{{ url_for('employee.attendance_report') }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-1"></i> View Reports
        </a>
    </div>
</div>

<!-- Date Selection -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-0">Select Date:</h5>
            </div>
            <div class="col-md-4">
                <input type="date" id="datePicker" class="form-control date-picker" 
                       value="{{ selected_date.strftime('%Y-%m-%d') }}"
                       onchange="changeDate(this.value)">
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="changeDate('{{ (selected_date - timedelta(days=1)).strftime("%Y-%m-%d") }}')">
                        <i class="fas fa-chevron-left me-1"></i> Previous
                    </button>
                    <button class="btn btn-outline-secondary" onclick="changeDate('{{ now.strftime("%Y-%m-%d") }}')">
                        Today
                    </button>
                    <button class="btn btn-outline-secondary" onclick="changeDate('{{ (selected_date + timedelta(days=1)).strftime("%Y-%m-%d") }}')">
                        Next <i class="fas fa-chevron-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Table -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>
            Attendance for {{ selected_date.strftime('%A, %B %d, %Y') }}
        </h5>
        <div>
            <button class="btn btn-sm btn-success" onclick="checkInAll()" id="checkInAllBtn">
                <i class="fas fa-sign-in-alt me-1"></i> Check In All
            </button>
            <button class="btn btn-sm btn-info ms-2" onclick="checkOutAll()" id="checkOutAllBtn">
                <i class="fas fa-sign-out-alt me-1"></i> Check Out All
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 attendance-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Role</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Check In</th>
                        <th class="text-center">Check Out</th>
                        <th class="text-center">Hours</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    {% for item in employee_attendance %}
                    <tr id="row-{{ item.employee.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="employee-avatar">
                                    {{ item.employee.username[:1]|upper }}
                                </div>
                                <div class="ms-2">
                                    <h6 class="mb-0">{{ item.employee.username }}</h6>
                                    <small class="text-muted">{{ item.employee.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ item.employee.role|title }}</span>
                        </td>
                        <td class="text-center">
                            {% if item.record %}
                                {% if item.record.status == 'present' %}
                                    <span class="badge bg-success">Present</span>
                                {% elif item.record.status == 'absent' %}
                                    <span class="badge bg-danger">Absent</span>
                                {% elif item.record.status == 'half_day' %}
                                    <span class="badge bg-warning">Half Day</span>
                                {% elif item.record.status == 'leave' %}
                                    <span class="badge bg-info">On Leave</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Not Marked</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.record and item.record.check_in %}
                                <span class="badge bg-success" id="checkIn-{{ item.employee.id }}">
                                    {{ item.record.check_in.strftime('%H:%M') }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary" id="checkIn-{{ item.employee.id }}">--:--</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.record and item.record.check_out %}
                                <span class="badge bg-info" id="checkOut-{{ item.employee.id }}">
                                    {{ item.record.check_out.strftime('%H:%M') }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary" id="checkOut-{{ item.employee.id }}">--:--</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.record and item.record.total_hours %}
                                <span class="badge bg-primary" id="hours-{{ item.employee.id }}">
                                    {{ "%.1f"|format(item.record.total_hours) }}h
                                </span>
                            {% else %}
                                <span class="badge bg-secondary" id="hours-{{ item.employee.id }}">0h</span>
                            {% endif %}
                        </td>
                        <td class="text-center attendance-actions">
                            <div class="btn-group btn-group-sm">
                                {% if not item.record or not item.record.check_in %}
                                <button class="btn btn-outline-success" 
                                        onclick="checkIn({{ item.employee.id }})"
                                        title="Check In"
                                        id="btnCheckIn-{{ item.employee.id }}">
                                    <i class="fas fa-sign-in-alt"></i>
                                </button>
                                {% endif %}
                                {% if item.record and item.record.check_in and not item.record.check_out %}
                                <button class="btn btn-outline-info" 
                                        onclick="checkOut({{ item.employee.id }})"
                                        title="Check Out"
                                        id="btnCheckOut-{{ item.employee.id }}">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-warning" 
                                        onclick="editAttendance({{ item.employee.id }})"
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No active employees found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal (Simplified) -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Status:</label>
                    <select id="editStatus" class="form-select">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="leave">Leave</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Notes:</label>
                    <textarea id="editNotes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Get CSRF token
function getCSRFToken() {
    return document.getElementById('csrf_token').value;
}

// Change date
function changeDate(date) {
    window.location.href = '/employee/attendance?date=' + date;
}

// SIMPLE CHECK IN for single employee
function checkIn(employeeId) {
    console.log('Checking in employee:', employeeId);
    
    const date = document.getElementById('datePicker').value;
    const button = document.getElementById('btnCheckIn-' + employeeId);
    
    if (!button) {
        console.error('Button not found for employee:', employeeId);
        return;
    }
    
    // Show loading
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Send request
    fetch('/employee/mark-attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            employee_id: employeeId,
            action: 'check_in',
            date: date
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        if (data.success) {
            // Update UI immediately
            updateCheckInUI(employeeId);
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// SIMPLE CHECK OUT for single employee
function checkOut(employeeId) {
    console.log('Checking out employee:', employeeId);
    
    const date = document.getElementById('datePicker').value;
    const button = document.getElementById('btnCheckOut-' + employeeId);
    
    if (!button) {
        console.error('Button not found for employee:', employeeId);
        return;
    }
    
    // Show loading
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Send request
    fetch('/employee/mark-attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            employee_id: employeeId,
            action: 'check_out',
            date: date
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        if (data.success) {
            // Update UI immediately
            updateCheckOutUI(employeeId);
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Update UI after check in
function updateCheckInUI(employeeId) {
    const now = new Date();
    const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                       now.getMinutes().toString().padStart(2, '0');
    
    // Update check in time
    const checkInBadge = document.getElementById('checkIn-' + employeeId);
    if (checkInBadge) {
        checkInBadge.textContent = timeString;
        checkInBadge.className = 'badge bg-success';
    }
    
    // Remove check in button
    const checkInBtn = document.getElementById('btnCheckIn-' + employeeId);
    if (checkInBtn) {
        checkInBtn.remove();
    }
    
    // Add check out button
    const actionCell = document.querySelector('#row-' + employeeId + ' .attendance-actions .btn-group');
    if (actionCell) {
        const checkOutBtn = document.createElement('button');
        checkOutBtn.className = 'btn btn-outline-info';
        checkOutBtn.setAttribute('onclick', 'checkOut(' + employeeId + ')');
        checkOutBtn.setAttribute('title', 'Check Out');
        checkOutBtn.id = 'btnCheckOut-' + employeeId;
        checkOutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
        actionCell.appendChild(checkOutBtn);
    }
}

// Update UI after check out
function updateCheckOutUI(employeeId) {
    const now = new Date();
    const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                       now.getMinutes().toString().padStart(2, '0');
    
    // Update check out time
    const checkOutBadge = document.getElementById('checkOut-' + employeeId);
    if (checkOutBadge) {
        checkOutBadge.textContent = timeString;
        checkOutBadge.className = 'badge bg-info';
    }
    
    // Remove check out button
    const checkOutBtn = document.getElementById('btnCheckOut-' + employeeId);
    if (checkOutBtn) {
        checkOutBtn.remove();
    }
    
    // Calculate hours (simple version)
    const checkInBadge = document.getElementById('checkIn-' + employeeId);
    const hoursBadge = document.getElementById('hours-' + employeeId);
    
    if (checkInBadge && hoursBadge && checkInBadge.textContent !== '--:--') {
        const checkInTime = checkInBadge.textContent;
        const checkOutTime = timeString;
        
        const [inHour, inMin] = checkInTime.split(':').map(Number);
        const [outHour, outMin] = checkOutTime.split(':').map(Number);
        
        const inTotal = inHour + inMin/60;
        const outTotal = outHour + outMin/60;
        
        let hours = outTotal - inTotal;
        if (hours < 0) hours += 24; // Handle overnight
        
        hoursBadge.textContent = hours.toFixed(1) + 'h';
        hoursBadge.className = 'badge bg-primary';
    }
}

// CHECK IN ALL - Simple version
function checkInAll() {
    if (!confirm('Check in all employees?')) return;
    
    const date = document.getElementById('datePicker').value;
    const checkInButtons = document.querySelectorAll('button[onclick^="checkIn("]');
    
    if (checkInButtons.length === 0) {
        alert('No employees need to check in.');
        return;
    }
    
    const button = document.getElementById('checkInAllBtn');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    button.disabled = true;
    
    // Process each button one by one
    let processed = 0;
    
    checkInButtons.forEach((btn, index) => {
        setTimeout(() => {
            // Extract employee ID from onclick attribute
            const onclickText = btn.getAttribute('onclick');
            const match = onclickText.match(/checkIn\((\d+)\)/);
            
            if (match && match[1]) {
                const employeeId = parseInt(match[1]);
                
                fetch('/employee/mark-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        action: 'check_in',
                        date: date
                    })
                })
                .then(response => response.json())
                .then(data => {
                    processed++;
                    
                    if (data.success) {
                        updateCheckInUI(employeeId);
                    }
                    
                    if (processed === checkInButtons.length) {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                        alert('Check in completed for ' + processed + ' employees.');
                    }
                })
                .catch(error => {
                    processed++;
                    console.error('Error:', error);
                    
                    if (processed === checkInButtons.length) {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                        alert('Completed with some errors.');
                    }
                });
            } else {
                processed++;
            }
        }, index * 500); // 500ms delay between requests
    });
}

// CHECK OUT ALL - Simple version
function checkOutAll() {
    if (!confirm('Check out all employees?')) return;
    
    const date = document.getElementById('datePicker').value;
    const checkOutButtons = document.querySelectorAll('button[onclick^="checkOut("]');
    
    if (checkOutButtons.length === 0) {
        alert('No employees need to check out.');
        return;
    }
    
    const button = document.getElementById('checkOutAllBtn');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
    button.disabled = true;
    
    // Process each button one by one
    let processed = 0;
    
    checkOutButtons.forEach((btn, index) => {
        setTimeout(() => {
            // Extract employee ID from onclick attribute
            const onclickText = btn.getAttribute('onclick');
            const match = onclickText.match(/checkOut\((\d+)\)/);
            
            if (match && match[1]) {
                const employeeId = parseInt(match[1]);
                
                fetch('/employee/mark-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        action: 'check_out',
                        date: date
                    })
                })
                .then(response => response.json())
                .then(data => {
                    processed++;
                    
                    if (data.success) {
                        updateCheckOutUI(employeeId);
                    }
                    
                    if (processed === checkOutButtons.length) {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                        alert('Check out completed for ' + processed + ' employees.');
                    }
                })
                .catch(error => {
                    processed++;
                    console.error('Error:', error);
                    
                    if (processed === checkOutButtons.length) {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                        alert('Completed with some errors.');
                    }
                });
            } else {
                processed++;
            }
        }, index * 500); // 500ms delay between requests
    });
}

// Edit attendance (placeholder)
function editAttendance(employeeId) {
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

// Save edit (placeholder)
function saveEdit() {
    alert('Edit feature would save changes here');
    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    modal.hide();
}

// Debug: Test if functions are loaded
console.log('Attendance script loaded');

// Add this function to convert UTC times to Sri Lanka time
function formatSriLankaTime(utcDateTime) {
    if (!utcDateTime) return '--:--';
    
    const date = new Date(utcDateTime);
    // Sri Lanka is UTC+5:30
    const sriLankaOffset = 5.5 * 60 * 60 * 1000;
    const sriLankaTime = new Date(date.getTime() + sriLankaOffset);
    
    return sriLankaTime.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

// Update the attendance table to use Sri Lanka time
function updateAttendanceTimes() {
    // This would be called after loading attendance data
    // You need to update your server-side code to send Sri Lanka times
}
</script>
{% endblock %}