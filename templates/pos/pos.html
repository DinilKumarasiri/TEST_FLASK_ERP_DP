{% extends "base.html" %}

{% block title %}POS Terminal - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    /* Base Styles */
    .pos-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        min-height: calc(100vh - 150px);
    }
    
    /* Mobile First Approach */
    .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .product-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        overflow-y: auto;
        padding: 10px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-height: 60vh;
    }
    
    .cart-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        height: fit-content;
        max-height: 80vh;
    }
    
    /* Product Cards */
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
        background: white;
    }
    
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: var(--primary-color);
    }
    
    .product-card:active {
        transform: translateY(0);
    }
    
    .product-card.highlight {
        background-color: rgba(40, 167, 69, 0.15) !important;
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    }
    
    /* Cart Styles */
    .cart-items {
        flex: 1;
        overflow-y: auto;
        margin: 15px 0;
        max-height: 300px;
        min-height: 200px;
    }
    
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .quantity-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cart-total {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    /* Barcode Input */
    .barcode-input {
        font-size: 1.1rem;
        padding: 12px;
        text-align: center;
        letter-spacing: 2px;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: border-color 0.3s;
        font-family: 'Courier New', monospace;
    }
    
    .barcode-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .barcode-input.scanning {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { border-color: #28a745; }
        50% { border-color: #20c997; }
        100% { border-color: #28a745; }
    }
    
    /* Category Filters */
    .category-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .category-btn {
        padding: 6px 12px;
        font-size: 0.9rem;
        white-space: nowrap;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* Checkout Button */
    .checkout-btn {
        padding: 12px 20px;
        font-size: 1.1rem;
    }
    
    /* Customer Info */
    .customer-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    /* Empty States */
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.3;
    }
    
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(2px);
    }
    
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9998;
    }
    
    /* Barcode Badge */
    .barcode-badge {
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 2px 6px;
        margin-top: 3px;
    }
    
    /* Tablet Styles (768px and up) */
    @media (min-width: 768px) {
        .pos-container {
            height: calc(100vh - 150px);
        }
        
        .main-grid {
            grid-template-columns: 1.5fr 1fr;
            height: 100%;
        }
        
        .product-grid {
            max-height: calc(100vh - 250px);
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }
        
        .cart-items {
            max-height: calc(100vh - 400px);
        }
        
        .barcode-input {
            font-size: 1.2rem;
        }
    }
    
    /* Desktop Styles (992px and up) */
    @media (min-width: 992px) {
        .main-grid {
            grid-template-columns: 2fr 1fr;
        }
        
        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            padding: 15px 10px;
            min-height: 140px;
        }
        
        .category-btn {
            padding: 8px 16px;
            font-size: 1rem;
        }
    }
    
    /* Small Mobile Styles (max-width: 576px) */
    @media (max-width: 576px) {
        .pos-container {
            min-height: calc(100vh - 120px);
        }
        
        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 8px;
        }
        
        .product-card {
            padding: 10px 6px;
            min-height: 110px;
        }
        
        .cart-section {
            padding: 15px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .barcode-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        .cart-total {
            font-size: 1.3rem;
        }
        
        .quantity-btn {
            width: 24px;
            height: 24px;
        }
    }
    
    /* Touch-friendly adjustments */
    @media (hover: none) and (pointer: coarse) {
        .product-card:hover {
            transform: none;
            box-shadow: none;
        }
        
        .product-card:active {
            background-color: #f8f9fa;
            transform: scale(0.98);
        }
        
        .btn {
            padding: 10px 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF Token for AJAX -->
<input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing...</p>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2 class="mb-0"><i class="fas fa-cash-register me-2"></i>POS Terminal</h2>
    <div class="action-buttons">
        <button class="btn btn-outline-danger" onclick="clearCart()">
            <i class="fas fa-trash me-1"></i>Clear
        </button>
        <button class="btn btn-success" onclick="openCheckoutModal()">
            <i class="fas fa-credit-card me-1"></i>Checkout
        </button>
    </div>
</div>

<div class="pos-container">
    <div class="main-grid">
        <!-- Product Section -->
        <div class="product-section">
            <!-- Barcode Scanner Input -->
            <div class="mb-3">
                <input type="text" 
                       id="barcodeInput" 
                       class="form-control barcode-input" 
                       placeholder="ðŸ“± Scan Barcode or Enter IMEI"
                       autofocus
                       autocapitalize="none"
                       autocomplete="off"
                       spellcheck="false"
                       inputmode="text">
                <div class="form-text text-end mt-1">
                    <small><i class="fas fa-lightbulb me-1"></i> Press Enter after scanning or typing</small>
                </div>
            </div>
            
            <!-- Category Filters -->
            <div class="category-filters">
                <button type="button" 
                        class="btn btn-outline-primary category-btn active" 
                        data-category="all"
                        onclick="filterProducts('all')">
                    All
                </button>
                {% for category in categories %}
                <button type="button" 
                        class="btn btn-outline-primary category-btn" 
                        data-category="{{ category.id }}"
                        onclick="filterProducts('{{ category.id }}')">
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>
            
            <!-- Product Grid -->
            <div class="product-grid" id="productGrid">
                {% for product in products %}
                <div class="product-card" 
                     data-product-id="{{ product.id }}" 
                     data-category="{{ product.category_id if product.category_id else 'all' }}"
                     data-product-sku="{{ product.sku }}"
                     data-product-name="{{ product.name }}"
                     onclick="addProductToCart('{{ product.id }}')"
                     title="Click to add {{ product.name }} to cart">
                    <h6 class="product-name mb-1">{{ product.name }}</h6>
                    <small class="text-muted d-block mb-1">{{ product.sku }}</small>
                    {% if product.barcode %}
                    <small class="barcode-badge">{{ product.barcode|truncate(10) }}</small>
                    {% endif %}
                    <div class="mt-2">
                        <strong class="text-primary">Rs.{{ "%.2f"|format(product.selling_price) }}</strong>
                    </div>
                    {% if product.has_imei %}
                    <small class="text-info mt-1"><i class="fas fa-barcode"></i> IMEI</small>
                    {% endif %}
                    {% set stock_count = namespace(value=0) %}
                    {% for stock in product.stock_items if stock.status == 'available' %}
                        {% set stock_count.value = stock_count.value + 1 %}
                    {% endfor %}
                    <div class="mt-1">
                        {% if stock_count.value == 0 %}
                        <small class="text-danger"><i class="fas fa-times-circle"></i> Out of Stock</small>
                        {% elif stock_count.value <= 5 %}
                        <small class="text-warning"><i class="fas fa-exclamation-triangle"></i> {{ stock_count.value }} left</small>
                        {% else %}
                        <small class="text-success"><i class="fas fa-check-circle"></i> In Stock</small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="cart-section">
            <h4 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shopping-cart me-2"></i>Cart</span>
                <span id="cartCount" class="badge bg-primary rounded-pill">0</span>
            </h4>
            
            <div class="cart-items" id="cartItems">
                <div class="empty-cart" id="emptyCart">
                    <i class="fas fa-shopping-cart"></i>
                    <p class="mb-0">Your cart is empty</p>
                    <small class="text-muted">Scan or tap products to add</small>
                </div>
            </div>
            
            <div class="cart-summary mt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (15%):</span>
                    <span id="cartTax">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Discount:</span>
                    <span id="cartDiscount">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between cart-total mb-3">
                    <span>Total:</span>
                    <span id="cartTotal">Rs.0.00</span>
                </div>
                
                <!-- Customer Search -->
                <div class="mb-3">
                    <label class="form-label">Customer Phone</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        <input type="tel" 
                               id="customerPhone" 
                               class="form-control" 
                               placeholder="Enter phone number"
                               inputmode="tel"
                               onchange="findCustomer()">
                        <button class="btn btn-outline-primary" type="button" onclick="findCustomer()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="customerInfo" class="customer-info mt-2" style="display: none;">
                        <small class="d-block">
                            <i class="fas fa-user me-1"></i>
                            <span id="customerName"></span>
                        </small>
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-phone me-1"></i>
                            <span id="customerPhoneDisplay"></span>
                        </small>
                    </div>
                </div>
                
                <!-- Process Payment Button -->
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg checkout-btn" onclick="openCheckoutModal()">
                        <i class="fas fa-credit-card me-2"></i>Process Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Complete Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="checkoutModalBody">
                <!-- Checkout form will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading checkout form...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let cart = {};
let customer = null;
let isProcessing = false;
let barcodeScanner = null;

// CSRF Token handling
function getCsrfToken() {
    // Try multiple ways to get CSRF token
    let csrfToken = $('#csrf_token').val();
    if (csrfToken) {
        return csrfToken;
    }
    
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        csrfToken = metaTag.getAttribute('content');
        return csrfToken;
    }
    
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput) {
        csrfToken = csrfInput.value;
        return csrfToken;
    }
    
    console.warn('CSRF token not found');
    return '';
}

// Initialize
$(document).ready(function() {
    console.log('POS Terminal initialized');
    
    // Focus on barcode input
    setTimeout(() => {
        $('#barcodeInput').focus();
    }, 100);
    
    // Load initial cart
    loadCart();
    
    // Setup barcode scanner
    setupBarcodeScanner();
    
    // Setup keyboard shortcuts
    setupKeyboardShortcuts();
    
    // Check for existing barcode scanner
    checkForBarcodeScanner();
});

// Setup barcode scanner functionality
function setupBarcodeScanner() {
    const barcodeInput = $('#barcodeInput');
    let barcodeBuffer = '';
    let lastKeyTime = 0;
    const SCANNER_TIMEOUT = 100; // milliseconds
    
    // Handle keydown events (for scanner detection)
    barcodeInput.on('keydown', function(e) {
        const currentTime = new Date().getTime();
        
        // If Enter is pressed, process the barcode
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = $(this).val().trim();
            if (barcode) {
                processBarcode(barcode);
                $(this).val('');
            }
            barcodeBuffer = '';
            return;
        }
        
        // Handle scanner input (fast typing)
        if (currentTime - lastKeyTime > SCANNER_TIMEOUT) {
            barcodeBuffer = ''; // Reset buffer if too slow (manual typing)
        }
        
        lastKeyTime = currentTime;
        
        // Skip special keys
        if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
            barcodeBuffer += e.key;
        }
    });
    
    // Handle keyup for scanner detection
    barcodeInput.on('keyup', function(e) {
        // Skip Enter key
        if (e.key === 'Enter') return;
        
        const currentTime = new Date().getTime();
        
        // If scanner finished (pause after fast input)
        if (barcodeBuffer.length > 0 && currentTime - lastKeyTime > SCANNER_TIMEOUT) {
            if (barcodeBuffer.length >= 8) { // Minimum barcode length
                console.log('Scanner detected barcode:', barcodeBuffer);
                processBarcode(barcodeBuffer);
                $(this).val('');
                barcodeBuffer = '';
            }
        }
    });
    
    // Handle paste event
    barcodeInput.on('paste', function(e) {
        setTimeout(() => {
            const barcode = $(this).val().trim();
            if (barcode && barcode.length >= 3) {
                processBarcode(barcode);
                $(this).val('');
            }
        }, 10);
    });
    
    // Add scanning animation
    barcodeInput.on('focus', function() {
        $(this).addClass('scanning');
    });
    
    barcodeInput.on('blur', function() {
        $(this).removeClass('scanning');
    });
}

function setupKeyboardShortcuts() {
    $(document).on('keydown', function(e) {
        // Escape to focus barcode input
        if (e.key === 'Escape') {
            e.preventDefault();
            $('#barcodeInput').focus().select();
        }
        // Ctrl+K to focus barcode input
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            $('#barcodeInput').focus().select();
        }
        // Ctrl+L to clear cart
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            clearCart();
        }
        // F2 to open checkout
        if (e.key === 'F2') {
            e.preventDefault();
            openCheckoutModal();
        }
    });
}

function checkForBarcodeScanner() {
    // Check if QuaggaJS or other scanner is available
    if (typeof Quagga !== 'undefined') {
        console.log('QuaggaJS barcode scanner detected');
        initQuaggaScanner();
    }
}

function initQuaggaScanner() {
    // Optional: Initialize QuaggaJS if needed
    // This is for advanced barcode scanner support
}

// Process barcode
function processBarcode(barcode) {
    if (isProcessing) {
        showToast('Please wait, processing previous request...', 'warning');
        return;
    }
    
    if (!barcode || barcode.trim() === '') {
        showToast('Please enter a barcode', 'warning');
        return;
    }
    
    console.log('Processing barcode:', barcode);
    showLoading(true);
    isProcessing = true;
    
    // Add scanning effect to input
    $('#barcodeInput').addClass('scanning');
    
    $.ajax({
        url: '/pos/scan-product',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ barcode: barcode }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Scan response:', response);
            
            if (response.success && response.product) {
                // Check if this is a specific stock item
                const stockItemId = response.product.stock_item_id;
                const productId = response.product.id;
                
                if (stockItemId) {
                    // Add specific stock item to cart
                    addProductToCartWithStockItem(productId, 1, stockItemId, barcode);
                } else {
                    // Add regular product to cart
                    addProductToCart(productId, 1);
                }
            } else {
                showToast(response.message || 'Product not found', 'error');
                // Try manual search in product grid
                searchProductInGrid(barcode);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error scanning product:', error, xhr.responseText);
            
            let errorMsg = 'Error scanning product';
            if (xhr.status === 401) {
                errorMsg = 'Session expired. Please login again.';
            } else if (xhr.status === 403) {
                errorMsg = 'Security error. Please refresh the page.';
            } else if (xhr.status === 404) {
                errorMsg = 'Product not found.';
            }
            
            showToast(errorMsg, 'error');
        },
        complete: function() {
            showLoading(false);
            isProcessing = false;
            $('#barcodeInput').removeClass('scanning');
            setTimeout(() => {
                $('#barcodeInput').focus();
            }, 100);
        }
    });
}

// Add product to cart
function addProductToCart(productId, quantity) {
    if (isProcessing) return;
    
    console.log('Adding product to cart:', productId, quantity);
    showLoading(true);
    isProcessing = true;
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', quantity || 1);
    
    $.ajax({
        url: '/pos/add-to-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Add to cart response:', response);
            
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                
                // Show success message
                const productName = response.product_added?.name || 'Product';
                const qty = response.product_added?.quantity || 1;
                showToast(`âœ“ Added ${qty} Ã— ${productName} to cart`, 'success');
                
                // Highlight the product card
                highlightProductCard(productId);
            } else {
                showToast(response.message || 'Error adding to cart', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error adding to cart:', error, xhr.responseText);
            
            let errorMsg = 'Error adding to cart';
            if (xhr.status === 400) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch (e) {
                    // Keep default message
                }
            } else if (xhr.status === 404) {
                errorMsg = 'Product not found';
            }
            
            showToast(errorMsg, 'error');
        },
        complete: function() {
            showLoading(false);
            isProcessing = false;
        }
    });
}

// Add product with specific stock item
function addProductToCartWithStockItem(productId, quantity, stockItemId, barcode) {
    if (isProcessing) return;
    
    console.log('Adding product with stock item:', {productId, quantity, stockItemId, barcode});
    showLoading(true);
    isProcessing = true;
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', quantity || 1);
    formData.append('stock_item_id', stockItemId);
    
    $.ajax({
        url: '/pos/add-to-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Add to cart with stock item response:', response);
            
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                
                const productName = response.product_added?.name || 'Product';
                const qty = response.product_added?.quantity || 1;
                showToast(`âœ“ Added ${qty} Ã— ${productName} (Barcode: ${barcode})`, 'success');
                
                highlightProductCard(productId);
            } else {
                showToast(response.message || 'Error adding to cart', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error adding to cart with stock item:', error, xhr.responseText);
            showToast('Error adding specific item to cart', 'error');
        },
        complete: function() {
            showLoading(false);
            isProcessing = false;
        }
    });
}

// Search product in grid manually
function searchProductInGrid(barcode) {
    const searchTerm = barcode.toLowerCase().trim();
    let foundProduct = null;
    let foundProductName = '';
    
    $('.product-card').each(function() {
        const productSku = $(this).data('product-sku')?.toString().toLowerCase() || '';
        const productName = $(this).data('product-name')?.toString().toLowerCase() || '';
        
        if (productSku.includes(searchTerm) || productName.includes(searchTerm)) {
            foundProduct = $(this).data('product-id');
            foundProductName = $(this).data('product-name');
            return false; // Break loop
        }
    });
    
    if (foundProduct) {
        if (confirm(`Found product "${foundProductName}" matching "${barcode}". Add to cart?`)) {
            addProductToCart(foundProduct, 1);
        }
    } else {
        showToast(`No product found for "${barcode}"`, 'warning');
        // Ask if user wants to search by barcode in products table
        if (confirm('Product not found. Search in all products?')) {
            searchAllProducts(barcode);
        }
    }
}

// Search all products by barcode
function searchAllProducts(barcode) {
    showLoading(true);
    
    // This would require a new endpoint to search products by barcode
    $.ajax({
        url: '/pos/search-product',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ search: barcode }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success && response.products && response.products.length > 0) {
                // Show products in a modal or dropdown
                showProductSearchResults(response.products, barcode);
            } else {
                showToast('No products found with that barcode', 'warning');
            }
        },
        error: function() {
            showToast('Error searching products', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

function showProductSearchResults(products, barcode) {
    // Create a modal to show search results
    const modalHtml = `
        <div class="modal fade" id="searchResultsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Search Results for "${barcode}"</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>SKU</th>
                                        <th>Barcode</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(product => `
                                        <tr>
                                            <td>${product.name}</td>
                                            <td>${product.sku}</td>
                                            <td>${product.barcode || '-'}</td>
                                            <td>Rs.${product.selling_price}</td>
                                            <td>${product.stock_available}</td>
                                            <td>
                                                <button class="btn btn-sm btn-success" onclick="addProductToCart(${product.id}, 1); $('#searchResultsModal').modal('hide');">
                                                    Add to Cart
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    $('#searchResultsModal').remove();
    
    // Add modal to body
    $('body').append(modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
    modal.show();
}

// Highlight product card when added
function highlightProductCard(productId) {
    const productCard = $(`.product-card[data-product-id="${productId}"]`);
    if (productCard.length) {
        productCard.addClass('highlight');
        setTimeout(() => {
            productCard.removeClass('highlight');
        }, 1000);
    }
}

// Load cart from server
function loadCart() {
    $.ajax({
        url: '/pos/get-cart',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
            }
        },
        error: function() {
            console.log('Error loading cart');
        }
    });
}

// Update cart display
function updateCartDisplay() {
    const cartItemsContainer = $('#cartItems');
    const emptyCart = $('#emptyCart');
    const cartCount = Object.keys(cart).length;
    
    $('#cartCount').text(cartCount);
    
    if (cartCount === 0) {
        emptyCart.show();
        cartItemsContainer.html('');
        updateCartTotals(0, 0, 0, 0);
        return;
    }
    
    emptyCart.hide();
    cartItemsContainer.html('');
    
    let subtotal = 0;
    
    for (const productKey in cart) {
        const item = cart[productKey];
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        // Check if this is a specific stock item
        const hasStockItem = item.stock_item_barcode ? true : false;
        
        const cartItem = `
            <div class="cart-item">
                <div class="flex-grow-1">
                    <h6 class="mb-1 text-truncate">${item.name}</h6>
                    <small class="text-muted">Rs.${item.price.toFixed(2)} each</small>
                    ${hasStockItem ? `<br><small class="text-info"><i class="fas fa-barcode"></i> ${item.stock_item_barcode}</small>` : ''}
                </div>
                <div class="cart-item-controls">
                    <div class="quantity-control">
                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                onclick="updateCartItem('${productKey}', ${item.quantity - 1})"
                                aria-label="Decrease quantity">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity-display px-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                onclick="updateCartItem('${productKey}', ${item.quantity + 1})"
                                aria-label="Increase quantity">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="text-end ms-2" style="min-width: 70px;">
                        <div class="fw-bold">Rs.${itemTotal.toFixed(2)}</div>
                        <button class="btn btn-sm btn-link text-danger p-0" 
                                onclick="removeFromCart('${productKey}')"
                                aria-label="Remove item">
                            <small><i class="fas fa-trash"></i> Remove</small>
                        </button>
                    </div>
                </div>
            </div>
        `;
        cartItemsContainer.append(cartItem);
    }
    
    const tax = subtotal * 0.15;
    const discount = 0;
    const total = subtotal + tax - discount;
    
    updateCartTotals(subtotal, tax, discount, total);
}

// Update cart totals
function updateCartTotals(subtotal, tax, discount, total) {
    $('#cartSubtotal').text('Rs.' + subtotal.toFixed(2));
    $('#cartTax').text('Rs.' + tax.toFixed(2));
    $('#cartDiscount').text('Rs.' + discount.toFixed(2));
    $('#cartTotal').text('Rs.' + total.toFixed(2));
}

// Update cart item quantity
function updateCartItem(productKey, quantity) {
    if (quantity < 1) {
        removeFromCart(productKey);
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    formData.append('product_key', productKey);
    formData.append('quantity', quantity);
    
    $.ajax({
        url: '/pos/update-cart-item',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                showToast('Cart updated', 'success');
            } else {
                showToast(response.message || 'Error updating cart', 'error');
            }
        },
        error: function() {
            showToast('Error updating cart', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Remove item from cart
function removeFromCart(productKey) {
    if (!confirm('Remove this item from cart?')) {
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    formData.append('product_key', productKey);
    
    $.ajax({
        url: '/pos/remove-from-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                loadCart();
                showToast('Item removed from cart', 'success');
            } else {
                showToast(response.message || 'Error removing item', 'error');
            }
        },
        error: function() {
            showToast('Error removing item', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Clear entire cart
function clearCart() {
    if (Object.keys(cart).length === 0) {
        showToast('Cart is already empty', 'info');
        return;
    }
    
    if (!confirm('Clear all items from cart?')) {
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    
    $.ajax({
        url: '/pos/clear-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                cart = {};
                updateCartDisplay();
                showToast('Cart cleared successfully', 'success');
            } else {
                showToast(response.message || 'Error clearing cart', 'error');
            }
        },
        error: function() {
            showToast('Error clearing cart', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Find customer by phone
function findCustomer() {
    const phone = $('#customerPhone').val().trim();
    if (!phone || phone.length < 10) {
        showToast('Please enter a valid phone number (10+ digits)', 'warning');
        return;
    }
    
    showLoading(true);
    
    $.ajax({
        url: '/pos/find-customer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ phone: phone }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success && response.customer) {
                customer = response.customer;
                $('#customerName').text(customer.name);
                $('#customerPhoneDisplay').text(customer.phone);
                $('#customerInfo').show();
                showToast('Customer found!', 'success');
            } else {
                $('#customerInfo').hide();
                if (confirm('Customer not found. Create new customer?')) {
                    createCustomer(phone);
                }
            }
        },
        error: function() {
            showToast('Error finding customer', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Create new customer
function createCustomer(phone) {
    const name = prompt('Enter customer name:');
    if (!name || name.trim() === '') {
        showToast('Customer name is required', 'error');
        return;
    }
    
    const email = prompt('Enter email (optional):') || '';
    const address = prompt('Enter address (optional):') || '';
    
    showLoading(true);
    
    $.ajax({
        url: '/pos/create-customer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: name.trim(),
            phone: phone.trim(),
            email: email.trim(),
            address: address.trim()
        }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success && response.customer) {
                customer = response.customer;
                $('#customerName').text(customer.name);
                $('#customerPhoneDisplay').text(customer.phone);
                $('#customerInfo').show();
                $('#customerPhone').val(phone);
                showToast('Customer created successfully!', 'success');
            } else {
                showToast(response.message || 'Error creating customer', 'error');
            }
        },
        error: function() {
            showToast('Error creating customer', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Open checkout modal
function openCheckoutModal() {
    if (Object.keys(cart).length === 0) {
        showToast('Cart is empty. Add some products first.', 'warning');
        return;
    }
    
    // Show loading in modal
    $('#checkoutModalBody').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading checkout form...</p>
        </div>
    `);
    
    // Show modal
    const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    checkoutModal.show();
    
    // Load checkout form
    $.ajax({
        url: '/pos/checkout-form',
        method: 'GET',
        success: function(html) {
            $('#checkoutModalBody').html(html);
            
            // Set customer data if available
            if (customer) {
                $('#customerId').val(customer.id);
                $('#customerNameInput').val(customer.name);
                $('#customerPhoneInput').val(customer.phone);
            }
        },
        error: function() {
            $('#checkoutModalBody').html(`
                <div class="alert alert-danger">
                    <h5>Failed to load checkout form</h5>
                    <p>Please try again or contact support if the problem persists.</p>
                    <button class="btn btn-outline-secondary" onclick="openCheckoutModal()">
                        <i class="fas fa-redo me-1"></i>Retry
                    </button>
                </div>
            `);
        }
    });
}

// Filter products by category
function filterProducts(categoryId) {
    // Update active button
    $('.category-btn').removeClass('active');
    $(`.category-btn[data-category="${categoryId}"]`).addClass('active');
    
    if (categoryId === 'all') {
        $('.product-card').show();
    } else {
        $('.product-card').hide();
        $(`.product-card[data-category="${categoryId}"]`).show();
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type} text-white">
                <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    $('#toastContainer').append(toastHtml);
    
    // Initialize and show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove after hide
    toastElement.addEventListener('hidden.bs.toast', function () {
        $(this).remove();
    });
}

// Show/hide loading overlay
function showLoading(show = true) {
    if (show) {
        $('#loadingOverlay').show();
        $('body').css('overflow', 'hidden');
    } else {
        $('#loadingOverlay').hide();
        $('body').css('overflow', 'auto');
    }
}

// For manual product click (used in product card onclick)
window.addProductToCart = function(productId) {
    addProductToCart(productId, 1);
};

// Expose functions for HTML onclick handlers
window.updateCartItem = updateCartItem;
window.removeFromCart = removeFromCart;
window.clearCart = clearCart;
window.filterProducts = filterProducts;

// Prevent accidental page close with items in cart
window.addEventListener('beforeunload', function(e) {
    if (Object.keys(cart).length > 0) {
        e.preventDefault();
        e.returnValue = 'You have items in your cart. Are you sure you want to leave?';
    }
});

// Auto-refresh cart periodically (for multi-tab sync)
setInterval(() => {
    if (!document.hidden && Object.keys(cart).length > 0) {
        loadCart();
    }
}, 30000); // Every 30 seconds

// Handle page visibility change
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Page became visible, refresh cart
        loadCart();
    }
});

// Test barcode scanning
window.testBarcodeScan = function(barcode) {
    $('#barcodeInput').val(barcode);
    processBarcode(barcode);
};
</script>
{% endblock %}