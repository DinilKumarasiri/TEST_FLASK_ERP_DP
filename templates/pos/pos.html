{% extends "base.html" %}

{% block title %}POS Terminal - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    /* Base Styles */
    .pos-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        min-height: calc(100vh - 150px);
    }
    
    /* Mobile First Approach */
    .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .product-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        overflow-y: auto;
        padding: 10px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-height: 60vh;
    }
    
    .cart-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        height: fit-content;
        max-height: 80vh;
    }
    
    /* Product Cards */
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
        background: white;
    }
    
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: var(--primary-color);
    }
    
    .product-card:active {
        transform: translateY(0);
    }
    
    /* Cart Styles */
    .cart-items {
        flex: 1;
        overflow-y: auto;
        margin: 15px 0;
        max-height: 300px;
        min-height: 200px;
    }
    
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .quantity-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cart-total {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    /* Barcode Input */
    .barcode-input {
        font-size: 1.1rem;
        padding: 12px;
        text-align: center;
        letter-spacing: 2px;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: border-color 0.3s;
    }
    
    .barcode-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* Barcode list styling */
    .barcode-list {
        max-height: 120px;
        overflow-y: auto;
        padding: 5px 0 5px 15px;
        margin-top: 5px;
        border-left: 2px solid #dee2e6;
    }

    .barcode-list small {
        display: block;
        padding: 2px 0;
        line-height: 1.4;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
    }

    /* Make cart items scrollable if too many */
    .cart-items {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .cart-items::-webkit-scrollbar {
        width: 6px;
    }

    .cart-items::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .cart-items::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .cart-items::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Category Filters */
    .category-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .category-btn {
        padding: 6px 12px;
        font-size: 0.9rem;
        white-space: nowrap;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* Checkout Button */
    .checkout-btn {
        padding: 12px 20px;
        font-size: 1.1rem;
    }
    
    /* Customer Info */
    .customer-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    /* Empty States */
    .empty-cart {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.3;
    }
    
    /* Stock Status */
    .stock-available {
        color: #28a745;
        font-weight: bold;
    }
    
    .stock-low {
        color: #ffc107;
        font-weight: bold;
    }
    
    .stock-out {
        color: #dc3545;
        font-weight: bold;
    }
    
    /* Specific Item Indicator */
    .specific-item {
        background-color: rgba(13, 110, 253, 0.05);
        border-left: 3px solid #0d6efd;
    }
    
    .specific-item-indicator {
        background-color: #0d6efd;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        margin-left: 5px;
    }
    
    /* Tablet Styles (768px and up) */
    @media (min-width: 768px) {
        .pos-container {
            height: calc(100vh - 150px);
        }
        
        .main-grid {
            grid-template-columns: 1.5fr 1fr;
            height: 100%;
        }
        
        .product-grid {
            max-height: calc(100vh - 250px);
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }
        
        .cart-items {
            max-height: calc(100vh - 400px);
        }
        
        .barcode-input {
            font-size: 1.2rem;
        }
    }
    
    /* Desktop Styles (992px and up) */
    @media (min-width: 992px) {
        .main-grid {
            grid-template-columns: 2fr 1fr;
        }
        
        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            padding: 15px 10px;
            min-height: 140px;
        }
        
        .category-btn {
            padding: 8px 16px;
            font-size: 1rem;
        }
    }
    
    /* Large Desktop Styles (1200px and up) */
    @media (min-width: 1200px) {
        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
        
        .product-card {
            padding: 20px 15px;
            min-height: 150px;
        }
    }
    
    /* Small Mobile Styles (max-width: 576px) */
    @media (max-width: 576px) {
        .pos-container {
            min-height: calc(100vh - 120px);
        }
        
        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 8px;
        }
        
        .product-card {
            padding: 10px 6px;
            min-height: 110px;
        }
        
        .cart-section {
            padding: 15px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .barcode-input {
            font-size: 1rem;
            padding: 10px;
        }
        
        .cart-total {
            font-size: 1.3rem;
        }
        
        .quantity-btn {
            width: 24px;
            height: 24px;
        }
    }
    
    /* Modal Responsive */
    @media (max-width: 768px) {
        .modal-dialog {
            margin: 10px;
        }
    }
    
    /* Touch-friendly adjustments */
    @media (hover: none) and (pointer: coarse) {
        .product-card:hover {
            transform: none;
            box-shadow: none;
        }
        
        .product-card:active {
            background-color: #f8f9fa;
            transform: scale(0.98);
        }
        
        .btn {
            padding: 10px 16px;
        }
    }
    
    /* Landscape Mode for Mobile */
    @media (max-height: 600px) and (orientation: landscape) {
        .pos-container {
            min-height: auto;
        }
        
        .product-grid {
            max-height: 50vh;
        }
        
        .cart-items {
            max-height: 150px;
        }
    }
    
    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    /* Alert Styles */
    .alert-fixed {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9998;
        max-width: 400px;
    }
    
    /* Debug Panel */
    .debug-panel {
        position: fixed;
        bottom: 10px;
        left: 10px;
        z-index: 9997;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF Token for AJAX -->
<input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing...</p>
    </div>
</div>

<!-- Fixed Alert Container -->
<div id="alertContainer" class="alert-fixed"></div>

<!-- Debug Panel (Visible only in development) -->
{% if config.DEBUG %}
<div class="debug-panel" style="display: none;" id="debugPanel">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Debug Info</strong>
        <button class="btn btn-sm btn-light" onclick="$('#debugPanel').hide()">Ã—</button>
    </div>
    <div class="mb-1">CSRF: <span id="debugCsrf"></span></div>
    <div class="mb-1">Cart Items: <span id="debugCartCount">0</span></div>
    <button class="btn btn-sm btn-warning btn-block mt-2" onclick="testAjax()">Test AJAX</button>
</div>
<button class="btn btn-sm btn-info" style="position: fixed; bottom: 10px; left: 10px; z-index: 9996;" 
        onclick="$('#debugPanel').toggle()">Debug</button>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2 class="mb-0"><i class="fas fa-cash-register me-2"></i>POS Terminal</h2>
    <div class="action-buttons">
        <button class="btn btn-outline-secondary" onclick="loadCart()">
            <i class="fas fa-sync me-1"></i>Refresh
        </button>
        <button class="btn btn-outline-danger" onclick="clearCart()">
            <i class="fas fa-trash me-1"></i>Clear Cart
        </button>
        <button class="btn btn-success" onclick="openCheckoutModal()">
            <i class="fas fa-credit-card me-1"></i>Checkout
        </button>
    </div>
</div>

<div class="pos-container">
    <div class="main-grid">
        <!-- Product Section -->
        <div class="product-section">
            <!-- Barcode Scanner Input -->
            <div class="mb-3">
                <input type="text" 
                       id="barcodeInput" 
                       class="form-control barcode-input" 
                       placeholder="ðŸ“± Scan Barcode or Enter IMEI"
                       autofocus
                       autocapitalize="none"
                       autocomplete="off"
                       onkeypress="handleBarcodeEnter(event)">
                <div class="form-text text-end mt-1">
                    <small>Press Enter or Scan to add product</small>
                </div>
            </div>
            
            <!-- Category Filters -->
            <div class="category-filters">
                <button type="button" 
                        class="btn btn-outline-primary category-btn active" 
                        data-category="all"
                        onclick="filterProducts('all')">
                    All
                </button>
                {% for category in categories %}
                <button type="button" 
                        class="btn btn-outline-primary category-btn" 
                        data-category="{{ category.id }}"
                        onclick="filterProducts({{ category.id }})">
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>
            
            <!-- Product Grid -->
            <div class="product-grid" id="productGrid">
            {% for product in products %}
            {% set stock_count = product.stock_items|selectattr('status', 'equalto', 'available')|list|length %}
            <div class="product-card" 
                data-product-id="{{ product.id }}" 
                data-category="{{ product.category_id if product.category_id else 'all' }}"
                onclick="addToCart({{ product.id }})"
                data-product-name="{{ product.name }}"
                data-has-imei="{{ product.has_imei }}"
                data-sku="{{ product.sku }}"
                data-barcode="{{ product.barcode }}"
                data-stock="{{ stock_count }}">
                <h6 class="product-name mb-1">{{ product.name }}</h6>
                <small class="text-muted d-block mb-1">{{ product.sku }}</small>
                <div class="mt-2">
                    <strong class="text-primary">Rs.{{ "%.2f"|format(product.selling_price) }}</strong>
                </div>
                <div class="mt-1">
                    {% if stock_count > 5 %}
                    <small class="stock-available">
                        <i class="fas fa-box"></i> {{ stock_count }} in stock
                    </small>
                    {% elif stock_count > 0 %}
                    <small class="stock-low">
                        <i class="fas fa-exclamation-triangle"></i> Low stock: {{ stock_count }}
                    </small>
                    {% else %}
                    <small class="stock-out">
                        <i class="fas fa-times-circle"></i> Out of stock
                    </small>
                    {% endif %}
                </div>
                {% if product.has_imei %}
                <small class="text-info mt-1">
                    <i class="fas fa-barcode"></i> Serialized
                </small>
                {% endif %}
            </div>
            {% endfor %}
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="cart-section">
            <h4 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shopping-cart me-2"></i>Cart</span>
                <span id="cartCount" class="badge bg-primary rounded-pill">0</span>
            </h4>
            
            <div class="cart-items" id="cartItems">
                <div class="empty-cart" id="emptyCart">
                    <i class="fas fa-shopping-cart"></i>
                    <p class="mb-0">Your cart is empty</p>
                    <small class="text-muted">Scan or tap products to add</small>
                </div>
            </div>
            
            <div class="cart-summary mt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax (15%):</span>
                    <span id="cartTax">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Discount:</span>
                    <span id="cartDiscount">Rs.0.00</span>
                </div>
                <div class="d-flex justify-content-between cart-total mb-3">
                    <span>Total:</span>
                    <span id="cartTotal">Rs.0.00</span>
                </div>
                
                <!-- Customer Search -->
                <div class="mb-3">
                    <label class="form-label">Customer Phone</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        <input type="tel" 
                               id="customerPhone" 
                               class="form-control" 
                               placeholder="Enter phone number"
                               inputmode="tel"
                               onchange="findCustomer()">
                        <button class="btn btn-outline-primary" onclick="findCustomer()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="customerInfo" class="customer-info mt-2" style="display: none;">
                        <small class="d-block">
                            <i class="fas fa-user me-1"></i>
                            <span id="customerName"></span>
                        </small>
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-phone me-1"></i>
                            <span id="customerPhoneDisplay"></span>
                        </small>
                    </div>
                </div>
                
                <!-- Process Payment Button -->
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg checkout-btn" onclick="openCheckoutModal()" id="checkoutButton">
                        <i class="fas fa-credit-card me-2"></i>Process Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Complete Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="checkoutModalBody">
                <!-- Checkout form will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading checkout form...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal for Errors -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle">Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalBody">
                <!-- Alert message will go here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let cart = {};
let customer = null;
let isProcessing = false;

// CSRF Token handling
function getCsrfToken() {
    let csrfToken = $('#csrf_token').val();
    if (csrfToken) {
        return csrfToken;
    }
    
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        csrfToken = metaTag.getAttribute('content');
        return csrfToken;
    }
    
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput) {
        csrfToken = csrfInput.value;
        return csrfToken;
    }
    
    console.warn('CSRF token not found');
    return '';
}

// Show alert modal
function showAlertModal(title, message) {
    $('#alertModalTitle').text(title);
    $('#alertModalBody').html(message);
    $('#alertModal').modal('show');
}

// Show toast notification
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        </div>
    `;
    
    $('body').append(toastHtml);
    
    setTimeout(() => {
        $(`#${toastId}`).remove();
    }, 5000);
}

// Show/hide loading overlay
function showLoading(show = true) {
    if (show) {
        $('#loadingOverlay').show();
        isProcessing = true;
    } else {
        $('#loadingOverlay').hide();
        isProcessing = false;
    }
}

// Initialize
$(document).ready(function() {
    console.log('POS Terminal initialized');
    
    // Load initial cart
    loadCart();
    
    // Focus on barcode input
    setTimeout(() => {
        $('#barcodeInput').focus();
    }, 100);
});

// Handle barcode input enter key
function handleBarcodeEnter(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const barcode = $('#barcodeInput').val().trim();
        if (barcode.length > 0) {
            scanProduct(barcode);
        }
    }
}

// Filter products by category
function filterProducts(categoryId) {
    $('.category-btn').removeClass('active');
    $(`.category-btn[data-category="${categoryId}"]`).addClass('active');
    
    if (categoryId === 'all') {
        $('.product-card').show();
    } else {
        $('.product-card').hide();
        $(`.product-card[data-category="${categoryId}"]`).show();
    }
}

// Scan product barcode
function scanProduct(barcode) {
    if (!barcode || isProcessing) return;
    
    console.log('Scanning barcode:', barcode);
    showLoading(true);
    
    $.ajax({
        url: '/pos/scan-product',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ barcode: barcode }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Scan response:', response);
            
            if (response.success && response.product) {
                const product = response.product;
                
                // Check if the response says it's already in cart
                if (response.message && response.message.includes('already in your cart')) {
                    showToast(response.message, 'warning');
                    showLoading(false);
                    $('#barcodeInput').val('').focus();
                    return;
                }
                
                // Create FormData with product info
                const formData = new FormData();
                formData.append('product_id', product.id);
                formData.append('quantity', 1);
                
                // Add stock_item_id if it's a specific item
                if (product.stock_item_id) {
                    formData.append('stock_item_id', product.stock_item_id);
                    console.log('Adding specific stock item:', product.stock_item_id);
                }
                
                // Add to cart
                $.ajax({
                    url: '/pos/add-to-cart',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(addResponse) {
                        console.log('Add to cart response:', addResponse);
                        if (addResponse.success) {
                            cart = addResponse.cart || {};
                            updateCartDisplay();
                            
                            let message = `âœ“ ${product.name} added to cart`;
                            if (product.stock_item_barcode) {
                                message += ` (Serial: ${product.stock_item_barcode})`;
                            }
                            
                            showToast(message, 'success');
                        } else {
                            showToast(addResponse.message || 'Failed to add to cart', 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Add to cart error:', error);
                        showToast('Error adding to cart', 'error');
                    },
                    complete: function() {
                        showLoading(false);
                        $('#barcodeInput').val('').focus();
                    }
                });
                
            } else {
                showToast(response.message || 'Product not found', 'warning');
                showLoading(false);
                $('#barcodeInput').val('').focus();
            }
        },
        error: function(xhr, status, error) {
            console.error('Scan error:', error);
            showToast('Error scanning barcode', 'error');
            showLoading(false);
            $('#barcodeInput').val('').focus();
        }
    });
}

// Add product to cart by clicking
function addToCart(productId) {
    if (isProcessing) return;
    
    console.log('Adding to cart product ID:', productId);
    showLoading(true);
    
    // Get product details
    const productCard = $(`.product-card[data-product-id="${productId}"]`);
    const productName = productCard.data('product-name');
    const hasImei = productCard.data('has-imei') === 'True';
    
    if (hasImei) {
        showAlertModal('Serialized Product', 
            `${productName} requires serialization. Please scan each item's barcode/IMEI individually.`);
        showLoading(false);
        return;
    }
    
    // Create FormData
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', 1);
    
    $.ajax({
        url: '/pos/add-to-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Add to cart response:', response);
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                
                // Highlight the product
                productCard.addClass('bg-success bg-opacity-10');
                setTimeout(() => {
                    productCard.removeClass('bg-success bg-opacity-10');
                }, 1000);
                
                showToast(`âœ“ ${productName} added to cart`, 'success');
            } else {
                showToast(response.message || 'Error adding to cart', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error adding to cart:', error);
            showToast('Error adding to cart', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Load cart from server
function loadCart() {
    if (isProcessing) return;
    
    $.ajax({
        url: '/pos/get-cart',
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Load cart response:', response);
            cart = response.cart || {};
            updateCartDisplay();
        },
        error: function(xhr, status, error) {
            console.error('Error loading cart:', error);
            cart = {};
            updateCartDisplay();
        }
    });
}

// Update cart display
function updateCartDisplay() {
    const cartItems = $('#cartItems');
    const emptyCart = $('#emptyCart');
    const checkoutButton = $('#checkoutButton');
    
    if (Object.keys(cart).length === 0) {
        emptyCart.show();
        cartItems.html('');
        $('#cartCount').text('0');
        $('#cartSubtotal').text('Rs.0.00');
        $('#cartTax').text('Rs.0.00');
        $('#cartDiscount').text('Rs.0.00');
        $('#cartTotal').text('Rs.0.00');
        checkoutButton.prop('disabled', true).addClass('btn-secondary').removeClass('btn-primary');
        document.title = 'POS Terminal - Mobile Shop ERP';
        return;
    }
    
    emptyCart.hide();
    cartItems.empty();
    
    let itemCount = 0;
    let subtotal = 0;
    
    for (const productKey in cart) {
        const item = cart[productKey];
        itemCount += item.quantity;
        subtotal += item.price * item.quantity;
        
        // Get barcodes
        let barcodesList = item.barcodes || [];
        
        // Create barcode HTML
        let barcodeHtml = '';
        
        if (barcodesList.length > 0) {
            if (item.quantity === 1) {
                barcodeHtml = `<small class="text-info d-block"><i class="fas fa-barcode"></i> ${barcodesList[0]}</small>`;
            } else {
                barcodeHtml = `
                    <div class="mt-1">
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-barcode"></i> ${item.quantity} items:
                        </small>
                        <div class="barcode-list">
                `;
                
                // Show first 5 barcodes
                const maxToShow = 5;
                if (barcodesList.length > maxToShow) {
                    for (let i = 0; i < maxToShow; i++) {
                        barcodeHtml += `<small class="text-info d-block">${i + 1}. ${barcodesList[i]}</small>`;
                    }
                    barcodeHtml += `<small class="text-muted d-block">... and ${barcodesList.length - maxToShow} more</small>`;
                } else {
                    barcodesList.forEach((barcode, index) => {
                        barcodeHtml += `<small class="text-info d-block">${index + 1}. ${barcode}</small>`;
                    });
                }
                
                barcodeHtml += `</div></div>`;
            }
        }
        
        // Check if it's a specific item
        const isSpecificItem = item.is_specific_item || item.stock_item_id;
        const itemClass = isSpecificItem ? 'specific-item' : '';
        
        const cartItem = `
            <div class="cart-item ${itemClass}">
                <div class="flex-grow-1">
                    <h6 class="mb-1 text-truncate">
                        ${item.name}
                        ${isSpecificItem ? '<span class="specific-item-indicator">Serialized</span>' : ''}
                    </h6>
                    <small class="text-muted">Rs.${item.price.toFixed(2)} each</small>
                    ${barcodeHtml}
                </div>
                <div class="cart-item-controls">
                    <div class="quantity-control">
                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                onclick="updateCartItem('${productKey}', ${item.quantity - 1})">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity-display px-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                onclick="updateCartItem('${productKey}', ${item.quantity + 1})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="text-end ms-2" style="min-width: 70px;">
                        <div class="fw-bold">Rs.${(item.price * item.quantity).toFixed(2)}</div>
                        <button class="btn btn-sm btn-link text-danger p-0" 
                                onclick="removeFromCart('${productKey}')">
                            <small><i class="fas fa-trash"></i> Remove</small>
                        </button>
                    </div>
                </div>
            </div>
        `;
        cartItems.append(cartItem);
    }
    
    const tax = subtotal * 0.15;
    const discount = 0;
    const total = subtotal + tax - discount;
    
    $('#cartCount').text(itemCount);
    $('#cartSubtotal').text('Rs.' + subtotal.toFixed(2));
    $('#cartTax').text('Rs.' + tax.toFixed(2));
    $('#cartDiscount').text('Rs.' + discount.toFixed(2));
    $('#cartTotal').text('Rs.' + total.toFixed(2));
    checkoutButton.prop('disabled', false).removeClass('btn-secondary').addClass('btn-primary');
    document.title = `(${itemCount}) POS Terminal - Mobile Shop ERP`;
}

// Update cart item quantity
function updateCartItem(productKey, newQuantity) {
    if (isProcessing) return;
    
    const item = cart[productKey];
    if (!item) return;
    
    if (newQuantity < 1) {
        removeFromCart(productKey);
        return;
    }
    
    // Don't allow changing quantity for specific items
    if (item.is_specific_item || item.stock_item_id) {
        showToast('Cannot change quantity of serialized items', 'warning');
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    formData.append('product_key', productKey);
    formData.append('quantity', newQuantity);
    
    $.ajax({
        url: '/pos/update-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                
                if (newQuantity > item.quantity) {
                    showToast(`Increased ${item.name} quantity to ${newQuantity}`, 'success');
                } else if (newQuantity < item.quantity) {
                    showToast(`Decreased ${item.name} quantity to ${newQuantity}`, 'info');
                }
            } else {
                showToast(response.message || 'Error updating quantity', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error updating cart:', error);
            showToast('Error updating quantity', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Remove item from cart
function removeFromCart(productKey) {
    if (isProcessing) return;
    
    const itemName = cart[productKey] ? cart[productKey].name : 'this item';
    
    if (!confirm(`Remove ${itemName} from cart?`)) {
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    formData.append('product_key', productKey);
    
    $.ajax({
        url: '/pos/remove-from-cart/' + encodeURIComponent(productKey),
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                cart = response.cart || {};
                updateCartDisplay();
                showToast(`${itemName} removed from cart`, 'info');
            } else {
                showToast(response.message || 'Error removing item', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error removing from cart:', error);
            showToast('Error removing item', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Clear entire cart
function clearCart() {
    if (isProcessing) return;
    
    if (Object.keys(cart).length === 0) {
        showToast('Cart is already empty', 'info');
        return;
    }
    
    if (!confirm('Clear all items from cart?')) {
        return;
    }
    
    showLoading(true);
    
    const formData = new FormData();
    
    $.ajax({
        url: '/pos/clear-cart',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                cart = {};
                updateCartDisplay();
                showToast('Cart cleared successfully', 'success');
            } else {
                showToast(response.message || 'Error clearing cart', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error clearing cart:', error);
            showToast('Error clearing cart', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Find customer by phone
function findCustomer() {
    if (isProcessing) return;
    
    const phone = $('#customerPhone').val().trim();
    if (!phone || phone.length < 10) {
        showToast('Please enter a valid phone number (10+ digits)', 'warning');
        return;
    }
    
    showLoading(true);
    
    $.ajax({
        url: '/pos/find-customer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ phone: phone }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                customer = response.customer;
                $('#customerName').text(customer.name);
                $('#customerPhoneDisplay').text(customer.phone);
                $('#customerInfo').show();
                showToast('Customer found!', 'success');
            } else {
                $('#customerInfo').hide();
                if (confirm('Customer not found. Create new customer?')) {
                    createCustomer(phone);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error finding customer:', error);
            showToast('Error finding customer', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Create new customer
function createCustomer(phone) {
    const name = prompt('Enter customer name:');
    if (!name) return;
    
    const email = prompt('Enter email (optional):');
    const address = prompt('Enter address (optional):');
    
    if (!name.trim()) {
        showToast('Customer name is required', 'error');
        return;
    }
    
    showLoading(true);
    
    $.ajax({
        url: '/pos/create-customer',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: name.trim(),
            phone: phone.trim(),
            email: (email || '').trim(),
            address: (address || '').trim()
        }),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                customer = response.customer;
                $('#customerName').text(customer.name);
                $('#customerPhoneDisplay').text(customer.phone);
                $('#customerInfo').show();
                $('#customerPhone').val(phone);
                showToast('Customer created successfully!', 'success');
            } else {
                showToast(response.message || 'Error creating customer', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error creating customer:', error);
            showToast('Error creating customer', 'error');
        },
        complete: function() {
            showLoading(false);
        }
    });
}

// Open checkout modal
function openCheckoutModal() {
    if (isProcessing) return;
    
    if (Object.keys(cart).length === 0) {
        showToast('Cart is empty. Add some products first.', 'warning');
        return;
    }
    
    // Show loading in modal
    $('#checkoutModalBody').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading checkout form...</p>
        </div>
    `);
    
    // Show modal
    const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    checkoutModal.show();
    
    // Load checkout form
    $.ajax({
        url: '/pos/checkout-form',
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(html) {
            $('#checkoutModalBody').html(html);
            
            // Set customer data if available
            if (customer) {
                $('#customerId').val(customer.id);
                $('#customerNameInput').val(customer.name);
                $('#customerPhoneInput').val(customer.phone);
            }
            
            // Populate checkout items
            loadCheckoutItems();
            
            // Setup payment method change handler
            $('#paymentMethod').on('change', function() {
                if (this.value === 'card' || this.value === 'bank_transfer' || this.value === 'digital_wallet') {
                    $('#paymentReferenceField').show();
                    $('#paymentReference').prop('required', true);
                } else {
                    $('#paymentReferenceField').hide();
                    $('#paymentReference').prop('required', false);
                }
            });
            
            // Setup checkout form submission
            $('#checkoutForm').on('submit', function(e) {
                e.preventDefault();
                processCheckout();
            });
        },
        error: function(xhr, status, error) {
            console.error('Error loading checkout form:', error);
            $('#checkoutModalBody').html(`
                <div class="alert alert-danger">
                    <h5>Failed to load checkout form</h5>
                    <p>Please try again or contact support if the problem persists.</p>
                    <button class="btn btn-outline-secondary" onclick="openCheckoutModal()">
                        <i class="fas fa-redo me-1"></i>Retry
                    </button>
                </div>
            `);
        }
    });
}

// Load items into checkout form
function loadCheckoutItems() {
    const itemsContainer = $('#checkoutItems');
    if (!itemsContainer.length) return;
    
    itemsContainer.empty();
    
    let subtotal = 0;
    
    for (const productKey in cart) {
        const item = cart[productKey];
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        const row = `
            <tr>
                <td>${item.name}</td>
                <td>Rs.${item.price.toFixed(2)}</td>
                <td>${item.quantity}</td>
                <td>Rs.${itemTotal.toFixed(2)}</td>
            </tr>
        `;
        itemsContainer.append(row);
    }
    
    const tax = subtotal * 0.15;
    const discount = parseFloat($('#discount').val()) || 0;
    const total = subtotal + tax - discount;
    
    $('#checkoutSubtotal').text('Rs.' + subtotal.toFixed(2));
    $('#checkoutTax').text('Rs.' + tax.toFixed(2));
    $('#checkoutTotal').text('Rs.' + total.toFixed(2));
}

// Calculate checkout total when discount changes
function calculateCheckoutTotal() {
    loadCheckoutItems();
}

// Process checkout
function processCheckout() {
    const form = $('#checkoutForm')[0];
    const formData = new FormData(form);
    
    // Add tax rate
    formData.append('tax_rate', 0.15);
    
    // Disable submit button
    const submitBtn = $('button[type="submit"]');
    submitBtn.prop('disabled', true).html(
        '<i class="fas fa-spinner fa-spin me-1"></i>Processing...'
    );
    
    // Convert FormData to object for JSON
    const formDataObj = {};
    for (let [key, value] of formData.entries()) {
        formDataObj[key] = value;
    }
    
    console.log('Checkout form data:', formDataObj);
    
    $.ajax({
        url: '/pos/checkout',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formDataObj),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log('Checkout success response:', response);
            
            if (response.success) {
                // Close modal
                $('#checkoutModal').modal('hide');
                
                // Show success message
                showToast(`Sale completed! Invoice: ${response.invoice_number}`, 'success');
                
                // Clear cart
                cart = {};
                updateCartDisplay();
                
                // Open receipt for printing
                setTimeout(() => {
                    const printWindow = window.open(`/pos/invoice/${response.invoice_id}/print`, '_blank');
                    
                    if (!printWindow || printWindow.closed || typeof printWindow.closed == 'undefined') {
                        window.location.href = `/pos/invoice/${response.invoice_id}/receipt`;
                    }
                    
                    $('#barcodeInput').focus();
                }, 500);
                
            } else {
                showToast(response.message || 'Checkout failed', 'error');
                submitBtn.prop('disabled', false).html(
                    '<i class="fas fa-check-circle me-1"></i>Complete Sale'
                );
            }
        },
        error: function(xhr, status, error) {
            console.error('Error during checkout:', error, xhr.responseText);
            showToast('Error completing sale. Please try again.', 'error');
            submitBtn.prop('disabled', false).html(
                '<i class="fas fa-check-circle me-1"></i>Complete Sale'
            );
        }
    });
}

// Prevent accidental page refresh/close with items in cart
window.addEventListener('beforeunload', function(e) {
    if (Object.keys(cart).length > 0) {
        e.preventDefault();
        e.returnValue = 'You have items in your cart. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Auto-refresh cart every 30 seconds
setInterval(() => {
    if (!document.hidden && Object.keys(cart).length > 0) {
        loadCart();
    }
}, 30000);

// Test function for debugging
function testAjax() {
    console.log('Testing AJAX connection...');
    
    $.ajax({
        url: '/pos/get-cart',
        method: 'GET',
        success: function(response) {
            console.log('Test successful:', response);
            showToast('AJAX connection test successful!', 'success');
        },
        error: function(xhr, status, error) {
            console.error('Test failed:', error, xhr.responseText);
            showToast('AJAX connection test failed: ' + error, 'error');
        }
    });
}

// Expose functions for debugging
window.testAjax = testAjax;
window.getCsrfToken = getCsrfToken;
</script>
{% endblock %}