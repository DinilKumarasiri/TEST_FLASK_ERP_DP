{% extends "base.html" %}

{% block title %}Products - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    /* Grid View Styles */
    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s;
        height: 100%;
    }
    
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }
    
    .stock-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
    
    .low-stock {
        border-left: 4px solid #dc3545;
    }
    
    .normal-stock {
        border-left: 4px solid #28a745;
    }
    
    .price-tag {
        font-size: 1.2rem;
        font-weight: bold;
        color: #198754;
    }
    
    /* Full View Styles */
    .table-view {
        font-size: 0.9rem;
    }
    
    .table-view th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table-view td {
        vertical-align: middle;
    }
    
    .product-image-cell {
        width: 60px;
    }
    
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 4px;
    }
    
    .action-buttons {
        min-width: 120px;
    }
    
    /* View Toggle */
    .view-toggle .btn.active {
        background-color: #0d6efd;
        color: white;
    }
    
    /* Category Modal Styles */
    .category-modal .modal-dialog {
        max-width: 500px;
    }
    
    /* Toast Styles */
    .toast-container {
        z-index: 9999;
    }
    
    /* Live Search Styles */
    .search-container {
        position: relative;
    }
    
    .search-loading {
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
    }
    
    .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6c757d;
        z-index: 10;
        background: none;
        border: none;
        padding: 5px;
    }
    
    .clear-search:hover {
        color: #dc3545;
    }
    
    #productsTableBody tr {
        transition: all 0.3s ease;
    }
    
    #productsTableBody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    /* Highlight search terms */
    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
    
    /* Search result count */
    .result-count {
        font-size: 0.85rem;
        margin-top: 5px;
        color: #6c757d;
    }
    
    /* Loading overlay */
    .table-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-boxes me-2"></i>Products</h2>
    <div>
        <a href="{{ url_for('inventory.add_new_product') }}" class="btn btn-primary me-2">
            <i class="fas fa-plus me-1"></i> Add New Product
        </a>
        <a href="{{ url_for('inventory.stock_in') }}" class="btn btn-primary me-2">
            <i class="fas fa-plus me-1"></i> Add Stock
        </a>
        <!-- Add Category Button -->
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-tag me-1"></i> Add Category
        </button>
    </div>
</div>

<!-- Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3" id="searchForm">
            <div class="col-md-4">
                <div class="search-container">
                    <input type="text" name="search" id="searchInput" class="form-control" 
                           placeholder="Search by name, SKU or description" 
                           value="{{ request.args.get('search', '') }}">
                    <div class="search-loading d-none" id="searchLoading">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    {% if request.args.get('search') %}
                    <button type="button" class="clear-search" id="clearSearchBtn" title="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="result-count" id="resultCount"></div>
            </div>
            
            <div class="col-md-3">
                <select name="category_id" id="categorySelect" class="form-select">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if request.args.get('category_id')|int == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <select name="stock_status" id="stockStatusSelect" class="form-select">
                    <option value="">All Stock Status</option>
                    <option value="low" {% if request.args.get('stock_status') == 'low' %}selected{% endif %}>Low Stock</option>
                    <option value="out" {% if request.args.get('stock_status') == 'out' %}selected{% endif %}>Out of Stock</option>
                    <option value="available" {% if request.args.get('stock_status') == 'available' %}selected{% endif %}>In Stock</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="button" class="btn btn-outline-secondary me-2" id="resetBtn">
                        <i class="fas fa-redo me-1"></i> Reset
                    </button>
                    <a href="{{ url_for('inventory.export_products', **request.args) }}" 
                       class="btn btn-outline-success">
                        <i class="fas fa-file-export"></i> Export
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- View Controls and Stats -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted" id="productCountText">
                    {% if not request.args.get('view') or request.args.get('view') == 'full' %}
                        Showing {{ products.items|length }} of {{ products.total }} products
                        {% if request.args.get('search') %}
                        for "{{ request.args.get('search') }}"
                        {% endif %}
                    {% else %}
                        {{ products.total }} products
                    {% endif %}
                </small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div class="view-toggle btn-group">
                    {% set grid_args = {} %}
                    {% for key, value in request.args.items() %}
                        {% if key != 'view' %}
                            {% set _ = grid_args.update({key: value}) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% set full_args = grid_args.copy() %}
                    {% set _ = full_args.update({'view': 'full'}) %}
                    
                    {% set grid_view_args = grid_args.copy() %}
                    {% set _ = grid_view_args.update({'view': 'grid'}) %}
                    
                    <!-- Full View Button -->
                    <a href="{{ url_for('inventory.product_list', **full_args) }}" 
                       class="btn btn-outline-primary {% if not request.args.get('view') or request.args.get('view') == 'full' %}active{% endif %}">
                        <i class="fas fa-list"></i> Full View
                    </a>
                    
                    <!-- Grid View Button -->
                    <a href="{{ url_for('inventory.product_list', **grid_view_args) }}" 
                       class="btn btn-outline-primary {% if request.args.get('view') == 'grid' %}active{% endif %}">
                        <i class="fas fa-th-large"></i> Grid View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== DEFAULT TO FULL VIEW ==================== -->
{% if not request.args.get('view') or request.args.get('view') == 'full' %}
<!-- ==================== FULL VIEW (TABLE LAYOUT) ==================== -->
<div class="card position-relative">
    <div class="card-body p-0">
        <div class="table-responsive position-relative">
            <div class="table-loading-overlay d-none" id="tableLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <table class="table table-striped table-hover table-view mb-0">
                <thead>
                    <tr>
                        <th width="50">ID</th>
                        <th>Product Name</th>
                        <th width="120">SKU</th>
                        <th width="120">Category</th>
                        <th width="100" class="text-end">Purchase Price</th>
                        <th width="100" class="text-end">Selling Price</th>
                        <th width="100" class="text-center">Current Stock</th>
                        <th width="80" class="text-center">Min Stock</th>
                        <th width="100" class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    {% for product in products.items %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>
                            <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}" 
                            class="text-decoration-none">
                                <strong>{{ product.name }}</strong>
                            </a>
                            {% if product.description %}
                            <br>
                            <small class="text-muted">{{ product.description|truncate(50) }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <code>{{ product.sku }}</code>
                            {% if product.has_imei %}
                            <br>
                            <span class="badge bg-info badge-sm">IMEI Tracking</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.category %}
                                <span class="badge bg-secondary">{{ product.category.name }}</span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if product.purchase_price is not none %}
                                Rs.{{ "%.2f"|format(product.purchase_price) }}
                            {% else %}
                                Rs.-
                            {% endif %}
                        </td>
                        <td class="text-end">Rs.{{ "%.2f"|format(product.selling_price) }}</td>
                        <td class="text-center">
                            <span class="badge bg-{{ 'success' if product.stock_count > product.min_stock_level else 'danger' }}">
                                {{ product.stock_count }}
                            </span>
                        </td>
                        <td class="text-center">{{ product.min_stock_level }}</td>
                        <td class="text-center">
                            <span class="badge bg-{{ 'success' if product.is_active else 'danger' }}">
                                {{ 'Active' if product.is_active else 'Inactive' }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                            <p class="mb-0 text-muted">No products found</p>
                            <small class="text-muted">Try adjusting your search criteria</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Full View Pagination -->
{% if products.pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not products.has_prev %}disabled{% endif %}">
            <a class="page-link" 
               href="{{ url_for('inventory.product_list', page=products.prev_num, view='full', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        
        {% for page_num in products.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == products.page %}active{% endif %}">
                    <a class="page-link" 
                       href="{{ url_for('inventory.product_list', page=page_num, view='full', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}
        
        <li class="page-item {% if not products.has_next %}disabled{% endif %}">
            <a class="page-link" 
               href="{{ url_for('inventory.product_list', page=products.next_num, view='full', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    </ul>
</nav>
{% endif %}

{% elif request.args.get('view') == 'grid' %}
<!-- ==================== GRID VIEW (CARD LAYOUT) ==================== -->
<div class="row">
    {% for product in products.items %}
    <div class="col-md-4 mb-4">
        <div class="card product-card {% if product.stock_count <= product.min_stock_level %}low-stock{% else %}normal-stock{% endif %}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">{{ product.name }}</h5>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-barcode me-1"></i> {{ product.sku }}
                        </p>
                    </div>
                    <div class="text-end">
                        {% if product.category %}
                            <span class="badge bg-secondary">{{ product.category.name }}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if product.description %}
                <p class="mb-3">{{ product.description|truncate(80) }}</p>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted d-block">Current Stock</small>
                        <h4 class="mb-0">
                            <span class="badge bg-{% if product.stock_count <= product.min_stock_level %}danger{% else %}success{% endif %} stock-badge">
                                {{ product.stock_count }}
                            </span>
                        </h4>
                        <small class="text-muted">Min: {{ product.min_stock_level }}</small>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted d-block">Selling Price</small>
                        <div class="price-tag">Rs.{{ "%.2f"|format(product.selling_price) }}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted d-block">Cost Price</small>
                    <small>
                        {% if product.purchase_price is not none %}
                            Rs.{{ "%.2f"|format(product.purchase_price) }}
                        {% else %}
                            Rs.-
                        {% endif %}
                    </small>
                    {% if product.has_imei %}
                    <span class="badge bg-info ms-2">IMEI Tracking</span>
                    {% endif %}
                </div>
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i> View Details
                    </a>
                    <a href="{{ url_for('inventory.edit_product', product_id=product.id) }}" 
                    class="btn btn-outline-warning">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('inventory.stock_in') }}?product_id={{ product.id }}" 
                           class="btn btn-outline-success">
                            <i class="fas fa-plus me-1"></i> Stock In
                        </a>
                        {% if product.stock_count > 0 %}
                        <button class="btn btn-outline-warning" 
                                onclick="showStockOutModal({{ product.id }})">
                            <i class="fas fa-minus me-1"></i> Stock Out
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No products found</h5>
                <p class="text-muted">Try adjusting your search criteria</p>
                <a href="{{ url_for('inventory.stock_in') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Add First Product
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Grid View Pagination -->
{% if products.pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if products.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('inventory.product_list', page=products.prev_num, view='grid', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for page_num in products.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == products.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('inventory.product_list', page=page_num, view='grid', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if products.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('inventory.product_list', page=products.next_num, view='grid', search=request.args.get('search', ''), category_id=request.args.get('category_id', ''), stock_status=request.args.get('stock_status', '')) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% endif %}

<!-- Stock Out Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stock Out</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="stockOutForm" method="POST" action="{{ url_for('inventory.stock_out') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div id="stockOutProductInfo" class="mb-3">
                        <!-- Product info will be inserted here -->
                    </div>
                    
                    <input type="hidden" name="product_id" id="stockOutProductId">
                    
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" name="quantity" id="stockOutQuantity" 
                               class="form-control" min="1" value="1" required>
                        <small class="text-muted" id="availableStockText"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <select name="reason" class="form-select" required>
                            <option value="sale">Sale to Customer</option>
                            <option value="damaged">Damaged/Defective</option>
                            <option value="return">Return to Supplier</option>
                            <option value="transfer">Transfer to Other Store</option>
                            <option value="sample">Sample/Display</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Confirm Stock Out</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade category-modal" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">
                    <i class="fas fa-tag me-2"></i>Add New Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('inventory.add_category') }}" id="addCategoryForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="redirect_to" value="products">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="categoryName" name="name" 
                               placeholder="e.g., Mobile Phones, Accessories, Repair Parts" required>
                        <div class="form-text">Enter a descriptive category name for your products.</div>
                        <div class="invalid-feedback" id="categoryNameError">Please enter a category name.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" name="description" 
                                  rows="3" placeholder="Optional description of this category..."></textarea>
                        <div class="form-text">Optional: Add a description to help identify this category.</div>
                    </div>
                    
                    <!-- Category Preview -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title mb-2"><i class="fas fa-eye me-1"></i>Preview</h6>
                            <p class="mb-1"><strong>Name:</strong> <span id="previewName" class="text-muted">[Enter name]</span></p>
                            <p class="mb-0"><strong>Description:</strong> <span id="previewDescription" class="text-muted">[Optional]</span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitCategoryBtn">
                        <i class="fas fa-plus me-1"></i> Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
{% endblock %}

{% block extra_js %}
<script>
// Live search functionality
let searchTimeout;
let currentSearch = '';
let currentCategory = '';
let currentStockStatus = '';
let isLiveSearching = false;

// Function to perform live search
function performLiveSearch() {
    const search = $('#searchInput').val();
    const category = $('#categorySelect').val();
    const stockStatus = $('#stockStatusSelect').val();
    
    // Only search if something changed
    if (search === currentSearch && 
        category === currentCategory && 
        stockStatus === currentStockStatus) {
        return;
    }
    
    // Update current values
    currentSearch = search;
    currentCategory = category;
    currentStockStatus = stockStatus;
    
    // Show loading state
    $('#tableLoading').removeClass('d-none');
    $('#searchLoading').removeClass('d-none');
    isLiveSearching = true;
    
    // Build query parameters
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (category) params.append('category_id', category);
    if (stockStatus) params.append('stock_status', stockStatus);
    
    // Make AJAX request
    $.ajax({
        url: '/inventory/api/products/search-live?' + params.toString(),
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#productsTableBody').html(response.html);
                
                // Update count display
                let countText = '';
                if (response.count === 0) {
                    countText = 'No products found';
                } else if (response.count === 1) {
                    countText = 'Found 1 product';
                } else {
                    countText = `Found ${response.count} products`;
                }
                
                // Add search terms to count
                if (search) {
                    countText += ` for "${search}"`;
                }
                if (category && category !== '') {
                    const categoryName = $('#categorySelect option:selected').text();
                    countText += ` in ${categoryName}`;
                }
                if (stockStatus && stockStatus !== '') {
                    const statusMap = {
                        'low': 'Low Stock',
                        'out': 'Out of Stock',
                        'available': 'In Stock'
                    };
                    countText += ` (${statusMap[stockStatus]})`;
                }
                
                $('#resultCount').text(countText);
                $('#productCountText').text(countText);
                
                // Show/hide clear button
                if (search || category || stockStatus) {
                    if (!$('#clearSearchBtn').length) {
                        $('#searchInput').after('<button type="button" class="clear-search" id="clearSearchBtn" title="Clear search"><i class="fas fa-times"></i></button>');
                        $('#clearSearchBtn').on('click', function() {
                            $('#searchInput').val('');
                            $('#categorySelect').val('');
                            $('#stockStatusSelect').val('');
                            performLiveSearch();
                        });
                    }
                } else {
                    $('#clearSearchBtn').remove();
                }
                
                // Update URL without reloading page
                updateURL();
                
            } else {
                showToast(response.message || 'Search error occurred', 'error');
                $('#productsTableBody').html(`
                    <tr>
                        <td colspan="9" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error: ${response.message || 'Unknown error'}
                        </td>
                    </tr>
                `);
            }
        },
        error: function(xhr, status, error) {
            showToast('Network error. Please try again.', 'error');
            $('#productsTableBody').html(`
                <tr>
                    <td colspan="9" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Network error. Please try again.
                    </td>
                </tr>
            `);
        },
        complete: function() {
            $('#tableLoading').addClass('d-none');
            $('#searchLoading').addClass('d-none');
            isLiveSearching = false;
        }
    });
}

// Debounced search function
function debouncedSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performLiveSearch, 300);
}

// Update URL without reloading
function updateURL() {
    const url = new URL(window.location);
    
    // Update search params
    if (currentSearch) {
        url.searchParams.set('search', currentSearch);
    } else {
        url.searchParams.delete('search');
    }
    
    if (currentCategory) {
        url.searchParams.set('category_id', currentCategory);
    } else {
        url.searchParams.delete('category_id');
    }
    
    if (currentStockStatus) {
        url.searchParams.set('stock_status', currentStockStatus);
    } else {
        url.searchParams.delete('stock_status');
    }
    
    // Remove page parameter for live search
    url.searchParams.delete('page');
    
    // Update URL without reloading
    window.history.replaceState({}, '', url.toString());
}

// Initialize live search
$(document).ready(function() {
    // Set initial values from URL
    currentSearch = $('#searchInput').val();
    currentCategory = $('#categorySelect').val();
    currentStockStatus = $('#stockStatusSelect').val();
    
    // Add live search event listeners
    $('#searchInput').on('input', function() {
        const newSearch = $(this).val();
        if (newSearch !== currentSearch && !isLiveSearching) {
            debouncedSearch();
        }
    });
    
    $('#categorySelect, #stockStatusSelect').on('change', function() {
        const newCategory = $('#categorySelect').val();
        const newStockStatus = $('#stockStatusSelect').val();
        
        if ((newCategory !== currentCategory || newStockStatus !== currentStockStatus) && !isLiveSearching) {
            debouncedSearch();
        }
    });
    
    // Clear search button
    $(document).on('click', '#clearSearchBtn', function() {
        $('#searchInput').val('');
        $('#categorySelect').val('');
        $('#stockStatusSelect').val('');
        performLiveSearch();
    });
    
    // Reset button functionality
    $('#resetBtn').on('click', function() {
        $('#searchInput').val('');
        $('#categorySelect').val('');
        $('#stockStatusSelect').val('');
        performLiveSearch();
    });
    
    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        // Focus search on Ctrl+F or /
        if ((e.ctrlKey && e.key === 'f') || e.key === '/') {
            e.preventDefault();
            $('#searchInput').focus();
        }
        
        // Clear search on Escape
        if (e.key === 'Escape' && $('#searchInput').is(':focus')) {
            e.preventDefault();
            $('#searchInput').val('');
            performLiveSearch();
        }
    });
    
    // Highlight search terms in results
    function highlightText(text, searchTerm) {
        if (!searchTerm) return text;
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    // Initial result count display
    const initialCount = {{ products.total }};
    let initialText = '';
    if (initialCount === 0) {
        initialText = 'No products';
    } else if (initialCount === 1) {
        initialText = '1 product';
    } else {
        initialText = `${initialCount} products`;
    }
    
    if (currentSearch) {
        initialText += ` for "${currentSearch}"`;
    }
    
    $('#resultCount').text(initialText);
});

// Stock Out Modal Functions
function showStockOutModal(productId) {
    // Get product info
    $.get(`/inventory/product/${productId}/info`, function(response) {
        if (response.success) {
            const product = response.product;
            
            $('#stockOutProductId').val(productId);
            $('#stockOutQuantity').attr('max', product.stock_count);
            
            $('#stockOutProductInfo').html(`
                <div class="alert alert-info">
                    <strong>${product.name}</strong><br>
                    <small>SKU: ${product.sku} | Current Stock: ${product.stock_count}</small>
                </div>
            `);
            
            $('#availableStockText').text(`Available stock: ${product.stock_count} units`);
            
            $('#stockOutModal').modal('show');
        }
    });
}

// Stock out form validation
$('#stockOutForm').on('submit', function(e) {
    const quantity = parseInt($('#stockOutQuantity').val());
    const maxQuantity = parseInt($('#stockOutQuantity').attr('max'));
    
    if (quantity > maxQuantity) {
        alert(`Cannot stock out more than ${maxQuantity} units. Available: ${maxQuantity}`);
        e.preventDefault();
        return;
    }
    
    if (quantity <= 0) {
        alert('Please enter a valid quantity');
        e.preventDefault();
        return;
    }
    
    // Show loading
    $('button[type="submit"]').html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');
    $('button[type="submit"]').prop('disabled', true);
});

// Update view toggle buttons to maintain other filters
$(document).ready(function() {
    // Keep all existing filters when switching views
    $('.view-toggle a').each(function() {
        const href = $(this).attr('href');
        const urlParams = new URLSearchParams(window.location.search);
        
        // Remove view parameter from current URL
        urlParams.delete('view');
        
        // Add all other parameters
        urlParams.forEach((value, key) => {
            if (key !== 'view') {
                const newHref = new URL(href, window.location.origin);
                const newParams = new URLSearchParams(newHref.search);
                if (!newParams.has(key)) {
                    newParams.set(key, value);
                    newHref.search = newParams.toString();
                    $(this).attr('href', newHref.toString());
                }
            }
        });
    });
    
    // ============ CATEGORY FORM HANDLING ============
    console.log('Products page loaded. Initializing category functionality...');
    
    // Real-time preview for category form
    $('#categoryName, #categoryDescription').on('input', function() {
        const name = $('#categoryName').val().trim();
        const description = $('#categoryDescription').val().trim();
        
        $('#previewName').text(name || '[Enter name]');
        $('#previewDescription').text(description || '[Optional]');
        
        // Clear validation errors when user types
        if (name) {
            $('#categoryName').removeClass('is-invalid');
            $('#categoryNameError').text('');
        }
    });
    
    // Category form submission - SIMPLE & RELIABLE VERSION
    $('#addCategoryForm').on('submit', function(e) {
        console.log('Category form submission started');
        
        const form = $(this);
        const submitBtn = $('#submitCategoryBtn');
        const originalBtnText = submitBtn.html();
        
        // Get form values
        const name = $('#categoryName').val().trim();
        const description = $('#categoryDescription').val().trim();
        
        console.log('Form data:', { name, description });
        
        // Validation
        if (!name) {
            e.preventDefault();
            $('#categoryName').addClass('is-invalid');
            $('#categoryNameError').text('Category name is required');
            $('#categoryName').focus();
            return false;
        }
        
        // Show loading state
        submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> Adding...');
        submitBtn.prop('disabled', true);
        
        console.log('Form validation passed. Submitting...');
        
        // Allow normal form submission - this is the most reliable
        return true;
    });
    
    // Clear validation when user types in category name
    $('#categoryName').on('input', function() {
        if ($(this).val().trim()) {
            $(this).removeClass('is-invalid');
            $('#categoryNameError').text('');
        }
    });
    
    // Reset form when modal is closed
    $('#addCategoryModal').on('hidden.bs.modal', function () {
        console.log('Category modal closed, resetting form...');
        
        // Reset form
        $('#addCategoryForm')[0].reset();
        
        // Clear validation
        $('#categoryName').removeClass('is-invalid');
        $('#categoryNameError').text('');
        
        // Reset preview
        $('#previewName').text('[Enter name]');
        $('#previewDescription').text('[Optional]');
        
        // Reset button
        $('#submitCategoryBtn').prop('disabled', false).html('<i class="fas fa-plus me-1"></i> Add Category');
    });
    
    // Debug: Log modal events
    $('#addCategoryModal').on('show.bs.modal', function () {
        console.log('Add Category modal opened');
    });
    
    // Debug: Check if CSRF token exists
    const csrfToken = $('input[name="csrf_token"]').val();
    console.log('CSRF token present:', csrfToken ? 'Yes' : 'No');
    console.log('Form action:', $('#addCategoryForm').attr('action'));
    
    // ============ HELPER FUNCTIONS ============
    
    // Function to show toast notifications
    window.showToast = function(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const icon = type === 'success' ? 'check-circle' : 
                    type === 'error' ? 'exclamation-triangle' : 
                    type === 'warning' ? 'exclamation-circle' : 'info-circle';
        
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type} text-white">
                    <i class="fas fa-${icon} me-2"></i>
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        $('#toastContainer').append(toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
        
        // Remove toast from DOM after it hides
        toastElement.addEventListener('hidden.bs.toast', function () {
            $(this).remove();
        });
    };
});
</script>
{% endblock %}