{% extends "base.html" %}

{% block title %}Suppliers - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .supplier-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s;
        height: 100%;
    }
    
    .supplier-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }
    
    .contact-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
    
    .supplier-stats {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-truck me-2"></i>Suppliers</h2>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
            <i class="fas fa-plus me-1"></i> Add Supplier
        </button>
    </div>
</div>

<!-- Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-6">
                <input type="text" name="search" class="form-control" 
                       placeholder="Search by supplier name, contact person, or GST number" 
                       value="{{ request.args.get('search', '') }}">
            </div>
            
            <div class="col-md-4">
                <select name="sort_by" class="form-select">
                    <option value="name" {% if request.args.get('sort_by') == 'name' %}selected{% endif %}>Sort by Name</option>
                    <option value="recent" {% if request.args.get('sort_by') == 'recent' %}selected{% endif %}>Most Recent</option>
                    <option value="orders" {% if request.args.get('sort_by') == 'orders' %}selected{% endif %}>Most Orders</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i> Search
                    </button>
                    <a href="{{ url_for('inventory.supplier_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Suppliers Grid -->
<div class="row">
    {% for supplier in suppliers %}
    <div class="col-md-4 mb-4">
        <div class="card supplier-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">{{ supplier.name }}</h5>
                        {% if supplier.contact_person %}
                        <p class="text-muted small mb-0">
                            <i class="fas fa-user me-1"></i> {{ supplier.contact_person }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">{{ supplier.purchase_orders|length }} orders</span>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div class="mb-3">
                    {% if supplier.phone %}
                    <p class="mb-2">
                        <i class="fas fa-phone me-1 text-muted"></i>
                        <small>{{ supplier.phone }}</small>
                    </p>
                    {% endif %}
                    
                    {% if supplier.email %}
                    <p class="mb-2">
                        <i class="fas fa-envelope me-1 text-muted"></i>
                        <small>{{ supplier.email }}</small>
                    </p>
                    {% endif %}
                    
                    {% if supplier.gst_number %}
                    <p class="mb-3">
                        <i class="fas fa-file-invoice me-1 text-muted"></i>
                        <small>GST: {{ supplier.gst_number }}</small>
                    </p>
                    {% endif %}
                </div>
                
                <!-- Address -->
                {% if supplier.address %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Address:</small>
                    <small class="text-muted">{{ supplier.address|truncate(80) }}</small>
                </div>
                {% endif %}
                
                <!-- Statistics -->
                <div class="supplier-stats">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted d-block">Total Orders</small>
                            <h6 class="mb-0">{{ supplier.purchase_orders|length }}</h6>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted d-block">Total Amount</small>
                            <h6 class="mb-0">Rs.{{ "%.2f"|format(supplier.purchase_orders|sum(attribute='total_amount')) }}</h6>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('inventory.supplier_detail', supplier_id=supplier.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i> View Details
                    </a>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" 
                                onclick="createPurchaseOrder({{ supplier.id }})">
                            <i class="fas fa-file-purchase me-1"></i> New PO
                        </button>
                        <button class="btn btn-outline-warning" 
                                onclick="editSupplier({{ supplier.id }})">
                            <i class="fas fa-edit me-1"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-top-0">
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    Added: {{ supplier.created_at.strftime('%b %d, %Y') }}
                </small>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No suppliers found</h5>
                <p class="text-muted">Try adjusting your search criteria or add your first supplier</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                    <i class="fas fa-plus me-1"></i> Add First Supplier
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Supplier Modal -->
<div class="modal fade" id="addSupplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addSupplierForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier Name *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Person</label>
                            <input type="text" name="contact_person" class="form-control">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">GST Number</label>
                        <input type="text" name="gst_number" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" 
                                  placeholder="Any additional notes about this supplier..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Supplier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Supplier Modal -->
<div class="modal fade" id="editSupplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editSupplierForm">
                <div class="modal-body">
                    <input type="hidden" name="supplier_id" id="editSupplierId">
                    <!-- Form fields same as add modal -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier Name *</label>
                            <input type="text" name="name" id="editName" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Person</label>
                            <input type="text" name="contact_person" id="editContactPerson" class="form-control">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" name="phone" id="editPhone" class="form-control">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" name="email" id="editEmail" class="form-control">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">GST Number</label>
                        <input type="text" name="gst_number" id="editGstNumber" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" id="editAddress" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Supplier</button>
                    <button type="button" class="btn btn-danger" onclick="deleteSupplier()">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Add new supplier
$('#addSupplierForm').on('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: $('input[name="name"]').val(),
        contact_person: $('input[name="contact_person"]').val(),
        phone: $('input[name="phone"]').val(),
        email: $('input[name="email"]').val(),
        gst_number: $('input[name="gst_number"]').val(),
        address: $('textarea[name="address"]').val(),
        notes: $('textarea[name="notes"]').val()
    };
    
    $.ajax({
        url: '/inventory/api/suppliers/add',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#addSupplierModal').modal('hide');
                location.reload();
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('Error adding supplier');
        }
    });
});

// Edit supplier
function editSupplier(supplierId) {
    $.get(`/inventory/api/suppliers/${supplierId}`, function(response) {
        if (response.success) {
            const supplier = response.supplier;
            
            $('#editSupplierId').val(supplier.id);
            $('#editName').val(supplier.name);
            $('#editContactPerson').val(supplier.contact_person || '');
            $('#editPhone').val(supplier.phone || '');
            $('#editEmail').val(supplier.email || '');
            $('#editGstNumber').val(supplier.gst_number || '');
            $('#editAddress').val(supplier.address || '');
            
            $('#editSupplierModal').modal('show');
        }
    });
}

// Update supplier
$('#editSupplierForm').on('submit', function(e) {
    e.preventDefault();
    
    const supplierId = $('#editSupplierId').val();
    const formData = {
        name: $('#editName').val(),
        contact_person: $('#editContactPerson').val(),
        phone: $('#editPhone').val(),
        email: $('#editEmail').val(),
        gst_number: $('#editGstNumber').val(),
        address: $('#editAddress').val()
    };
    
    $.ajax({
        url: `/inventory/api/suppliers/${supplierId}/update`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#editSupplierModal').modal('hide');
                location.reload();
            } else {
                alert(response.message);
            }
        }
    });
});

// Delete supplier
function deleteSupplier() {
    if (!confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) {
        return;
    }
    
    const supplierId = $('#editSupplierId').val();
    
    $.ajax({
        url: `/inventory/api/suppliers/${supplierId}/delete`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                $('#editSupplierModal').modal('hide');
                location.reload();
            } else {
                alert(response.message);
            }
        }
    });
}

// Create purchase order for supplier
function createPurchaseOrder(supplierId) {
    window.location.href = `/inventory/create-purchase-order?supplier_id=${supplierId}`;
}
</script>

<!-- Add these API endpoints to modules/inventory.py -->
<script>
/*
Add these routes to modules/inventory.py:

@inventory_bp.route('/api/suppliers/add', methods=['POST'])
@login_required
def api_add_supplier():
    try:
        data = request.get_json()
        
        supplier = Supplier(
            name=data['name'],
            contact_person=data.get('contact_person'),
            phone=data.get('phone'),
            email=data.get('email'),
            address=data.get('address'),
            gst_number=data.get('gst_number')
        )
        
        db.session.add(supplier)
        db.session.commit()
        
        return jsonify({'success': True, 'supplier_id': supplier.id})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@inventory_bp.route('/api/suppliers/<int:supplier_id>')
@login_required
def api_get_supplier(supplier_id):
    try:
        supplier = Supplier.query.get_or_404(supplier_id)
        
        return jsonify({
            'success': True,
            'supplier': {
                'id': supplier.id,
                'name': supplier.name,
                'contact_person': supplier.contact_person,
                'phone': supplier.phone,
                'email': supplier.email,
                'address': supplier.address,
                'gst_number': supplier.gst_number
            }
        })
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@inventory_bp.route('/api/suppliers/<int:supplier_id>/update', methods=['PUT'])
@login_required
def api_update_supplier(supplier_id):
    try:
        supplier = Supplier.query.get_or_404(supplier_id)
        data = request.get_json()
        
        supplier.name = data['name']
        supplier.contact_person = data.get('contact_person')
        supplier.phone = data.get('phone')
        supplier.email = data.get('email')
        supplier.address = data.get('address')
        supplier.gst_number = data.get('gst_number')
        
        db.session.commit()
        
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@inventory_bp.route('/api/suppliers/<int:supplier_id>/delete', methods=['DELETE'])
@login_required
def api_delete_supplier(supplier_id):
    try:
        supplier = Supplier.query.get_or_404(supplier_id)
        
        # Check if supplier has purchase orders
        if supplier.purchase_orders:
            return jsonify({
                'success': False, 
                'message': 'Cannot delete supplier with existing purchase orders'
            })
        
        db.session.delete(supplier)
        db.session.commit()
        
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})
*/
</script>
{% endblock %}