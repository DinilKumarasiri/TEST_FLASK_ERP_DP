{% extends "base.html" %}

{% block title %}Stock In - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .imei-input-group {
        margin-bottom: 10px;
    }
    
    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
    }
    
    .product-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .batch-info {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .preview-barcode {
        background: white;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px;
        display: inline-block;
        text-align: center;
        border-radius: 4px;
    }
    
    .barcode-preview-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus-circle me-2"></i>Stock In</h2>
    <div>
        <a href="{{ url_for('inventory.product_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Products
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('inventory.stock_in') }}" id="stockInForm">
    {% include 'includes/csrf.html' %}
    
    <!-- Product Selection -->
    <div class="form-section">
        <h5><i class="fas fa-box me-2"></i>Select Product</h5>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Product *</label>
                <select name="product_id" id="productSelect" class="form-select" required>
                    <option value="">-- Select Product --</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-has-imei="{{ product.has_imei }}">
                        {{ product.name }} (SKU: {{ product.sku }})
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">Search or select a product</small>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Quantity *</label>
                <input type="number" name="quantity" id="quantity" class="form-control" 
                       min="1" value="1" required onchange="updateImeiFields(); updateBarcodePreview();">
                <small class="text-muted">Number of items to add</small>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Supplier</label>
                <select name="supplier_id" class="form-select">
                    <option value="">-- Select Supplier --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Optional - supplier for this stock</small>
            </div>
        </div>
        
        <!-- Selected Product Info -->
        <div id="productInfo" class="product-card" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <strong>Product:</strong> <span id="productName"></span><br>
                    <strong>SKU:</strong> <span id="productSKU"></span><br>
                    <strong>Category:</strong> <span id="productCategory"></span>
                </div>
                <div class="col-md-4">
                    <strong>Current Stock:</strong> <span id="currentStock"></span><br>
                    <strong>Min Stock Level:</strong> <span id="minStock"></span><br>
                    <strong>IMEI Tracking:</strong> <span id="hasImei"></span>
                </div>
                <div class="col-md-4">
                    <strong>Purchase Price:</strong> Rs.<span id="purchasePrice"></span><br>
                    <strong>Selling Price:</strong> Rs.<span id="sellingPrice"></span><br>
                    <strong>Wholesale Price:</strong> Rs.<span id="wholesalePrice"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pricing Information -->
    <div class="form-section">
        <h5><i class="fas fa-money-bill-wave me-2"></i>Pricing Information</h5>
        
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Purchase Price (per unit) *</label>
                <div class="input-group">
                    <span class="input-group-text">Rs.</span>
                    <input type="number" name="purchase_price" id="purchasePriceInput" 
                           class="form-control" step="0.01" min="0" required
                           oninput="calculateTotalValue()">
                </div>
                <small class="text-muted">Cost price from supplier</small>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Selling Price (per unit) *</label>
                <div class="input-group">
                    <span class="input-group-text">Rs.</span>
                    <input type="number" name="selling_price" id="sellingPriceInput" 
                           class="form-control" step="0.01" min="0" required>
                </div>
                <small class="text-muted">Retail selling price</small>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Total Value</label>
                <div class="input-group">
                    <span class="input-group-text">Rs.</span>
                    <input type="text" id="totalValue" class="form-control" readonly>
                </div>
                <small class="text-muted">Quantity × Purchase Price</small>
            </div>
        </div>
    </div>
    
    <!-- Barcode Generation -->
    <div class="form-section">
        <h5><i class="fas fa-barcode me-2"></i>Barcode Generation</h5>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="generate_individual_barcodes" 
                               id="generateBarcodes" checked onchange="updateBarcodePreview()">
                        <label class="form-check-label" for="generateBarcodes">
                            <strong>Generate unique barcodes for each item</strong>
                        </label>
                        <small class="text-muted d-block">
                            Each item will get its own unique barcode for individual tracking.
                            Recommended for serialized items like mobile phones.
                        </small>
                    </div>
                </div>
                
                <!-- Barcode Format Options -->
                <div id="barcodeFormatOptions" style="display: none;">
                    <label class="form-label">Barcode Format</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="barcode_format" 
                               id="formatStandard" value="standard" checked>
                        <label class="form-check-label" for="formatStandard">
                            Standard (Product SKU + Sequence)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="barcode_format" 
                               id="formatCustom" value="custom">
                        <label class="form-check-label" for="formatCustom">
                            Custom Prefix
                        </label>
                    </div>
                    
                    <div id="customPrefixDiv" style="display: none; margin-top: 10px;">
                        <input type="text" name="custom_prefix" id="customPrefix" 
                               class="form-control form-control-sm" placeholder="e.g., HUAWEI"
                               oninput="updateBarcodePreview()">
                        <small class="text-muted">Custom prefix for barcodes</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <!-- Barcode Preview -->
                <div id="barcodePreview">
                    <label class="form-label">Generated Barcodes Preview</label>
                    <div id="barcodePreviewContainer" class="barcode-preview-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-barcode fa-2x mb-2"></i>
                            <p>Select a product and quantity to preview barcodes</p>
                        </div>
                    </div>
                    <small class="text-muted">Unique barcodes will be generated for each item</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Batch Information -->
    <div class="form-section">
        <h5><i class="fas fa-layer-group me-2"></i>Batch Information</h5>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Batch/Lot Number</label>
                <input type="text" name="batch_number" class="form-control" 
                       placeholder="Enter batch or lot number">
                <small class="text-muted">Optional - for tracking purposes</small>
            </div>
            
            <div class="col-md-6">
                <label class="form-label">Storage Location</label>
                <input type="text" name="location" class="form-control" 
                       placeholder="e.g., Shelf A1, Warehouse Rack 3">
                <small class="text-muted">Where these items will be stored</small>
            </div>
        </div>
    </div>
    
    <!-- IMEI/Serial Numbers -->
    <div class="form-section" id="imeiSection" style="display: none;">
        <h5><i class="fas fa-hashtag me-2"></i>IMEI/Serial Numbers</h5>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>IMEI Required:</strong> This product requires IMEI/serial numbers for each unit.
            Please enter valid 15-digit IMEI numbers below.
        </div>
        
        <div id="imeiFields">
            <!-- IMEI fields will be dynamically added here -->
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="validateImeiNumbers()">
                <i class="fas fa-check me-1"></i> Validate IMEI Numbers
            </button>
        </div>
    </div>
    
    <!-- Additional Information -->
    <div class="form-section">
        <h5><i class="fas fa-sticky-note me-2"></i>Additional Information</h5>
        
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="3" 
                      placeholder="Any additional notes about this stock entry..."></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Stock In Reason</label>
            <select name="reason" class="form-select">
                <option value="purchase">Purchase from Supplier</option>
                <option value="return">Customer Return</option>
                <option value="transfer">Store Transfer</option>
                <option value="other">Other</option>
            </select>
        </div>
    </div>
    
    <!-- Submit Section -->
    <div class="form-section">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="reset" class="btn btn-outline-secondary me-md-2" onclick="resetForm()">
                <i class="fas fa-redo me-1"></i> Reset Form
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check-circle me-1"></i> Add Stock with Barcodes
            </button>
        </div>
    </div>
</form>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    {% for product in products %}
                    <div class="col-md-6 mb-3">
                        <div class="card product-card" onclick="selectProduct({{ product.id }})" 
                             style="cursor: pointer;">
                            <div class="card-body">
                                <h6 class="card-title">{{ product.name }}</h6>
                                <p class="card-text small mb-1">
                                    <strong>SKU:</strong> {{ product.sku }}<br>
                                    <strong>Category:</strong> {{ product.category.name if product.category else 'N/A' }}<br>
                                    <strong>Current Stock:</strong> 
                                    <span class="badge bg-{{ 'success' if product.stock_count > product.min_stock_level else 'danger' }}">
                                        {{ product.stock_count }}
                                    </span><br>
                                    <strong>Price:</strong> Rs.{{ "%.2f"|format(product.selling_price) }}<br>
                                    <strong>IMEI:</strong> 
                                    <span class="badge bg-{{ 'info' if product.has_imei else 'secondary' }}">
                                        {{ 'Required' if product.has_imei else 'Not Required' }}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedProduct = null;
let generatedBarcodes = [];

// Product selection
$('#productSelect').on('change', function() {
    const productId = $(this).val();
    if (productId) {
        loadProductInfo(productId);
        updateImeiFields();
        updateBarcodePreview();
    } else {
        $('#productInfo').hide();
        $('#imeiSection').hide();
        $('#barcodeFormatOptions').hide();
    }
});

// Load product information
function loadProductInfo(productId) {
    $.get(`/inventory/product/${productId}/info`, function(response) {
        if (response.success) {
            selectedProduct = response.product;
            
            $('#productName').text(selectedProduct.name);
            $('#productSKU').text(selectedProduct.sku);
            $('#productCategory').text(selectedProduct.category_name || 'N/A');
            $('#currentStock').text(selectedProduct.stock_count);
            $('#minStock').text(selectedProduct.min_stock_level);
            $('#hasImei').html(selectedProduct.has_imei ? 
                '<span class="badge bg-info">Yes</span>' : 
                '<span class="badge bg-secondary">No</span>');
            $('#purchasePrice').text(selectedProduct.purchase_price);
            $('#sellingPrice').text(selectedProduct.selling_price);
            $('#wholesalePrice').text(selectedProduct.wholesale_price);
            
            // Set default prices
            $('#purchasePriceInput').val(selectedProduct.purchase_price);
            $('#sellingPriceInput').val(selectedProduct.selling_price);
            
            $('#productInfo').show();
            
            // Show/hide IMEI section
            if (selectedProduct.has_imei) {
                $('#imeiSection').show();
            } else {
                $('#imeiSection').hide();
            }
            
            // Show barcode format options
            $('#barcodeFormatOptions').show();
            
            calculateTotalValue();
        }
    }).fail(function() {
        alert('Error loading product information');
    });
}

// Update IMEI fields based on quantity
function updateImeiFields() {
    const quantity = parseInt($('#quantity').val()) || 1;
    const hasImei = selectedProduct && selectedProduct.has_imei;
    
    if (hasImei) {
        $('#imeiFields').empty();
        
        for (let i = 0; i < quantity; i++) {
            $('#imeiFields').append(`
                <div class="imei-input-group">
                    <div class="input-group">
                        <span class="input-group-text">#${i + 1}</span>
                        <input type="text" name="imei_${i}" class="form-control imei-input" 
                               placeholder="Enter 15-digit IMEI" 
                               pattern="[0-9]{15}" 
                               maxlength="15"
                               required>
                        <button type="button" class="btn btn-outline-secondary" 
                                onclick="generateRandomImei(${i})">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                    <small class="text-muted">15-digit IMEI number for item ${i + 1}</small>
                </div>
            `);
        }
        
        $('#imeiSection').show();
    } else {
        $('#imeiSection').hide();
    }
}

// Generate random IMEI for testing
function generateRandomImei(index) {
    // Generate 15 random digits
    let imei = '';
    for (let i = 0; i < 15; i++) {
        imei += Math.floor(Math.random() * 10);
    }
    $(`input[name="imei_${index}"]`).val(imei);
}

// Validate IMEI numbers
function validateImeiNumbers() {
    const imeiInputs = $('.imei-input');
    let isValid = true;
    let message = '';
    
    imeiInputs.each(function(index) {
        const imei = $(this).val().trim();
        
        if (!imei) {
            message += `IMEI #${index + 1} is empty\n`;
            isValid = false;
        } else if (imei.length !== 15) {
            message += `IMEI #${index + 1} should be 15 digits (currently ${imei.length})\n`;
            isValid = false;
        } else if (!/^\d+$/.test(imei)) {
            message += `IMEI #${index + 1} should contain only digits\n`;
            isValid = false;
        }
    });
    
    if (isValid) {
        alert('✅ All IMEI numbers are valid!');
    } else {
        alert('⚠️ Please fix the following issues:\n\n' + message);
    }
}

// Update barcode preview
function updateBarcodePreview() {
    const generateBarcodes = $('#generateBarcodes').is(':checked');
    const quantity = parseInt($('#quantity').val()) || 1;
    const container = $('#barcodePreviewContainer');
    
    if (!selectedProduct || !generateBarcodes) {
        container.html(`
            <div class="text-center text-muted">
                <i class="fas fa-barcode fa-2x mb-2"></i>
                <p>Individual barcodes will not be generated</p>
            </div>
        `);
        generatedBarcodes = [];
        return;
    }
    
    // Generate preview barcodes
    generatedBarcodes = [];
    const sku = selectedProduct.sku.replace(/[^A-Za-z0-9]/g, '').substring(0, 6);
    const prefix = $('#customPrefix').val() || sku || 'ITEM';
    const format = $('input[name="barcode_format"]:checked').val();
    
    let html = '<div class="row">';
    
    for (let i = 0; i < quantity; i++) {
        let barcodeNumber;
        
        if (format === 'custom' && $('#customPrefix').val()) {
            barcodeNumber = `${prefix}${(i + 1).toString().padStart(4, '0')}`;
        } else {
            // Standard format: Product SKU + timestamp + sequence
            const timestamp = Date.now().toString().slice(-6);
            const seq = (i + 1).toString().padStart(3, '0');
            barcodeNumber = `${sku}${timestamp}${seq}`;
        }
        
        generatedBarcodes.push(barcodeNumber);
        
        // Limit display to 12 barcodes
        if (i < 12) {
            html += `
                <div class="col-md-3 col-6 mb-3">
                    <div class="preview-barcode">
                        <small class="text-muted d-block mb-1">Item ${i + 1}</small>
                        <img src="https://barcode.tec-it.com/barcode.ashx?data=${barcodeNumber}&code=Code128&dpi=60&dataseparator=" 
                             alt="Barcode" 
                             style="width: 100px; height: 30px;">
                        <div class="mt-1">
                            <small class="text-muted">${barcodeNumber.substring(0, 12)}...</small>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    html += '</div>';
    
    // Show message if more than 12 items
    if (quantity > 12) {
        html += `
            <div class="alert alert-info mt-2">
                <i class="fas fa-info-circle me-2"></i>
                Showing first 12 of ${quantity} barcodes. All ${quantity} unique barcodes will be generated.
            </div>
        `;
    }
    
    container.html(html);
}

// Calculate total value
function calculateTotalValue() {
    const quantity = parseInt($('#quantity').val()) || 1;
    const price = parseFloat($('#purchasePriceInput').val()) || 0;
    const total = quantity * price;
    
    $('#totalValue').val(total.toFixed(2));
}

// Quick product selection from modal
function selectProduct(productId) {
    $('#productSelect').val(productId).trigger('change');
    $('#productModal').modal('hide');
}

// Reset form
function resetForm() {
    selectedProduct = null;
    generatedBarcodes = [];
    $('#productInfo').hide();
    $('#imeiSection').hide();
    $('#barcodeFormatOptions').hide();
    $('#barcodePreviewContainer').html(`
        <div class="text-center text-muted">
            <i class="fas fa-barcode fa-2x mb-2"></i>
            <p>Select a product and quantity to preview barcodes</p>
        </div>
    `);
}

// Form validation
$('#stockInForm').on('submit', function(e) {
    e.preventDefault();
    
    // Validate basic fields
    if (!$('#productSelect').val()) {
        alert('Please select a product');
        return;
    }
    
    const quantity = parseInt($('#quantity').val()) || 0;
    if (quantity <= 0) {
        alert('Please enter a valid quantity');
        return;
    }
    
    const purchasePrice = parseFloat($('#purchasePriceInput').val()) || 0;
    if (purchasePrice <= 0) {
        alert('Please enter a valid purchase price');
        return;
    }
    
    const sellingPrice = parseFloat($('#sellingPriceInput').val()) || 0;
    if (sellingPrice <= 0) {
        alert('Please enter a valid selling price');
        return;
    }
    
    // Validate IMEI numbers if required
    if (selectedProduct && selectedProduct.has_imei) {
        const imeiInputs = $('.imei-input');
        
        if (imeiInputs.length !== quantity) {
            alert(`Please enter exactly ${quantity} IMEI/serial numbers`);
            return;
        }
        
        // Check for duplicate IMEIs
        const imeis = [];
        let hasError = false;
        
        imeiInputs.each(function() {
            const imei = $(this).val().trim();
            if (imei) {
                if (imeis.includes(imei)) {
                    alert('Duplicate IMEI/serial numbers found. Each unit must have a unique IMEI.');
                    hasError = true;
                    return false;
                }
                imeis.push(imei);
                
                // IMEI validation
                if (imei.length !== 15) {
                    alert(`IMEI should be 15 digits. Found: ${imei.length} digits.`);
                    hasError = true;
                    return false;
                }
            } else {
                alert('Please enter IMEI for all items');
                hasError = true;
                return false;
            }
        });
        
        if (hasError) return;
    }
    
    // Show loading
    const submitBtn = $(this).find('button[type="submit"]');
    const originalText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> Adding Stock...');
    submitBtn.prop('disabled', true);
    
    // Submit form
    this.submit();
});

// Show/hide custom prefix input
$('input[name="barcode_format"]').on('change', function() {
    if ($(this).val() === 'custom') {
        $('#customPrefixDiv').show();
    } else {
        $('#customPrefixDiv').hide();
    }
    updateBarcodePreview();
});

// Event listeners for calculations
$('#quantity, #purchasePriceInput').on('input', function() {
    calculateTotalValue();
    if ($(this).attr('id') === 'quantity') {
        updateImeiFields();
        updateBarcodePreview();
    }
});

// Auto-generate selling price based on purchase price
$('#purchasePriceInput').on('blur', function() {
    const purchasePrice = parseFloat($(this).val()) || 0;
    const sellingPriceInput = $('#sellingPriceInput');
    
    if (purchasePrice > 0 && (sellingPriceInput.val() === '' || parseFloat(sellingPriceInput.val()) === 0)) {
        // Add 20% markup as default
        const suggestedPrice = purchasePrice * 1.2;
        sellingPriceInput.val(suggestedPrice.toFixed(2));
    }
});

// Initialize
$(document).ready(function() {
    // Set default barcode format to show
    $('#barcodeFormatOptions').hide();
    
    // Auto-preview barcodes when custom prefix changes
    $('#customPrefix').on('input', function() {
        updateBarcodePreview();
    });
});
</script>
{% endblock %}