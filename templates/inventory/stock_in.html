{% extends "base.html" %}

{% block title %}Stock In - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .imei-input-group {
        margin-bottom: 10px;
    }
    
    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
    }
    
    .product-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .batch-info {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus-circle me-2"></i>Stock In</h2>
    <div>
        <a href="{{ url_for('inventory.product_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Products
        </a>
    </div>
</div>

<!-- ADD CSRF TOKEN HERE -->
<form method="POST" action="{{ url_for('inventory.stock_in') }}" id="stockInForm">
    {{ csrf_token() }}
    {% include 'includes/csrf.html' %}
    
    <!-- Product Selection -->
    <div class="form-section">
        <h5><i class="fas fa-box me-2"></i>Select Product</h5>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Product *</label>
                <select name="product_id" id="productSelect" class="form-select" required>
                    <option value="">-- Select Product --</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-has-imei="{{ product.has_imei }}">
                        {{ product.name }} (SKU: {{ product.sku }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Quantity *</label>
                <input type="number" name="quantity" id="quantity" class="form-control" 
                       min="1" value="1" required onchange="updateImeiFields()">
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Supplier</label>
                <select name="supplier_id" class="form-select">
                    <option value="">-- Select Supplier --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Selected Product Info -->
        <div id="productInfo" class="product-card" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <strong>Product:</strong> <span id="productName"></span><br>
                    <strong>SKU:</strong> <span id="productSKU"></span><br>
                    <strong>Category:</strong> <span id="productCategory"></span>
                </div>
                <div class="col-md-4">
                    <strong>Current Stock:</strong> <span id="currentStock"></span><br>
                    <strong>Min Stock Level:</strong> <span id="minStock"></span><br>
                    <strong>Has IMEI:</strong> <span id="hasImei"></span>
                </div>
                <div class="col-md-4">
                    <strong>Purchase Price:</strong> ₹<span id="purchasePrice"></span><br>
                    <strong>Selling Price:</strong> ₹<span id="sellingPrice"></span><br>
                    <strong>Wholesale Price:</strong> ₹<span id="wholesalePrice"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pricing Information -->
    <div class="form-section">
        <h5><i class="fas fa-money-bill-wave me-2"></i>Pricing Information</h5>
        
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Purchase Price (per unit) *</label>
                <div class="input-group">
                    <span class="input-group-text">₹</span>
                    <input type="number" name="purchase_price" id="purchasePriceInput" 
                           class="form-control" step="0.01" min="0" required>
                </div>
                <small class="text-muted">Cost price of the product</small>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Selling Price (per unit) *</label>
                <div class="input-group">
                    <span class="input-group-text">₹</span>
                    <input type="number" name="selling_price" id="sellingPriceInput" 
                           class="form-control" step="0.01" min="0" required>
                </div>
                <small class="text-muted">Retail selling price</small>
            </div>
            
            <div class="col-md-4">
                <label class="form-label">Total Value</label>
                <div class="input-group">
                    <span class="input-group-text">₹</span>
                    <input type="text" id="totalValue" class="form-control" readonly>
                </div>
                <small class="text-muted">Quantity × Purchase Price</small>
            </div>
        </div>
    </div>
    
    <!-- Batch Information -->
    <div class="form-section">
        <h5><i class="fas fa-layer-group me-2"></i>Batch Information</h5>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Batch/Lot Number</label>
                <input type="text" name="batch_number" class="form-control" 
                       placeholder="Enter batch or lot number">
                <small class="text-muted">Optional - for tracking purposes</small>
            </div>
            
            <div class="col-md-6">
                <label class="form-label">Storage Location</label>
                <input type="text" name="location" class="form-control" 
                       placeholder="e.g., Shelf A1, Warehouse Rack 3">
                <small class="text-muted">Where these items will be stored</small>
            </div>
        </div>
    </div>
    
    <!-- IMEI/Serial Numbers -->
    <div class="form-section" id="imeiSection" style="display: none;">
        <h5><i class="fas fa-hashtag me-2"></i>IMEI/Serial Numbers</h5>
        <p class="text-muted">Enter IMEI or serial numbers for each unit ({{ quantity }} required)</p>
        
        <div id="imeiFields">
            <!-- IMEI fields will be dynamically added here -->
        </div>
    </div>
    
    <!-- Additional Information -->
    <div class="form-section">
        <h5><i class="fas fa-sticky-note me-2"></i>Additional Information</h5>
        
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="3" 
                      placeholder="Any additional notes about this stock entry..."></textarea>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Stock In Reason</label>
            <select name="reason" class="form-select">
                <option value="purchase">Purchase from Supplier</option>
                <option value="return">Customer Return</option>
                <option value="transfer">Store Transfer</option>
                <option value="other">Other</option>
            </select>
        </div>
    </div>
    
    <!-- Submit Section -->
    <div class="form-section">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="reset" class="btn btn-outline-secondary me-md-2">
                <i class="fas fa-redo me-1"></i> Reset Form
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check-circle me-1"></i> Add Stock
            </button>
        </div>
    </div>
</form>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    {% for product in products %}
                    <div class="col-md-6 mb-3">
                        <div class="card product-card" onclick="selectProduct({{ product.id }})" 
                             style="cursor: pointer;">
                            <div class="card-body">
                                <h6 class="card-title">{{ product.name }}</h6>
                                <p class="card-text small mb-1">
                                    <strong>SKU:</strong> {{ product.sku }}<br>
                                    <strong>Category:</strong> {{ product.category.name if product.category else 'N/A' }}<br>
                                    <strong>Current Stock:</strong> 
                                    {% set stock_count = stock_items|selectattr('product_id', 'equalto', product.id)|selectattr('status', 'equalto', 'available')|list|length %}
                                    <span class="badge bg-{{ 'danger' if stock_count <= product.min_stock_level else 'success' }}">
                                        {{ stock_count }}
                                    </span><br>
                                    <strong>Price:</strong> ₹{{ "%.2f"|format(product.selling_price) }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedProduct = null;

// Product selection
$('#productSelect').on('change', function() {
    const productId = $(this).val();
    if (productId) {
        loadProductInfo(productId);
        updateImeiFields();
    } else {
        $('#productInfo').hide();
        $('#imeiSection').hide();
    }
});

// Load product information
function loadProductInfo(productId) {
    $.get(`/inventory/product/${productId}/info`, function(response) {
        if (response.success) {
            selectedProduct = response.product;
            
            $('#productName').text(selectedProduct.name);
            $('#productSKU').text(selectedProduct.sku);
            $('#productCategory').text(selectedProduct.category_name || 'N/A');
            $('#currentStock').text(selectedProduct.stock_count);
            $('#minStock').text(selectedProduct.min_stock_level);
            $('#hasImei').text(selectedProduct.has_imei ? 'Yes' : 'No');
            $('#purchasePrice').text(selectedProduct.purchase_price);
            $('#sellingPrice').text(selectedProduct.selling_price);
            $('#wholesalePrice').text(selectedProduct.wholesale_price);
            
            // Set default prices
            $('#purchasePriceInput').val(selectedProduct.purchase_price);
            $('#sellingPriceInput').val(selectedProduct.selling_price);
            
            $('#productInfo').show();
            
            // Show/hide IMEI section
            if (selectedProduct.has_imei) {
                $('#imeiSection').show();
            } else {
                $('#imeiSection').hide();
            }
            
            calculateTotalValue();
        }
    }).fail(function() {
        alert('Error loading product information');
    });
}

// Update IMEI fields based on quantity
function updateImeiFields() {
    const quantity = parseInt($('#quantity').val()) || 1;
    const hasImei = selectedProduct && selectedProduct.has_imei;
    
    if (hasImei) {
        $('#imeiFields').empty();
        
        for (let i = 0; i < quantity; i++) {
            $('#imeiFields').append(`
                <div class="imei-input-group">
                    <label class="form-label">IMEI/Serial #${i + 1} *</label>
                    <input type="text" name="imei_${i}" class="form-control imei-input" 
                           placeholder="Enter 15-digit IMEI or serial number" required>
                </div>
            `);
        }
        
        $('#imeiSection').show();
    } else {
        $('#imeiSection').hide();
    }
}

// Calculate total value
function calculateTotalValue() {
    const quantity = parseInt($('#quantity').val()) || 1;
    const price = parseFloat($('#purchasePriceInput').val()) || 0;
    const total = quantity * price;
    
    $('#totalValue').val(total.toFixed(2));
}

// Event listeners for calculations
$('#quantity, #purchasePriceInput').on('input', calculateTotalValue);

// Quick product selection from modal
function selectProduct(productId) {
    $('#productSelect').val(productId).trigger('change');
    $('#productModal').modal('hide');
}

// Form validation
$('#stockInForm').on('submit', function(e) {
    // Validate IMEI numbers if required
    if (selectedProduct && selectedProduct.has_imei) {
        const imeiInputs = $('.imei-input');
        const quantity = parseInt($('#quantity').val()) || 1;
        
        if (imeiInputs.length !== quantity) {
            alert(`Please enter exactly ${quantity} IMEI/serial numbers`);
            e.preventDefault();
            return;
        }
        
        // Check for duplicate IMEIs
        const imeis = [];
        imeiInputs.each(function() {
            const imei = $(this).val().trim();
            if (imei) {
                if (imeis.includes(imei)) {
                    alert('Duplicate IMEI/serial numbers found. Each unit must have a unique IMEI.');
                    e.preventDefault();
                    return false;
                }
                imeis.push(imei);
                
                // Basic IMEI validation (15 digits for mobile phones)
                if (imei.length !== 15 && imei.length !== 0) {
                    alert(`IMEI #${imeis.length} should be 15 digits. Current: ${imei.length} digits.`);
                    e.preventDefault();
                    return false;
                }
            }
        });
    }
    
    // Show loading
    $('button[type="submit"]').html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');
    $('button[type="submit"]').prop('disabled', true);
});

// Add product info API endpoint if not exists
if (!window.productInfoEndpoint) {
    // This would be implemented in the backend
    console.log('Product info endpoint not defined');
}
</script>

<!-- Add this to your modules/inventory.py for the product info endpoint -->
<script>
// Add this route to modules/inventory.py:
/*
@inventory_bp.route('/product/<int:product_id>/info')
@login_required
def product_info(product_id):
    try:
        product = Product.query.get_or_404(product_id)
        
        # Get current stock count
        stock_count = StockItem.query.filter_by(
            product_id=product.id,
            status='available'
        ).count()
        
        return jsonify({
            'success': True,
            'product': {
                'id': product.id,
                'name': product.name,
                'sku': product.sku,
                'category_name': product.category.name if product.category else None,
                'stock_count': stock_count,
                'min_stock_level': product.min_stock_level,
                'has_imei': product.has_imei,
                'purchase_price': float(product.purchase_price),
                'selling_price': float(product.selling_price),
                'wholesale_price': float(product.wholesale_price)
            }
        })
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})
*/
</script>
{% endblock %}