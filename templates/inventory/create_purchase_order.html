{% extends "base.html" %}

{% block title %}Create Purchase Order - Mobile Shop ERP{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-section h5 {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .item-row {
        background: white;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }
    
    .total-row {
        background: #e7f3ff;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-purchase me-2"></i>Create Purchase Order</h2>
    <div>
        <a href="{{ url_for('inventory.purchase_order_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to POs
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('inventory.create_purchase_order') }}" id="poForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- Supplier Information -->
    <div class="form-section">
        <h5><i class="fas fa-truck me-2"></i>Supplier Information</h5>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Supplier *</label>
                <select name="supplier_id" class="form-select" required id="supplierSelect">
                    <option value="">-- Select Supplier --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if request.args.get('supplier_id')|int == supplier.id %}selected{% endif %}>
                        {{ supplier.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">Expected Delivery Date</label>
                <input type="date" name="expected_date" class="form-control" 
                       min="{{ now.strftime('%Y-%m-%d') }}" 
                       value="{{ (now + timedelta(days=7)).strftime('%Y-%m-%d') }}">
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2" 
                      placeholder="Any special instructions or notes..."></textarea>
        </div>
        
        <!-- Selected Supplier Info -->
        <div id="supplierInfo" class="card bg-light mt-3" style="display: none;">
            <div class="card-body">
                <h6>Supplier Details:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1" id="supplierContact"></p>
                        <p class="mb-1" id="supplierPhone"></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1" id="supplierEmail"></p>
                        <p class="mb-0" id="supplierAddress"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Items -->
    <div class="form-section">
        <h5><i class="fas fa-boxes me-2"></i>Order Items</h5>
        
        <div id="itemsContainer">
            <!-- Items will be added here dynamically -->
        </div>
        
        <div class="text-center mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="addItem()">
                <i class="fas fa-plus me-1"></i> Add Item
            </button>
        </div>
        
        <!-- Totals -->
        <div class="row justify-content-end">
            <div class="col-md-6">
                <table class="table table-bordered">
                    <tr>
                        <td><strong>Subtotal</strong></td>
                        <td class="text-end" id="subtotal">₹0.00</td>
                    </tr>
                    <tr class="table-active">
                        <td><strong>Total Amount</strong></td>
                        <td class="text-end"><strong id="totalAmount">₹0.00</strong></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <input type="hidden" name="item_count" id="itemCount" value="0">
    </div>
    
    <!-- Submit -->
    <div class="form-section">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="reset" class="btn btn-outline-secondary me-md-2">
                <i class="fas fa-redo me-1"></i> Reset Form
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check-circle me-1"></i> Create Purchase Order
            </button>
        </div>
    </div>
</form>

<!-- Product Search Modal -->
<div class="modal fade" id="productSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="productSearch" 
                           placeholder="Search by product name, SKU...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Current Stock</th>
                                <th>Purchase Price</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="productResults">
                            {% for product in products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.sku }}</td>
                                <td>
                                    {% set stock_count = product.stock_items|selectattr('status', 'equalto', 'available')|list|length %}
                                    <span class="badge bg-{{ 'success' if stock_count > product.min_stock_level else 'danger' }}">
                                        {{ stock_count }}
                                    </span>
                                </td>
                                <td>₹{{ "%.2f"|format(product.purchase_price) }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectProduct({{ product.id }}, '{{ product.name|replace("\'", "\\\'") }}', '{{ product.sku }}', {{ product.purchase_price }})">
                                        Select
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let itemCount = 0;
let currentItemIndex = null;

// Set supplier from URL parameter if present
document.addEventListener('DOMContentLoaded', function() {
    // Check for supplier_id in URL
    const urlParams = new URLSearchParams(window.location.search);
    const supplierId = urlParams.get('supplier_id');
    
    if (supplierId) {
        document.getElementById('supplierSelect').value = supplierId;
        // Trigger change event to show supplier info
        const event = new Event('change');
        document.getElementById('supplierSelect').dispatchEvent(event);
    }
    
    // Initialize with one item
    addItem();
    
    // Initialize product search
    initializeProductSearch();
});

// Supplier info
document.getElementById('supplierSelect').addEventListener('change', function() {
    const supplierId = this.value;
    const supplierInfo = document.getElementById('supplierInfo');
    
    if (supplierId) {
        // Show supplier info (you can fetch via AJAX if needed)
        supplierInfo.style.display = 'block';
        
        // Get selected supplier text
        const supplierSelect = document.getElementById('supplierSelect');
        const selectedOption = supplierSelect.options[supplierSelect.selectedIndex];
        
        // For now, show basic info - you can replace with AJAX call
        document.getElementById('supplierContact').innerHTML = `<strong>Supplier:</strong> ${selectedOption.text}`;
        document.getElementById('supplierPhone').innerHTML = '<strong>Phone:</strong> (Select supplier for details)';
        document.getElementById('supplierEmail').innerHTML = '<strong>Email:</strong> (Select supplier for details)';
        document.getElementById('supplierAddress').innerHTML = '<strong>Address:</strong> (Select supplier for details)';
        
        // Optional: Fetch supplier details via AJAX
        // fetch(`/inventory/api/suppliers/${supplierId}`)
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.success) {
        //             const supplier = data.supplier;
        //             // Update supplier info
        //         }
        //     });
    } else {
        supplierInfo.style.display = 'none';
    }
});

// Add item row
function addItem() {
    itemCount++;
    currentItemIndex = itemCount - 1;
    
    const container = document.getElementById('itemsContainer');
    const itemRow = document.createElement('div');
    itemRow.className = 'item-row';
    itemRow.id = `item-${currentItemIndex}`;
    itemRow.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Product *</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="productName-${currentItemIndex}" 
                               placeholder="Search product..." readonly required>
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="openProductSearch(${currentItemIndex})">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <input type="hidden" name="items[${currentItemIndex}][product_id]" 
                           id="productId-${currentItemIndex}">
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label class="form-label">Quantity *</label>
                    <input type="number" name="items[${currentItemIndex}][quantity]" 
                           class="form-control" min="1" value="1" required 
                           onchange="calculateItemTotal(${currentItemIndex})">
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label class="form-label">Unit Price *</label>
                    <input type="number" name="items[${currentItemIndex}][unit_price]" 
                           class="form-control" step="0.01" min="0" value="0" required 
                           onchange="calculateItemTotal(${currentItemIndex})">
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label class="form-label">Total</label>
                    <input type="text" class="form-control" id="itemTotal-${currentItemIndex}" 
                           value="₹0.00" readonly>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger" 
                    onclick="removeItem(${currentItemIndex})">
                <i class="fas fa-times me-1"></i> Remove
            </button>
        </div>
    `;
    
    container.appendChild(itemRow);
    document.getElementById('itemCount').value = itemCount;
}

// Remove item
function removeItem(index) {
    const item = document.getElementById(`item-${index}`);
    item.remove();
    itemCount--;
    document.getElementById('itemCount').value = itemCount;
    calculateTotals();
}

// Open product search modal
function openProductSearch(itemIndex) {
    currentItemIndex = itemIndex;
    $('#productSearchModal').modal('show');
    
    // Clear search
    document.getElementById('productSearch').value = '';
    
    // Show all products
    const rows = document.querySelectorAll('#productResults tr');
    rows.forEach(row => row.style.display = '');
}

// Select product from search
function selectProduct(productId, productName, sku, purchasePrice) {
    // Escape HTML in product name
    const safeProductName = productName
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    
    document.getElementById(`productId-${currentItemIndex}`).value = productId;
    document.getElementById(`productName-${currentItemIndex}`).value = safeProductName + ' (' + sku + ')';
    
    // Set unit price
    const unitPriceInput = document.getElementsByName(`items[${currentItemIndex}][unit_price]`)[0];
    unitPriceInput.value = parseFloat(purchasePrice).toFixed(2);
    
    // Trigger change to calculate total
    const changeEvent = new Event('change', { bubbles: true });
    unitPriceInput.dispatchEvent(changeEvent);
    
    $('#productSearchModal').modal('hide');
}

// Calculate item total
function calculateItemTotal(index) {
    const quantity = document.getElementsByName(`items[${index}][quantity]`)[0].value || 0;
    const unitPrice = document.getElementsByName(`items[${index}][unit_price]`)[0].value || 0;
    const total = quantity * unitPrice;
    
    document.getElementById(`itemTotal-${index}`).value = '₹' + total.toFixed(2);
    calculateTotals();
}

// Calculate all totals
function calculateTotals() {
    let subtotal = 0;
    
    for (let i = 0; i < itemCount; i++) {
        const itemRow = document.getElementById(`item-${i}`);
        if (itemRow) {
            const quantity = document.getElementsByName(`items[${i}][quantity]`)[0]?.value || 0;
            const unitPrice = document.getElementsByName(`items[${i}][unit_price]`)[0]?.value || 0;
            subtotal += quantity * unitPrice;
        }
    }
    
    document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
    document.getElementById('totalAmount').textContent = '₹' + subtotal.toFixed(2);
}

// Initialize product search functionality
function initializeProductSearch() {
    const searchInput = document.getElementById('productSearch');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#productResults tr');
            
            rows.forEach(row => {
                const productName = row.cells[0].textContent.toLowerCase();
                const sku = row.cells[1].textContent.toLowerCase();
                
                if (searchTerm === '' || productName.includes(searchTerm) || sku.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
}

// Form validation
document.getElementById('poForm').addEventListener('submit', function(e) {
    if (itemCount === 0) {
        e.preventDefault();
        alert('Please add at least one item to the purchase order.');
        return;
    }
    
    // Validate all items have product selected
    let hasErrors = false;
    for (let i = 0; i < itemCount; i++) {
        const itemRow = document.getElementById(`item-${i}`);
        if (itemRow) {
            const productId = document.getElementById(`productId-${i}`).value;
            const quantity = document.getElementsByName(`items[${i}][quantity]`)[0].value;
            const unitPrice = document.getElementsByName(`items[${i}][unit_price]`)[0].value;
            
            if (!productId) {
                alert(`Please select a product for item ${i + 1}.`);
                hasErrors = true;
                break;
            }
            
            if (!quantity || quantity <= 0) {
                alert(`Please enter a valid quantity for item ${i + 1}.`);
                hasErrors = true;
                break;
            }
            
            if (!unitPrice || unitPrice <= 0) {
                alert(`Please enter a valid unit price for item ${i + 1}.`);
                hasErrors = true;
                break;
            }
        }
    }
    
    if (hasErrors) {
        e.preventDefault();
        return;
    }
    
    // Validate supplier
    const supplierId = document.getElementById('supplierSelect').value;
    if (!supplierId) {
        e.preventDefault();
        alert('Please select a supplier.');
        return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Creating...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}